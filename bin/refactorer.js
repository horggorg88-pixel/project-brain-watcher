#!/usr/bin/env node
import{relative as re,basename as Qe}from"node:path";import{resolve as se}from"node:path";import{existsSync as ne}from"node:fs";var ie=[".ts",".tsx"],b={maxLines:200,maxSymbols:15,maxResponsibilities:3,minGodScore:.35,criticalThreshold:.7,warningThreshold:.5};function z(l){let e=l.slice(2),o={};for(let t=0;t<e.length;t++){let r=e[t]??"";if(r.startsWith("--")){let s=r.slice(2),n=e[t+1];n&&!n.startsWith("--")?(o[s]=n,t++):o[s]="true"}}return{path:o.path??process.cwd(),dryRun:o["dry-run"]==="true"||o.dryRun==="true",verbose:o.verbose==="true"||o.v==="true",autoApprove:o["auto-approve"]==="true"||o.yes==="true",maxLines:parseInt(o["max-lines"]??String(b.maxLines),10),maxSymbols:parseInt(o["max-symbols"]??String(b.maxSymbols),10),minScore:parseFloat(o["min-score"]??String(b.minGodScore)),extensions:o.exts?o.exts.split(","):[...ie],analyzeOnly:o["analyze-only"]==="true"||o.analyze==="true",target:o.target??null}}function U(l){let e=se(l.path);if(!ne(e))throw new Error(`\u041F\u0443\u0442\u044C \u043D\u0435 \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u0435\u0442: ${e}`);return{projectRoot:e,extensions:l.extensions,thresholds:{maxLines:l.maxLines,maxSymbols:l.maxSymbols,maxResponsibilities:b.maxResponsibilities,minGodScore:l.minScore,criticalThreshold:b.criticalThreshold,warningThreshold:b.warningThreshold},dryRun:l.dryRun,autoApprove:l.autoApprove,verbose:l.verbose,target:l.target}}function W(){let o="\u2500".repeat(62),t=`  \u250C${o}\u2510`,r=`  \u2514${o}\u2518`,s=i=>{let a=Math.max(60-i.length,0);return`  \u2502  ${i}${" ".repeat(a)}\u2502`},n=`  \u2502  ${"\u2500".repeat(60)}\u2502`;console.log(""),console.log(t),console.log(s("\u{1F527} SOLID Refactorer  v1.0.0")),console.log(s("\u042D\u0442\u0430\u043B\u043E\u043D\u043D\u044B\u0439 \u0440\u0435\u0444\u0430\u043A\u0442\u043E\u0440\u0438\u043D\u0433 \u043F\u043E SOLID")),console.log(r),console.log(""),console.log(t),console.log(s("\u{1F4D6}  \u0418\u0421\u041F\u041E\u041B\u042C\u0417\u041E\u0412\u0410\u041D\u0418\u0415")),console.log(n),console.log(s("npx tsx solid-refactor/cli.ts [\u043E\u043F\u0446\u0438\u0438]")),console.log(s("")),console.log(s("\u041E\u041F\u0426\u0418\u0418:")),console.log(s("  --path <\u043F\u0443\u0442\u044C>        \u041F\u0443\u0442\u044C \u043A \u043F\u0440\u043E\u0435\u043A\u0442\u0443 (\u043F\u043E \u0443\u043C\u043E\u043B\u0447\u0430\u043D\u0438\u044E: cwd)")),console.log(s("  --analyze-only       \u041F\u043E\u043A\u0430\u0437\u0430\u0442\u044C god-\u0444\u0430\u0439\u043B\u044B")),console.log(s("  --dry-run            \u0410\u043D\u0430\u043B\u0438\u0437 + \u043F\u043B\u0430\u043D, \u0431\u0435\u0437 \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u0439")),console.log(s("  --target <\u0444\u0430\u0439\u043B>      \u0420\u0435\u0444\u0430\u043A\u0442\u043E\u0440\u0438\u0442\u044C \u043A\u043E\u043D\u043A\u0440\u0435\u0442\u043D\u044B\u0439 \u0444\u0430\u0439\u043B")),console.log(s("  --verbose            \u041F\u043E\u0434\u0440\u043E\u0431\u043D\u044B\u0439 \u0432\u044B\u0432\u043E\u0434")),console.log(s("  --auto-approve       \u0411\u0435\u0437 \u043F\u043E\u0434\u0442\u0432\u0435\u0440\u0436\u0434\u0435\u043D\u0438\u0439")),console.log(s("  --max-lines <N>      \u041F\u043E\u0440\u043E\u0433 \u0441\u0442\u0440\u043E\u043A (\u043F\u043E \u0443\u043C\u043E\u043B\u0447\u0430\u043D\u0438\u044E: 200)")),console.log(s("  --max-symbols <N>    \u041F\u043E\u0440\u043E\u0433 \u0441\u0438\u043C\u0432\u043E\u043B\u043E\u0432 (\u043F\u043E \u0443\u043C\u043E\u043B\u0447\u0430\u043D\u0438\u044E: 15)")),console.log(s("  --min-score <N>      \u041C\u0438\u043D. score (\u043F\u043E \u0443\u043C\u043E\u043B\u0447\u0430\u043D\u0438\u044E: 0.35)")),console.log(s("  --exts <ext1,ext2>   \u0420\u0430\u0441\u0448\u0438\u0440\u0435\u043D\u0438\u044F (\u043F\u043E \u0443\u043C\u043E\u043B\u0447\u0430\u043D\u0438\u044E: .ts,.tsx)")),console.log(n),console.log(s("\u041F\u0420\u0418\u041C\u0415\u0420\u042B:")),console.log(s("  --path ./src --analyze-only")),console.log(s("  --path ./src --dry-run --verbose")),console.log(s("  --path ./src --target index.ts --auto-approve")),console.log(r),console.log("")}var h={r:"\x1B[0m",b:"\x1B[1m",d:"\x1B[2m",red:"\x1B[31m",grn:"\x1B[32m",ylw:"\x1B[33m",blu:"\x1B[34m",mag:"\x1B[35m",cyn:"\x1B[36m",gry:"\x1B[90m"},x=62,I="  ",v=class{verbose;t0=Date.now();constructor(e=!1){this.verbose=e}info(e){this.tsLine("\xB7",e)}warn(e){this.tsLine(`${h.ylw}\u26A0${h.r}`,e)}error(e){this.tsLine(`${h.red}\u2716${h.r}`,`${h.red}${e}${h.r}`)}debug(e){this.verbose&&this.tsLine(`${h.gry}\xB7${h.r}`,`${h.gry}${e}${h.r}`)}success(e){this.tsLine(`${h.grn}\u2713${h.r}`,`${h.grn}${e}${h.r}`)}phase(e,o,t){let r=`${e}/${o}  ${t} `,s=Math.max(x-r.length-2,4);console.log(""),console.log(`${I} ${h.b}${r}${"\u2500".repeat(s)}${h.r}`)}progress(e,o,t){let r=Math.round(e/Math.max(o,1)*100),s=28,n=Math.round(s*r/100),i="\u2588".repeat(n)+"\u2591".repeat(s-n);process.stdout.write(`\r${I}${i} ${r}%  ${e}/${o}  ${t}  `),e>=o&&process.stdout.write(`
`)}boxTop(){console.log(`${I}\u250C${"\u2500".repeat(x)}\u2510`)}boxBot(){console.log(`${I}\u2514${"\u2500".repeat(x)}\u2518`)}boxLine(e){let o=this.strip(e),t=Math.max(x-2-o.length,0);console.log(`${I}\u2502  ${e}${" ".repeat(t)}\u2502`)}boxDiv(){console.log(`${I}\u2502  ${"\u2500".repeat(x-2)}\u2502`)}boxEmpty(){console.log(`${I}\u2502${" ".repeat(x)}\u2502`)}elapsed(){let e=Date.now()-this.t0;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(1)}s`}resetTimer(){this.t0=Date.now()}tsLine(e,o){let t=this.timestamp();console.log(`${I}${h.gry}${t}${h.r}  ${e}  ${o}`)}timestamp(){let e=new Date,o=String(e.getHours()).padStart(2,"0"),t=String(e.getMinutes()).padStart(2,"0"),r=String(e.getSeconds()).padStart(2,"0");return`${o}:${t}:${r}`}strip(e){return e.replace(/\x1b\[[0-9;]*m/g,"")}};import{readFileSync as V,readdirSync as ae}from"node:fs";import{join as le,extname as ce}from"node:path";import{createHash as pe}from"node:crypto";var de=/^[ \t]*import\s+(type\s+)?(?:\{([^}]*)\}|(\w+)(?:\s*,\s*\{([^}]*)\})?)\s+from\s+['"]([^'"]+)['"]/gm;var me=/^[ \t]*(export\s+)?(async\s+)?function\s+(\w+)\s*(?:<[^>]*>)?\s*\(([^)]*)\)(?:\s*:\s*([^\s{]+(?:\s*\|\s*[^\s{]+)*))?\s*\{/gm,ge=/^[ \t]*(export\s+)?(const|let)\s+(\w+)\s*(?::\s*[^=]+)?\s*=\s*(async\s+)?\([^)]*\)\s*(?::\s*[^=]+)?\s*=>/gm,fe=/^[ \t]*(export\s+)?(abstract\s+)?class\s+(\w+)(?:\s+extends\s+\w+)?(?:\s+implements\s+[\w,\s]+)?\s*\{/gm,ue=/^[ \t]*(export\s+)?interface\s+(\w+)(?:\s+extends\s+[\w,\s]+)?\s*\{/gm,he=/^[ \t]*(export\s+)?type\s+(\w+)(?:<[^>]*>)?\s*=/gm,ye=/^[ \t]*(export\s+)?(const|let|var)\s+(\w+)\s*(?::\s*[^=]+)?\s*=/gm,R=class{logger;constructor(e){this.logger=e}analyzeFile(e){let o=V(e,"utf-8"),t=o.split(`
`),r=pe("md5").update(o).digest("hex"),s=this.extractSymbolsWithBodies(o,t),n=this.extractImports(o),i=this.extractExports(o,s);return{filePath:e,lineCount:t.length,symbolCount:s.length,symbols:s,imports:n,exports:i,fileHash:r}}analyzeProject(e,o){let t=this.collectFiles(e,o),r=[];for(let s of t)try{r.push(this.analyzeFile(s))}catch(n){this.logger.warn(`\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0440\u043E\u0430\u043D\u0430\u043B\u0438\u0437\u0438\u0440\u043E\u0432\u0430\u0442\u044C: ${s} \u2014 ${String(n)}`)}return r}getSymbolsWithBodies(e){let o=V(e,"utf-8");return this.extractSymbolsWithBodies(o,o.split(`
`))}extractSymbolsWithBodies(e,o){let t=[],r=new Set,s=new Set;for(let n of e.matchAll(new RegExp(ge.source,"gm"))){let i=this.getLineAt(e,n.index??0);if(!this.isTopLevel(o,i))continue;let a=n[3]??"anonymous";if(s.has(a))continue;r.add(a),s.add(a);let c=this.findArrowEnd(o,i);t.push(this.buildSymbol(a,"function",!!n[1],i,c,e,o))}for(let n of e.matchAll(new RegExp(me.source,"gm"))){let i=this.getLineAt(e,n.index??0);if(!this.isTopLevel(o,i))continue;let a=n[3]??"anonymous";if(s.has(a))continue;s.add(a);let c=this.findClosingBrace(o,i);t.push(this.buildSymbol(a,"function",!!n[1],i,c,e,o))}for(let n of e.matchAll(new RegExp(fe.source,"gm"))){let i=this.getLineAt(e,n.index??0);if(!this.isTopLevel(o,i))continue;let a=n[3]??"AnonymousClass";if(s.has(a))continue;s.add(a);let c=this.findClosingBrace(o,i);t.push(this.buildSymbol(a,"class",!!n[1],i,c,e,o))}for(let n of e.matchAll(new RegExp(ue.source,"gm"))){let i=this.getLineAt(e,n.index??0);if(!this.isTopLevel(o,i))continue;let a=n[2]??"IUnknown";if(s.has(a))continue;s.add(a);let c=this.findClosingBrace(o,i);t.push(this.buildSymbol(a,"interface",!!n[1],i,c,e,o))}for(let n of e.matchAll(new RegExp(he.source,"gm"))){let i=this.getLineAt(e,n.index??0);if(!this.isTopLevel(o,i))continue;let a=n[2]??"UnknownType";if(s.has(a))continue;s.add(a);let c=this.findStatementEnd(o,i);t.push(this.buildSymbol(a,"type",!!n[1],i,c,e,o))}for(let n of e.matchAll(new RegExp(ye.source,"gm"))){let i=n[3]??"unknown";if(r.has(i))continue;let a=this.getLineAt(e,n.index??0);if(!this.isTopLevel(o,a)||s.has(i))continue;s.add(i);let c=n[2]==="const",p=this.findStatementEnd(o,a);t.push(this.buildSymbol(i,c?"constant":"variable",!!n[1],a,p,e,o))}return t}isTopLevel(e,o){let t=e[o]??"";return t.length-t.trimStart().length===0}buildSymbol(e,o,t,r,s,n,i){let a=i.slice(r,s+1).join(`
`),c=i[r]??"",p=this.findDocComment(i,r),d=this.findCalledSymbols(a),g=this.findThisProperties(a);return{name:e,type:o,isExported:t,body:a,docComment:p,signature:c.trim(),range:this.buildRange(r,s),calledSymbols:d,usedThisProps:g}}extractImports(e){let o=[];for(let t of e.matchAll(new RegExp(de.source,"gm"))){let r=!!t[1],s=(t[2]??t[4]??"").split(",").map(c=>c.trim()).filter(Boolean),n=t[3]?[t[3]]:[],i=t[5]??"",a=this.getLineAt(e,t.index??0);o.push({source:i,symbols:[...n,...s],isTypeOnly:r,raw:t[0],line:a})}return o}extractExports(e,o){return o.filter(t=>t.isExported).map(t=>({name:t.name,isDefault:!1,isTypeOnly:t.type==="type"||t.type==="interface"}))}findCalledSymbols(e){let o=new Set,t=/(?:this\.)?(\w+)\s*\(/g;for(let r of e.matchAll(t)){let s=r[1];s&&!["if","for","while","switch","catch","return","new","typeof","await"].includes(s)&&o.add(s)}return[...o]}findThisProperties(e){let o=new Set,t=/this\.(\w+)/g;for(let r of e.matchAll(t))r[1]&&o.add(r[1]);return[...o]}findDocComment(e,o){let t=o-1;for(;t>=0&&e[t]?.trim()==="";)t--;if(t<0)return null;if(e[t]?.trim().endsWith("*/")){let r=t;for(;r>=0&&!e[r]?.trim().startsWith("/**");)r--;if(r>=0)return e.slice(r,t+1).map(s=>s.replace(/^\s*\*?\s?/,"").trim()).filter(Boolean).join(" ")}return null}getLineAt(e,o){let t=0;for(let r=0;r<o&&r<e.length;r++)e[r]===`
`&&t++;return t}findArrowEnd(e,o){for(let t=o;t<Math.min(o+20,e.length);t++){let r=e[t]??"",s=r.indexOf("=>");if(s===-1)continue;return r.slice(s+2).trim().startsWith("{")?this.findClosingBrace(e,t):this.findStatementEnd(e,o)}return this.findStatementEnd(e,o)}findStatementEnd(e,o){let t=0,r=0,s=0,n=null,i=!1,a=!1,c=[];for(let p=o;p<e.length;p++){let d=e[p]??"";for(let g=0;g<d.length;g++){let m=d[g]??"",f=d[g+1]??"";if(i){m==="*"&&f==="/"&&(i=!1,g++);continue}if(n){m===n&&!this.isEscaped(d,g)&&(n=null);continue}if(a){if(m==="`"&&!this.isEscaped(d,g)){a=!1;continue}if(m==="$"&&f==="{"&&!this.isEscaped(d,g)){c.push(t),a=!1,g++;continue}continue}if(m==="/"&&f==="/")break;if(m==="/"&&f==="*"){i=!0,g++;continue}if(m==="/"&&f!=="/"&&f!=="*"&&this.isRegexStart(d,g)){g=this.skipRegexLiteral(d,g);continue}if(m==='"'||m==="'"){n=m;continue}if(m==="`"){a=!0;continue}if(m==="("&&r++,m===")"&&r--,m==="["&&s++,m==="]"&&s--,m==="{"&&t++,m==="}"){if(c.length>0&&t===c[c.length-1]){c.pop(),a=!0;continue}if(t--,t===0&&r===0&&s===0)return p}if(m===";"&&t===0&&r===0&&s===0)return p}if(p>o&&t===0&&r===0&&s===0){let g=d.trimEnd();if(g.endsWith(";")||g==="")return p>o?p-1:p}}return this.logger.warn(`findStatementEnd: fallback \u043E\u0442 \u0441\u0442\u0440\u043E\u043A\u0438 ${o}`),Math.min(o+50,e.length-1)}isEscaped(e,o){let t=0,r=o-1;for(;r>=0&&e[r]==="\\";)t++,r--;return t%2===1}isRegexStart(e,o){let t=o-1;for(;t>=0&&(e[t]===" "||e[t]==="	");)t--;return t<0?!0:"=([!&|?:,;{}~^+-*/%<>".includes(e[t])}skipRegexLiteral(e,o){let t=o+1;for(;t<e.length;){let r=e[t];if(r==="\\"){t+=2;continue}if(r==="["){for(t++;t<e.length&&e[t]!=="]";)e[t]==="\\"&&t++,t++;t++;continue}if(r==="/"){for(t++;t<e.length&&/[gimsuy]/.test(e[t]);)t++;return t-1}t++}return t-1}findClosingBrace(e,o){let t=0,r=!1,s=null,n=!1,i=!1,a=[];for(let c=o;c<e.length;c++){let p=e[c]??"";for(let d=0;d<p.length;d++){let g=p[d]??"",m=p[d+1]??"";if(n){g==="*"&&m==="/"&&(n=!1,d++);continue}if(s){g===s&&!this.isEscaped(p,d)&&(s=null);continue}if(i){if(g==="`"&&!this.isEscaped(p,d)){i=!1;continue}if(g==="$"&&m==="{"&&!this.isEscaped(p,d)){a.push(t),i=!1,d++;continue}continue}if(g==="/"&&m==="/")break;if(g==="/"&&m==="*"){n=!0,d++;continue}if(g==="/"&&m!=="/"&&m!=="*"&&this.isRegexStart(p,d)){d=this.skipRegexLiteral(p,d);continue}if(g==='"'||g==="'"){s=g;continue}if(g==="`"){i=!0;continue}if(g==="{"&&(t++,r=!0),g==="}"){if(a.length>0&&t===a[a.length-1]){a.pop(),i=!0;continue}if(t--,r&&t===0)return c}}}return this.logger.warn(`findClosingBrace: fallback \u043E\u0442 \u0441\u0442\u0440\u043E\u043A\u0438 ${o}`),Math.min(o+50,e.length-1)}buildRange(e,o){return{start:{line:e,column:0},end:{line:o,column:0}}}collectFiles(e,o){let t=[],r=new Set(["node_modules","dist",".git","build","coverage","out"]),s=n=>{for(let i of ae(n,{withFileTypes:!0})){let a=le(n,i.name);i.isDirectory()&&!r.has(i.name)&&!i.name.startsWith(".")?s(a):i.isFile()&&o.includes(ce(i.name).toLowerCase())&&t.push(a)}};return s(e),t}};var Ie={maxLines:200,maxSymbols:15,maxResponsibilities:3,minGodScore:.4,criticalThreshold:.7,warningThreshold:.5},w=class{logger;thresholds;constructor(e){this.logger=e,this.thresholds=Ie}setThresholds(e){this.thresholds=e}detect(e){let o=[];for(let t of e){let r=this.score(t);if(r.total>=this.thresholds.minGodScore){let s=this.classifySeverity(r.total);o.push({filePath:t.filePath,analysis:t,godScore:r,severity:s}),this.logger.debug(`God-\u0444\u0430\u0439\u043B: ${t.filePath} (score=${r.total.toFixed(2)}, severity=${s})`)}}return o.sort((t,r)=>r.godScore.total-t.godScore.total)}score(e){let o=this.scoreLines(e.lineCount),t=this.scoreSymbols(e.symbolCount),r=this.scoreResponsibilities(e),s=this.scoreCoupling(e),n=o*.25+t*.25+r*.35+s*.15;return{lineScore:o,symbolScore:t,responsibilityScore:r,couplingScore:s,total:n}}scoreLines(e){let o=this.thresholds.maxLines;return e<=o?0:this.sigmoid(e,o,o*3)}scoreSymbols(e){let o=this.thresholds.maxSymbols;return e<=o?0:this.sigmoid(e,o,o*3)}scoreResponsibilities(e){let o=new Set(e.imports.map(n=>n.source)),t=new Set(e.symbols.flatMap(n=>n.usedThisProps)),r=Math.max(o.size,Math.ceil(t.size/3),1),s=this.thresholds.maxResponsibilities;return r<=s?0:this.sigmoid(r,s,s*4)}scoreCoupling(e){if(e.symbols.length<3)return 0;let o=new Set(e.symbols.flatMap(i=>i.calledSymbols)),t=new Set(e.symbols.map(i=>i.name)),r=[...o].filter(i=>t.has(i)),s=e.symbols.length*(e.symbols.length-1)/2;if(s===0)return 0;let n=r.length/s;return Math.max(0,1-n*2)}sigmoid(e,o,t){let r=(e-o)/(t-o);return Math.min(1,Math.max(0,r))}classifySeverity(e){return e>=this.thresholds.criticalThreshold?"critical":e>=this.thresholds.warningThreshold?"warning":"info"}};var $=class{logger;constructor(e){this.logger=e}buildSymbolGraph(e,o){let t=new Set(o.map(a=>a.name)),r=new Map,s=[];for(let a of o){let c=a.calledSymbols.filter(p=>t.has(p)&&p!==a.name);r.set(a.name,{name:a.name,type:a.type,calls:c,calledBy:[],thisProperties:[...a.usedThisProps],importedFrom:[]})}for(let a of o)for(let c of a.calledSymbols){let p=r.get(c);p&&c!==a.name&&r.set(c,{...p,calledBy:[...p.calledBy,a.name]})}for(let a of o)for(let c of a.calledSymbols)t.has(c)&&c!==a.name&&s.push({from:a.name,to:c,edgeType:"call",weight:1});let n=this.buildThisEdges(o,t);s.push(...n);let i=this.findSharedState(o);return this.logger.debug(`\u0413\u0440\u0430\u0444 \u0441\u0438\u043C\u0432\u043E\u043B\u043E\u0432 ${e}: ${r.size} \u043D\u043E\u0434, ${s.length} \u0440\u0451\u0431\u0435\u0440`),{nodes:r,edges:s,sharedState:i,externalImports:new Map}}findCallsites(e,o){return o.filter(t=>t.calledSymbols.includes(e)&&t.name!==e).map(t=>t.name)}findSharedState(e){let o=new Map;for(let r of e)for(let s of r.usedThisProps){let n=o.get(s)??[];n.push(r.name),o.set(s,n)}let t=new Map;for(let[r,s]of o)s.length>1&&t.set(r,s);return t}buildThisEdges(e,o){let t=[],r=new Set;for(let s=0;s<e.length;s++)for(let n=s+1;n<e.length;n++){let i=e[s],a=e[n],c=i.usedThisProps.filter(g=>a.usedThisProps.includes(g));if(c.length===0)continue;let p=`${i.name}\u2192${a.name}:this-access`;if(r.has(p))continue;r.add(p);let d=c.length/Math.max(i.usedThisProps.length,a.usedThisProps.length,1);t.push({from:i.name,to:a.name,edgeType:"this-access",weight:d})}return t}};var L=class{logger;constructor(e){this.logger=e}clusterize(e,o){let t=e.analysis.symbols,r=new Map(t.map(a=>[a.name,a])),s=new Map;for(let a of t)s.set(a.name,a.name);for(let a of o.edges)a.weight>=.1&&this.union(s,a.from,a.to);for(let[a,c]of o.sharedState)if(c.length>1){let p=c[0];for(let d=1;d<c.length;d++)this.union(s,p,c[d])}let n=new Map;for(let a of t){let c=this.find(s,a.name),p=n.get(c)??[];p.push(a),n.set(c,p)}let i=[];for(let[a,c]of n){if(c.length<1)continue;let p=this.buildCluster(c,o,e.analysis.imports);i.push(p)}return this.logger.debug(`\u041A\u043B\u0430\u0441\u0442\u0435\u0440\u0438\u0437\u0430\u0446\u0438\u044F ${e.filePath}: ${i.length} \u043A\u043B\u0430\u0441\u0442\u0435\u0440\u043E\u0432`),i.sort((a,c)=>c.linesCount-a.linesCount)}suggestName(e){let o=e.filter(i=>i.type==="class");if(o.length===1)return this.toKebab(o[0].name);let t=e.filter(i=>i.type==="interface");if(t.length===1)return this.toKebab(t[0].name.replace(/^I/,""));let r=e.map(i=>i.name),s=this.longestCommonPrefix(r);if(s.length>=3)return this.toKebab(s);let n=e.reduce((i,a)=>i.body.length>a.body.length?i:a,e[0]);return this.toKebab(n.name)}measureCohesion(e,o){if(e.length<=1)return 1;let t=new Set(e.map(n=>n.name)),r=0;for(let n of o.edges)t.has(n.from)&&t.has(n.to)&&r++;let s=e.length*(e.length-1)/2;return s>0?r/s:0}buildCluster(e,o,t){let r=new Set(e.map(p=>p.name)),s=new Set;for(let p of e)for(let d of p.usedThisProps)s.add(d);let n=new Set;for(let p of e)for(let d of p.calledSymbols)r.has(d)&&d!==p.name&&n.add(d);let i=this.collectExternalImports(e,t),a=e.reduce((p,d)=>p+d.body.split(`
`).length,0),c=this.measureCohesion(e,o);return{suggestedName:this.suggestName(e),symbols:e,sharedState:[...s],internalDeps:[...n],externalImports:i,cohesionScore:c,linesCount:a}}collectExternalImports(e,o){let t=new Set(e.flatMap(s=>[...s.calledSymbols,...s.usedThisProps])),r=new Set;for(let s of o)s.symbols.some(n=>t.has(n))&&r.add(s.source);return[...r]}find(e,o){let t=e.get(o)??o;for(;t!==(e.get(t)??t);)t=e.get(t)??t;let r=o;for(;r!==t;){let s=e.get(r)??r;e.set(r,t),r=s}return t}union(e,o,t){let r=this.find(e,o),s=this.find(e,t);r!==s&&e.set(s,r)}toKebab(e){return e.replace(/([a-z0-9])([A-Z])/g,"$1-$2").replace(/([A-Z])([A-Z][a-z])/g,"$1-$2").toLowerCase().replace(/[^a-z0-9-]/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")}longestCommonPrefix(e){if(e.length===0)return"";let o=e[0]??"";for(let t=1;t<e.length;t++){let r=e[t]??"";for(;!r.startsWith(o)&&o.length>0;)o=o.slice(0,-1)}return o}};import{readFileSync as H,readdirSync as be}from"node:fs";import{join as xe,dirname as E,relative as Se,extname as ve,resolve as _,sep as Re,posix as we}from"node:path";var $e=new Set([".ts",".tsx",".js",".jsx"]),Le=new Set(["node_modules","dist",".git","build","coverage","out"]),T=class{logger;constructor(e){this.logger=e}resolve(e,o){let t=E(o);return e.startsWith(".")?_(t,e):e}findAllConsumers(e,o){let t=this.collectAllFiles(o),r=[],s=this.buildImportVariants(e);for(let n of t)if(n!==e)try{let i=H(n,"utf-8");this.fileImports(i,n,e,s)&&r.push(n)}catch{}return this.logger.debug(`\u041F\u043E\u0442\u0440\u0435\u0431\u0438\u0442\u0435\u043B\u0438 ${e}: \u043D\u0430\u0439\u0434\u0435\u043D\u043E ${r.length}`),r}findUsedSymbolsFrom(e,o){try{let t=H(e,"utf-8"),r=E(e),s=o.replace(/\.(ts|tsx|js|jsx)$/,""),n=/import\s+(?:type\s+)?(?:\{([^}]*)\}|(\w+)(?:\s*,\s*\{([^}]*)\})?)\s+from\s+['"]([^'"]+)['"]/g,i=[];for(let a of t.matchAll(n)){let c=a[4]??"";if(!c.startsWith("."))continue;let p=_(r,c);if(p.replace(/\.(ts|tsx|js|jsx)$/,"")===s||p===o){let g=(a[1]??a[3]??"").split(",").map(f=>f.trim()).filter(Boolean),m=a[2]?[a[2]]:[];i.push(...m,...g)}}return i}catch{return[]}}computeNewPath(e,o){let t=E(e),r=Se(t,o);return r=r.split(Re).join(we.sep),r=r.replace(/\.(ts|tsx|js|jsx)$/,""),r.startsWith(".")||(r="./"+r),r+=".js",r}buildImportVariants(e){let o=[],t=e.replace(/\.(ts|tsx|js|jsx)$/,"");return o.push(e),o.push(t),o.push(t+".js"),o.push(t+".ts"),o}fileImports(e,o,t,r){if(!e.includes("from ")&&!e.includes("require("))return!1;let s=/(?:from\s+['"]([^'"]+)['"]|require\(['"]([^'"]+)['"]\))/g,n=E(o);for(let i of e.matchAll(s)){let a=i[1]??i[2];if(!a||!a.startsWith("."))continue;let c=_(n,a),p=c.replace(/\.(ts|tsx|js|jsx)$/,""),d=t.replace(/\.(ts|tsx|js|jsx)$/,"");if(p===d||c===t)return!0}return!1}collectAllFiles(e){let o=[],t=r=>{try{for(let s of be(r,{withFileTypes:!0})){let n=xe(r,s.name);s.isDirectory()&&!Le.has(s.name)&&!s.name.startsWith(".")?t(n):s.isFile()&&$e.has(ve(s.name).toLowerCase())&&o.push(n)}}catch{}};return t(e),o}};import{dirname as Ee,join as Z,basename as X,posix as Te,sep as Ce}from"node:path";var C=class{importResolver;logger;constructor(e,o){this.importResolver=e,this.logger=o}createPlan(e,o,t,r){let s=Ee(e.filePath),n=X(e.filePath,".ts"),i=Z(s,n),a=o.map((m,f)=>this.buildTarget(m,i,e,f)),c=this.importResolver.findAllConsumers(e.filePath,r),p=this.buildConsumerUpdates(c,e,a),d=a.map(m=>{let f=m.targetPath.split(Ce).join(Te.sep);return`./${X(f,".ts")}.js`}),g=this.computeImpact(a,p);return this.logger.info(`\u041F\u043B\u0430\u043D: ${a.length} \u043C\u043E\u0434\u0443\u043B\u0435\u0439, ${g.consumersAffected} \u043F\u043E\u0442\u0440\u0435\u0431\u0438\u0442\u0435\u043B\u0435\u0439, ${g.totalSymbolsMoved} \u0441\u0438\u043C\u0432\u043E\u043B\u043E\u0432`),{sourceFile:e.filePath,targets:a,barrelExports:d,consumerUpdates:p,impact:g,createdAt:Date.now()}}estimateImpact(e){return e.impact.consumersAffected*2+e.impact.filesCreated}buildTarget(e,o,t,r){let s=`${e.suggestedName}.ts`,n=Z(o,s),i=this.resolveClusterImports(e,t),a=e.symbols.filter(p=>p.isExported).map(p=>p.name),c=e.linesCount+i.length*2+5;return{targetPath:n,symbols:e.symbols,imports:i,exports:a,estimatedLines:c}}resolveClusterImports(e,o){let t=o.analysis.imports,r=new Set(e.symbols.flatMap(i=>[...i.calledSymbols,...i.usedThisProps])),s=new Map;for(let i of t){let a=i.symbols.filter(p=>r.has(p));if(a.length===0)continue;let c=s.get(i.source);if(c){for(let p of a)c.symbols.add(p);i.isTypeOnly||(c.isTypeOnly=!1)}else s.set(i.source,{symbols:new Set(a),isTypeOnly:i.isTypeOnly})}let n=[];for(let[i,a]of s)n.push({source:i,symbols:[...a.symbols],isTypeOnly:a.isTypeOnly});return n}buildConsumerUpdates(e,o,t){let r=[],s=new Map;for(let n of t)for(let i of n.exports)s.set(i,n);for(let n of e){let i=this.importResolver.findUsedSymbolsFrom(n,o.filePath);if(i.length===0)continue;let a=new Map;for(let c of i){let p=s.get(c);if(!p)continue;let d=p.targetPath,g=a.get(d)??[];g.push(c),a.set(d,g)}for(let[c,p]of a){let d=this.importResolver.computeNewPath(n,c);r.push({consumerFile:n,oldImportPath:this.computeRelPath(n,o.filePath),newImportPath:d,importedSymbols:p,isTypeOnly:!1})}}return r}computeRelPath(e,o){return this.importResolver.computeNewPath(e,o)}computeImpact(e,o){let t=new Set(o.map(s=>s.consumerFile)),r=e.reduce((s,n)=>s+n.symbols.length,0);return{filesCreated:e.length+1,filesModified:t.size,filesDeleted:1,totalSymbolsMoved:r,consumersAffected:t.size}}};import{existsSync as Pe,readFileSync as Fe}from"node:fs";import{basename as S}from"node:path";var P=class{logger;constructor(e){this.logger=e}validate(e,o,t=200){let r=[],s=[];this.checkEmptyTargets(e.targets,r),this.checkFileNameConflicts(e.targets,r),this.checkDuplicateSymbols(e.targets,r);let n=this.checkCircularDeps(e.targets);for(let c of n)s.push({code:"CIRCULAR_DEP",message:`\u0426\u0438\u043A\u043B\u0438\u0447\u0435\u0441\u043A\u0430\u044F \u0437\u0430\u0432\u0438\u0441\u0438\u043C\u043E\u0441\u0442\u044C: ${c}`,file:e.sourceFile,severity:"warning"});let i=this.checkExportIntegrity(e);for(let c of i)r.push({code:"MISSING_EXPORT",message:`\u041F\u043E\u0442\u0435\u0440\u044F\u043D \u044D\u043A\u0441\u043F\u043E\u0440\u0442: ${c}`,file:e.sourceFile,severity:"critical"});this.checkExistingFiles(e.targets,s),this.checkTargetSizes(e.targets,s,t);let a=r.length===0;return this.logger.debug(`\u0412\u0430\u043B\u0438\u0434\u0430\u0446\u0438\u044F \u043F\u043B\u0430\u043D\u0430: ${a?"OK":"FAIL"} (${r.length} \u043E\u0448\u0438\u0431\u043E\u043A, ${s.length} \u043F\u0440\u0435\u0434\u0443\u043F\u0440\u0435\u0436\u0434\u0435\u043D\u0438\u0439)`),{isValid:a,errors:r,warnings:s}}checkCircularDeps(e){let o=[],t=new Map;for(let i of e){let a=new Set,c=new Set(i.symbols.map(p=>p.name));for(let p of i.symbols)for(let d of p.calledSymbols)if(!c.has(d)){for(let g of e)if(g!==i&&g.symbols.some(m=>m.name===d)){a.add(g.targetPath);break}}t.set(i.targetPath,a)}let r=new Set,s=new Set,n=(i,a)=>{if(s.has(i)){let c=a.indexOf(i),p=a.slice(c).map(d=>S(d,".ts")).join(" \u2192 ");o.push(`${p} \u2192 ${S(i,".ts")}`);return}if(!r.has(i)){r.add(i),s.add(i),a.push(i);for(let c of t.get(i)??[])n(c,[...a]);s.delete(i)}};for(let i of e)n(i.targetPath,[]);return o}checkExportIntegrity(e){let o=this.extractOriginalExports(e.sourceFile),t=new Set(e.targets.flatMap(r=>r.exports));return o.filter(r=>!t.has(r))}extractOriginalExports(e){try{let o=Fe(e,"utf-8"),t=[],r=/^[ \t]*export\s+(?:default\s+)?(?:type|interface|class|function|const|let|var|async|abstract)\s+(\w+)/gm;for(let s of o.matchAll(r))s[1]&&t.push(s[1]);return t}catch{return this.logger.warn(`\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0440\u043E\u0447\u0438\u0442\u0430\u0442\u044C \u0444\u0430\u0439\u043B \u0434\u043B\u044F \u043F\u0440\u043E\u0432\u0435\u0440\u043A\u0438 \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u043E\u0432: ${e}`),[]}}checkEmptyTargets(e,o){for(let t of e)t.symbols.length===0&&o.push({code:"EMPTY_TARGET",message:`\u041F\u0443\u0441\u0442\u043E\u0439 \u043C\u043E\u0434\u0443\u043B\u044C: ${S(t.targetPath)}`,file:t.targetPath,severity:"critical"})}checkFileNameConflicts(e,o){let t=new Set;for(let r of e)t.has(r.targetPath)&&o.push({code:"DUPLICATE_PATH",message:`\u0414\u0443\u0431\u043B\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u0435 \u043F\u0443\u0442\u0438: ${r.targetPath}`,file:r.targetPath,severity:"critical"}),t.add(r.targetPath)}checkDuplicateSymbols(e,o){let t=new Map;for(let r of e)for(let s of r.symbols){let n=t.get(s.name);n&&o.push({code:"DUPLICATE_SYMBOL",message:`\u0421\u0438\u043C\u0432\u043E\u043B "${s.name}" \u043F\u0440\u0438\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u0435\u0442 \u0432 "${S(n)}" \u0438 "${S(r.targetPath)}"`,file:r.targetPath,severity:"critical"}),t.set(s.name,r.targetPath)}}checkExistingFiles(e,o){for(let t of e)Pe(t.targetPath)&&o.push({code:"FILE_EXISTS",message:`\u0424\u0430\u0439\u043B \u0443\u0436\u0435 \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u0435\u0442: ${t.targetPath}`,file:t.targetPath,severity:"warning"})}checkTargetSizes(e,o,t){for(let r of e)r.estimatedLines>t&&o.push({code:"TARGET_TOO_LARGE",message:`\u041C\u043E\u0434\u0443\u043B\u044C ${S(r.targetPath)} \u2248${r.estimatedLines} \u0441\u0442\u0440\u043E\u043A (\u043F\u043E\u0440\u043E\u0433: ${t})`,file:r.targetPath,severity:"warning"})}};var F=class{logger;constructor(e){this.logger=e}extractSymbolCode(e,o){let t=e.split(`
`),r=o.range.start.line,s=o.range.end.line,n=this.extractDocComment(t,r),i=t.slice(r,s+1);return[...n,...i].join(`
`)}extractImportsForSymbols(e,o){let t=this.collectUsedIdentifiers(o),r=[];for(let s of e){let n=s.symbols.filter(i=>t.has(i));n.length!==0&&r.push({source:s.source,symbols:n,isTypeOnly:s.isTypeOnly,raw:this.rebuildImportLine(n,s.source,s.isTypeOnly),line:s.line})}return this.logger.debug(`\u0418\u0437\u0432\u043B\u0435\u0447\u0435\u043D\u043E ${r.length} \u0438\u043C\u043F\u043E\u0440\u0442\u043E\u0432 \u0434\u043B\u044F ${o.length} \u0441\u0438\u043C\u0432\u043E\u043B\u043E\u0432`),r}extractDocComment(e,o){let t=o-1;for(;t>=0&&(e[t]??"").trim()==="";)t--;if(t<0)return[];if(!(e[t]??"").trim().endsWith("*/"))return[];let s=t;for(;s>=0&&!(e[s]??"").trim().startsWith("/**");)s--;return s<0?[]:e.slice(s,t+1).map(n=>n)}collectUsedIdentifiers(e){let o=new Set;for(let t of e){for(let s of t.calledSymbols)o.add(s);let r=this.scanBodyIdentifiers(t.body);for(let s of r)o.add(s)}return o}scanBodyIdentifiers(e){let o=new Set,t=/\b([A-Z][a-zA-Z0-9]+|[a-z][a-zA-Z0-9]+)\b/g,r=new Set(["if","else","for","while","do","switch","case","break","continue","return","throw","try","catch","finally","new","delete","typeof","instanceof","void","this","class","interface","type","enum","extends","implements","import","export","default","from","as","async","await","const","let","var","function","true","false","null","undefined","string","number","boolean","object","any","unknown","never","void","readonly","private","public","protected","static","abstract","override"]);for(let s of e.matchAll(t)){let n=s[1]??"";n.length>=2&&!r.has(n)&&o.add(n)}return o}rebuildImportLine(e,o,t){let r=t?"type ":"",s=e.join(", ");return`import ${r}{ ${s} } from '${o}';`}};import{basename as K,dirname as Y,resolve as je,relative as Ae,posix as De,sep as Ge}from"node:path";var Oe=(l,e)=>`/**
 * ${l} \u2014 \u043C\u043E\u0434\u0443\u043B\u044C, \u0441\u043E\u0434\u0435\u0440\u0436\u0430\u0449\u0438\u0439 ${e} \u0441\u0438\u043C\u0432\u043E\u043B(\u043E\u0432).
 * \u0421\u043E\u0437\u0434\u0430\u043D \u0430\u0432\u0442\u043E\u043C\u0430\u0442\u0438\u0447\u0435\u0441\u043A\u0438 SOLID Refactorer.
 */
`,j=class{codeExtractor;logger;constructor(e,o){this.codeExtractor=e,this.logger=o}generate(e,o,t,r,s){let n=K(e.targetPath,".ts"),i=[];i.push(Oe(n,e.symbols.length));let a=this.buildImportLines(e.imports,t,e.symbols,r,e,s);a.length>0&&(i.push(a.join(`
`)),i.push(""));for(let p of e.symbols){let d=this.codeExtractor.extractSymbolCode(o,p),g=this.ensureExport(d,p);i.push(g),i.push("")}let c=i.join(`
`).trimEnd()+`
`;return this.logger.debug(`\u0421\u0433\u0435\u043D\u0435\u0440\u0438\u0440\u043E\u0432\u0430\u043D \u043C\u043E\u0434\u0443\u043B\u044C: ${n} (${c.split(`
`).length} \u0441\u0442\u0440\u043E\u043A)`),{path:e.targetPath,content:c,isNew:!0}}buildImportLines(e,o,t,r,s,n){let i=this.collectAllUsedIdentifiers(t),a=new Map,c=(m,f,u)=>{let y=f.filter(N=>i.has(N));if(y.length===0)return;let k=a.get(m);if(k){for(let N of y)k.symbols.add(N);u||(k.isTypeOnly=!1)}else a.set(m,{symbols:new Set(y),isTypeOnly:u})},p=m=>this.adjustImportPath(m,n,s.targetPath);for(let m of e)c(p(m.source),m.symbols,m.isTypeOnly);for(let m of o)c(p(m.source),m.symbols,m.isTypeOnly);let d=new Set(s.symbols.map(m=>m.name));for(let m of r){if(m.targetPath===s.targetPath)continue;let f=[],u=!0;for(let y of m.symbols)i.has(y.name)&&!d.has(y.name)&&(f.push(y.name),y.type!=="interface"&&y.type!=="type"&&(u=!1));if(f.length>0){let y="./"+K(m.targetPath,".ts")+".js";c(y,f,u)}}let g=[];for(let[m,f]of a){let u=f.isTypeOnly?"type ":"",y=[...f.symbols].sort();g.push(`import ${u}{ ${y.join(", ")} } from '${m}';`)}return g}adjustImportPath(e,o,t){if(!e.startsWith("."))return e;let r=Y(o),s=Y(t),n=je(r,e),i=Ae(s,n).split(Ge).join(De.sep);return i.startsWith(".")||(i="./"+i),i}collectAllUsedIdentifiers(e){let o=new Set,t=new Set(["if","else","for","while","do","switch","case","break","continue","return","throw","try","catch","finally","new","delete","typeof","instanceof","void","this","class","interface","type","enum","extends","implements","import","export","default","from","as","async","await","const","let","var","function","true","false","null","undefined","string","number","boolean","object","any","unknown","never","readonly","private","public","protected","static","abstract","override"]);for(let r of e){for(let n of r.calledSymbols)o.add(n);for(let n of r.usedThisProps)o.add(n);let s=/\b([A-Za-z_$][a-zA-Z0-9_$]*)\b/g;for(let n of r.body.matchAll(s)){let i=n[1]??"";i.length>=2&&!t.has(i)&&o.add(i)}}return o}ensureExport(e,o){let t=e.split(`
`);for(let r=0;r<t.length;r++){let s=t[r].trimStart();if(!s||s.startsWith("*")||s.startsWith("/*")||s.startsWith("//")||s.startsWith("*/"))continue;if(s.startsWith("export "))return e;let n=t[r].replace(/^(\s*)(async\s+)?(function|class|interface|type|const|let|var|abstract)/,"$1export $2$3");if(n!==t[r])return t[r]=n,t.join(`
`);break}return e}};var A=class{logger;constructor(e){this.logger=e}rewriteFile(e,o,t){let r=o,s=this.groupByOldPath(t);for(let[n,i]of s)r=this.rewriteImportGroup(r,n,i);return{path:e,content:r,isNew:!1}}findImportsFrom(e,o){let t=[],r=e.split(`
`),s=o.replace(/\.(ts|tsx|js|jsx)$/,"");for(let n=0;n<r.length;n++){let i=r[n]??"",a=i.match(/^[ \t]*import\s+(type\s+)?(?:\{([^}]*)\}|(\w+))\s+from\s+['"]([^'"]+)['"]/);if(!a)continue;let c=a[4]??"";if(c.replace(/\.(ts|tsx|js|jsx)$/,"")===s||c===o){let d=!!a[1],g=(a[2]??"").split(",").map(f=>f.trim()).filter(Boolean),m=a[3]?[a[3]]:[];t.push({source:c,symbols:[...m,...g],isTypeOnly:d,raw:i.trim(),line:n})}}return t}groupByOldPath(e){let o=new Map;for(let t of e){let r=o.get(t.oldImportPath)??[];r.push(t),o.set(t.oldImportPath,r)}return o}rewriteImportGroup(e,o,t){let r=e.split(`
`),s=o.replace(/\.(ts|tsx|js|jsx)$/,""),n=[],i="";for(let p=0;p<r.length;p++){let d=r[p]??"",g=d.match(/from\s+['"]([^'"]+)['"]/);if(!g)continue;(g[1]??"").replace(/\.(ts|tsx|js|jsx)$/,"")===s&&(n.push(p),i||(i=d))}if(n.length===0)return e;let a=this.buildNewImportLines(t,i),c=[...r];for(let p=n.length-1;p>=0;p--){let d=n[p];p===0?c.splice(d,1,...a):c.splice(d,1)}return c.join(`
`)}buildNewImportLines(e,o){let t=[],r=o.match(/^(\s*)/)?.[1]??"",s=o.includes("import type");for(let n of e){let i=n.isTypeOnly?"type ":"",a=n.importedSymbols.join(", ");t.push(`${r}import ${i}{ ${a} } from '${n.newImportPath}';`)}return t}};import{basename as q,dirname as J,relative as Me,posix as Be,sep as ke}from"node:path";var D=class{logger;constructor(e){this.logger=e}generate(e,o){let t=q(e,".ts"),r=J(o[0]?.targetPath??e),s=e,n=[];n.push("/**"),n.push(" * Barrel-\u0444\u0430\u0439\u043B: re-export \u0438\u0437 \u0440\u0430\u0437\u0431\u0438\u0442\u044B\u0445 \u043C\u043E\u0434\u0443\u043B\u0435\u0439."),n.push(` * \u041E\u0440\u0438\u0433\u0438\u043D\u0430\u043B\u044C\u043D\u044B\u0439 \u0444\u0430\u0439\u043B: ${t}.ts`),n.push(" * \u0421\u043E\u0437\u0434\u0430\u043D \u0430\u0432\u0442\u043E\u043C\u0430\u0442\u0438\u0447\u0435\u0441\u043A\u0438 SOLID Refactorer."),n.push(" */"),n.push("");for(let a of o){let c=q(a.targetPath,".ts"),p=this.computeRelativePath(e,a.targetPath);n.push(`export * from '${p}';`)}n.push("");let i=n.join(`
`);return this.logger.debug(`Barrel: ${s} \u2014 ${o.length} re-export'\u043E\u0432`),{path:s,content:i,isNew:!1}}computeRelativePath(e,o){let t=J(e),r=Me(t,o);return r=r.split(ke).join(Be.sep),r=r.replace(/\.(ts|tsx)$/,""),r.startsWith(".")||(r="./"+r),r+=".js",r}};import{execSync as Ne}from"node:child_process";import{join as _e}from"node:path";import{existsSync as ze}from"node:fs";var G=class{logger;constructor(e){this.logger=e}check(e){let o=this.findTsConfig(e);if(!o)return this.logger.warn("tsconfig.json \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D \u2014 \u043F\u0440\u043E\u043F\u0443\u0441\u043A\u0430\u0435\u043C \u043F\u0440\u043E\u0432\u0435\u0440\u043A\u0443 \u043A\u043E\u043C\u043F\u0438\u043B\u044F\u0446\u0438\u0438"),{success:!0,errors:[],duration:0};let t=Date.now();this.logger.info("\u0417\u0430\u043F\u0443\u0441\u043A tsc --noEmit...");try{let r=`npx tsc --noEmit --project "${o}"`;Ne(r,{cwd:e,encoding:"utf-8",stdio:["pipe","pipe","pipe"],timeout:6e4});let s=Date.now()-t;return this.logger.success(`\u041A\u043E\u043C\u043F\u0438\u043B\u044F\u0446\u0438\u044F OK (${s}ms)`),{success:!0,errors:[],duration:s}}catch(r){let s=Date.now()-t,n=this.extractErrorOutput(r),i=this.parseTscErrors(n);return this.logger.error(`\u041A\u043E\u043C\u043F\u0438\u043B\u044F\u0446\u0438\u044F FAIL: ${i.length} \u043E\u0448\u0438\u0431\u043E\u043A (${s}ms)`),{success:!1,errors:i,duration:s}}}parseTscErrors(e){let o=[],t=/^(.+)\((\d+),(\d+)\):\s*(error|warning)\s+(TS\d+):\s*(.+)$/gm;for(let s of e.matchAll(t))o.push({file:s[1]??"",line:parseInt(s[2]??"0",10),column:parseInt(s[3]??"0",10),code:s[5]??"",message:s[6]??""});let r=/^(.+):(\d+):(\d+)\s*-\s*(error|warning)\s+(TS\d+):\s*(.+)$/gm;for(let s of e.matchAll(r))o.find(i=>i.file===s[1]&&i.line===parseInt(s[2]??"0",10))||o.push({file:s[1]??"",line:parseInt(s[2]??"0",10),column:parseInt(s[3]??"0",10),code:s[5]??"",message:s[6]??""});return o}findTsConfig(e){let o=["tsconfig.json","tsconfig.build.json"];for(let t of o){let r=_e(e,t);if(ze(r))return r}return null}extractErrorOutput(e){if(e&&typeof e=="object"){let o=e,t=o.stderr,r=o.stdout;if(typeof t=="string"&&t.length>0)return t;if(typeof r=="string"&&r.length>0)return r;if(typeof o.message=="string")return o.message}return String(e)}};import{readFileSync as Ue,writeFileSync as We,existsSync as O,mkdirSync as Ve,unlinkSync as He,rmdirSync as Ze}from"node:fs";import{dirname as Q}from"node:path";import{randomUUID as Xe}from"node:crypto";var M=class{logger;snapshots=new Map;constructor(e){this.logger=e}createSnapshot(e){let o=new Map,t=0;for(let n of e)if(O(n)){let i=Ue(n,"utf-8");o.set(n,i),t++}else o.set(n,"___FILE_NOT_EXISTS___");let r=Xe().slice(0,8),s={id:r,files:o,createdAt:Date.now()};return this.snapshots.set(r,s),this.logger.info(`\u0421\u043D\u0438\u043C\u043E\u043A \u0441\u043E\u0437\u0434\u0430\u043D: ${r} (${t} \u0444\u0430\u0439\u043B\u043E\u0432)`),s}rollback(e){this.logger.warn(`\u041E\u0442\u043A\u0430\u0442 \u043A \u0441\u043D\u0438\u043C\u043A\u0443 ${e.id}...`);let o=0,t=0;for(let[r,s]of e.files)try{s==="___FILE_NOT_EXISTS___"?O(r)&&(He(r),t++):(this.ensureDir(r),We(r,s,"utf-8"),o++)}catch(n){this.logger.error(`\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C: ${r} \u2014 ${String(n)}`)}this.cleanupEmptyDirs(e),this.logger.info(`\u041E\u0442\u043A\u0430\u0442 \u0437\u0430\u0432\u0435\u0440\u0448\u0451\u043D: ${o} \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u043E, ${t} \u0443\u0434\u0430\u043B\u0435\u043D\u043E`)}commit(e){this.snapshots.delete(e.id),this.logger.debug(`\u0421\u043D\u0438\u043C\u043E\u043A ${e.id} \u0437\u0430\u0444\u0438\u043A\u0441\u0438\u0440\u043E\u0432\u0430\u043D (\u0443\u0434\u0430\u043B\u0451\u043D \u0438\u0437 \u043F\u0430\u043C\u044F\u0442\u0438)`)}ensureDir(e){let o=Q(e);O(o)||Ve(o,{recursive:!0})}cleanupEmptyDirs(e){let o=new Set;for(let[t,r]of e.files)r==="___FILE_NOT_EXISTS___"&&o.add(Q(t));for(let t of o)try{O(t)&&(Ze(t),this.logger.debug(`\u0423\u0434\u0430\u043B\u0435\u043D\u0430 \u043F\u0443\u0441\u0442\u0430\u044F \u0434\u0438\u0440\u0435\u043A\u0442\u043E\u0440\u0438\u044F: ${t}`))}catch{}}};import{readFileSync as ee,writeFileSync as Ke,mkdirSync as Ye,existsSync as qe}from"node:fs";import{dirname as Je,relative as te,basename as oe}from"node:path";var B=class{deps;constructor(e){this.deps=e}runFullRefactor(e){let o=Date.now(),{logger:t}=this.deps;t.phase(1,5,"\u0410\u041D\u0410\u041B\u0418\u0417");let s=this.analyzeOnly(e).reports;if(s.length===0)return t.success("God-\u0444\u0430\u0439\u043B\u044B \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u044B. \u041F\u0440\u043E\u0435\u043A\u0442 \u0447\u0438\u0441\u0442!"),this.buildResult("analyze",0,0,[],[],[],o);let n=e.target?s.filter(f=>f.godFile.filePath.includes(e.target??"")):s;if(n.length===0&&e.target)return t.warn(`\u0424\u0430\u0439\u043B "${e.target}" \u043D\u0435 \u044F\u0432\u043B\u044F\u0435\u0442\u0441\u044F god-\u0444\u0430\u0439\u043B\u043E\u043C.`),this.buildResult("analyze",s.length,0,[],[],[],o);t.info(`\u041D\u0430\u0439\u0434\u0435\u043D\u043E ${n.length} god-\u0444\u0430\u0439\u043B(\u043E\u0432)`),t.phase(2,5,"\u041F\u041B\u0410\u041D\u0418\u0420\u041E\u0412\u0410\u041D\u0418\u0415");let i=[];for(let f of n){let u=this.planSingleFile(f,e);u&&i.push(u)}if(i.length===0)return t.warn("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u0444\u043E\u0440\u043C\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u043D\u0438 \u043E\u0434\u043D\u043E\u0433\u043E \u043F\u043B\u0430\u043D\u0430"),this.buildResult("plan",n.length,0,[],[],[],o);if(e.dryRun)return this.printPlans(i),this.buildResult("plan",n.length,0,[],[],[],o);t.phase(3,5,"\u0413\u0415\u041D\u0415\u0420\u0410\u0426\u0418\u042F \u041A\u041E\u0414\u0410");let a=[],c=[];for(let f of i){let{files:u,affectedPaths:y}=this.generateForPlan(f,e);a.push(...u),c.push(...y)}t.phase(4,5,"\u0417\u0410\u041F\u0418\u0421\u042C \u0424\u0410\u0419\u041B\u041E\u0412");let p=this.deps.rollbackManager.createSnapshot(c);this.writeFiles(a),t.phase(5,5,"\u0412\u0415\u0420\u0418\u0424\u0418\u041A\u0410\u0426\u0418\u042F");let d=this.deps.compilationChecker.check(e.projectRoot);if(!d.success){t.error("\u041A\u043E\u043C\u043F\u0438\u043B\u044F\u0446\u0438\u044F \u043F\u0440\u043E\u0432\u0430\u043B\u0435\u043D\u0430 \u2014 \u043E\u0442\u043A\u0430\u0442!"),this.deps.rollbackManager.rollback(p);let f=d.errors.map(u=>`${u.file}:${u.line} \u2014 ${u.code}: ${u.message}`);return this.buildResult("verify",n.length,0,[],[],f,o)}this.deps.rollbackManager.commit(p);let g=a.filter(f=>f.isNew).map(f=>f.path),m=a.filter(f=>!f.isNew).map(f=>f.path);return t.success(`\u0420\u0435\u0444\u0430\u043A\u0442\u043E\u0440\u0438\u043D\u0433 \u0437\u0430\u0432\u0435\u0440\u0448\u0451\u043D: ${g.length} \u0441\u043E\u0437\u0434\u0430\u043D\u043E, ${m.length} \u043C\u043E\u0434\u0438\u0444\u0438\u0446\u0438\u0440\u043E\u0432\u0430\u043D\u043E`),this.buildResult("verify",n.length,i.length,g,m,[],o)}analyzeOnly(e){let{fileAnalyzer:o,godDetector:t,depAnalyzer:r,clusterer:s,logger:n}=this.deps;t.setThresholds(e.thresholds);let i=o.analyzeProject(e.projectRoot,e.extensions),a=i.length,c=i.reduce((g,m)=>g+m.lineCount,0);n.success(`\u041D\u0430\u0439\u0434\u0435\u043D\u043E ${a} \u0444\u0430\u0439\u043B\u043E\u0432  (${c.toLocaleString("ru-RU")} \u0441\u0442\u0440\u043E\u043A)`);let p=t.detect(i),d=[];for(let g of p){let m=r.buildSymbolGraph(g.filePath,g.analysis.symbols),f=s.clusterize(g,m);d.push({godFile:g,clusters:f,symbolGraph:m})}return{reports:d,totalFiles:a,totalLines:c}}planOnly(e,o){let{reports:t}=this.analyzeOnly(o),r=t.find(s=>s.godFile.filePath.includes(e));return r?this.planSingleFile(r,o):null}planSingleFile(e,o){let{splitPlanner:t,splitValidator:r,logger:s}=this.deps,n=t.createPlan(e.godFile,e.clusters,e.symbolGraph,o.projectRoot),i=r.validate(n,o.projectRoot,o.thresholds.maxLines);if(!i.isValid){for(let a of i.errors)s.error(`\u0412\u0430\u043B\u0438\u0434\u0430\u0446\u0438\u044F: [${a.code}] ${a.message}`);return null}for(let a of i.warnings)s.warn(`\u0412\u0430\u043B\u0438\u0434\u0430\u0446\u0438\u044F: [${a.code}] ${a.message}`);return n}generateForPlan(e,o){let{moduleGenerator:t,importRewriter:r,barrelGenerator:s,logger:n}=this.deps,i=[],a=[e.sourceFile],c=ee(e.sourceFile,"utf-8"),p=this.deps.fileAnalyzer.analyzeFile(e.sourceFile).imports;for(let m of e.targets){let f=t.generate(m,c,p,e.targets,e.sourceFile);i.push(f),a.push(m.targetPath),n.progress(i.length,e.targets.length,oe(m.targetPath))}let d=s.generate(e.sourceFile,e.targets);i.push(d);let g=this.groupUpdatesByConsumer(e);for(let[m,f]of g)try{let u=ee(m,"utf-8"),y=r.rewriteFile(m,u,f);i.push(y),a.push(m)}catch{n.warn(`\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0440\u043E\u0447\u0438\u0442\u0430\u0442\u044C \u043F\u043E\u0442\u0440\u0435\u0431\u0438\u0442\u0435\u043B\u044C: ${m}`)}return{files:i,affectedPaths:a}}groupUpdatesByConsumer(e){let o=new Map;for(let t of e.consumerUpdates){let r=o.get(t.consumerFile)??[];r.push(t),o.set(t.consumerFile,r)}return o}writeFiles(e){for(let o of e){let t=Je(o.path);qe(t)||Ye(t,{recursive:!0}),Ke(o.path,o.content,"utf-8"),this.deps.logger.debug(`\u0417\u0430\u043F\u0438\u0441\u0430\u043D: ${te(process.cwd(),o.path)}`)}}printPlans(e){let{logger:o}=this.deps;for(let t of e){o.info(`
\u{1F4C4} ${te(process.cwd(),t.sourceFile)}`);for(let r of t.targets){let s=r.symbols.map(n=>n.name).join(", ");o.info(`  \u2192 ${oe(r.targetPath)} (${s})`)}o.info(`  \u{1F4CA} \u0412\u043B\u0438\u044F\u043D\u0438\u0435: ${t.impact.filesCreated} \u0441\u043E\u0437\u0434\u0430\u043D\u043E, ${t.impact.consumersAffected} \u043F\u043E\u0442\u0440\u0435\u0431\u0438\u0442\u0435\u043B\u0435\u0439`)}}buildResult(e,o,t,r,s,n,i){return{success:n.length===0,phase:e,godFilesFound:o,godFilesRefactored:t,filesCreated:r,filesModified:s,errors:n,duration:Date.now()-i}}};var et="1.0.0";function tt(l,e){let o=e.dryRun?"dry-run":"analyze",t=e.extensions.join(", "),r=e.projectRoot.length>36?"..."+e.projectRoot.slice(-33):e.projectRoot;console.log(""),l.boxTop(),l.boxLine(`\u{1F527} SOLID Refactorer  v${et}`),l.boxLine(`\u25CF ${r}    ${t}`),l.boxBot(),console.log("")}function ot(l,e){console.log(""),l.boxTop(),l.boxLine(`\u{1F4CA}  GOD-\u0424\u0410\u0419\u041B\u042B  (${e.length} \u043D\u0430\u0439\u0434\u0435\u043D\u043E)`),l.boxDiv();for(let o of e){let{godFile:t,clusters:r}=o,s=re(process.cwd(),t.filePath),n=t.godScore,i=it(t.severity);if(l.boxEmpty(),l.boxLine(`${i} ${s}`),l.boxLine(`   \u0421\u0442\u0440\u043E\u043A: ${t.analysis.lineCount}  \xB7  \u0421\u0438\u043C\u0432\u043E\u043B\u043E\u0432: ${t.analysis.symbolCount}  \xB7  Score: ${n.total.toFixed(2)}`),l.boxLine(`   ${at(n.total)}  ${(n.total*100).toFixed(0)}%`),r.length>0){let c=r.slice(0,3),p=r.length-3;for(let d=0;d<c.length;d++){let g=c[d],m=d<c.length-1&&p<=0?"\u251C\u2500\u2500":d===c.length-1&&p<=0?"\u2514\u2500\u2500":"\u251C\u2500\u2500";l.boxLine(`   ${m} ${g.suggestedName} [${g.linesCount} \u0441\u0442\u0440\u043E\u043A]`)}p>0&&l.boxLine(`   \u2514\u2500\u2500 +${p} \u0435\u0449\u0451`)}}l.boxEmpty(),l.boxBot()}function rt(l,e,o){let{totalFiles:t,totalLines:r}=e,s=o.filter(p=>p.godFile.severity==="critical").length,n=o.filter(p=>p.godFile.severity==="warning").length,i=o.filter(p=>p.godFile.severity==="info").length,a=o.reduce((p,d)=>p+d.clusters.length,0),c=t>0?Math.round(o.length/t*100):0;console.log(""),l.boxTop(),l.boxLine("\u{1F4C8}  \u0421\u0412\u041E\u0414\u041A\u0410 \u0410\u041D\u0410\u041B\u0418\u0417\u0410"),l.boxDiv(),l.boxLine(`\u{1F4C1}  \u0424\u0430\u0439\u043B\u043E\u0432 \u043F\u0440\u043E\u0430\u043D\u0430\u043B\u0438\u0437\u0438\u0440\u043E\u0432\u0430\u043D\u043E:   ${t}  (${lt(r)} \u0441\u0442\u0440\u043E\u043A)`),l.boxLine(`\u{1F50D}  God-\u0444\u0430\u0439\u043B\u043E\u0432:                ${o.length}  (${c}%)`),l.boxDiv(),l.boxLine(`\u{1F534}  \u041A\u0440\u0438\u0442\u0438\u0447\u0435\u0441\u043A\u0438\u0445 (score \u2265 0.6): ${s}`),l.boxLine(`\u{1F7E1}  \u041F\u0440\u0435\u0434\u0443\u043F\u0440\u0435\u0436\u0434\u0435\u043D\u0438\u0439:            ${n}`),l.boxLine(`\u{1F535}  \u0418\u043D\u0444\u043E\u0440\u043C\u0430\u0446\u0438\u043E\u043D\u043D\u044B\u0445:            ${i}`),l.boxDiv(),l.boxLine(`\u{1F4E6}  \u041A\u043B\u0430\u0441\u0442\u0435\u0440\u043E\u0432:                 ${a} \u043E\u0442\u0432\u0435\u0442\u0441\u0442\u0432\u0435\u043D\u043D\u043E\u0441\u0442\u0435\u0439`),l.boxLine(`\u23F1   \u0412\u0440\u0435\u043C\u044F:                     ${l.elapsed()}`),l.boxBot()}function st(l,e){console.log(""),l.boxTop(),l.boxLine(`\u{1F5C2}   \u041F\u041B\u0410\u041D\u042B \u0420\u0415\u0424\u0410\u041A\u0422\u041E\u0420\u0418\u041D\u0413\u0410  (${e.length} \u0444\u0430\u0439\u043B\u043E\u0432)`),l.boxDiv();for(let o of e){let t=re(process.cwd(),o.sourceFile);l.boxEmpty(),l.boxLine(`\u{1F4C4} ${t}`);for(let r=0;r<o.targets.length;r++){let s=o.targets[r],n=s.symbols.map(c=>c.name).slice(0,3).join(", "),i=s.symbols.length>3?` +${s.symbols.length-3}`:"",a=r<o.targets.length-1?"\u251C\u2500\u2500":"\u2514\u2500\u2500";l.boxLine(`   ${a} \u2192 ${Qe(s.targetPath)}  (${n}${i})`)}l.boxLine(`   \u{1F4CA} ${o.impact.filesCreated} \u0441\u043E\u0437\u0434\u0430\u043D\u043E \xB7 ${o.impact.consumersAffected} \u043F\u043E\u0442\u0440\u0435\u0431\u0438\u0442\u0435\u043B\u0435\u0439`)}l.boxEmpty(),l.boxBot()}function nt(l,e){let o=e.success?"\u2705":"\u274C";if(console.log(""),l.boxTop(),l.boxLine(`${o}  \u0420\u0415\u0417\u0423\u041B\u042C\u0422\u0410\u0422 \u0420\u0415\u0424\u0410\u041A\u0422\u041E\u0420\u0418\u041D\u0413\u0410`),l.boxDiv(),l.boxLine(`God-\u0444\u0430\u0439\u043B\u043E\u0432 \u043D\u0430\u0439\u0434\u0435\u043D\u043E:      ${e.godFilesFound}`),l.boxLine(`God-\u0444\u0430\u0439\u043B\u043E\u0432 \u0440\u0435\u0444\u0430\u043A\u0442\u043E\u0440\u0435\u043D\u043E:  ${e.godFilesRefactored}`),l.boxLine(`\u0424\u0430\u0439\u043B\u043E\u0432 \u0441\u043E\u0437\u0434\u0430\u043D\u043E:          ${e.filesCreated.length}`),l.boxLine(`\u0424\u0430\u0439\u043B\u043E\u0432 \u043C\u043E\u0434\u0438\u0444\u0438\u0446\u0438\u0440\u043E\u0432\u0430\u043D\u043E:   ${e.filesModified.length}`),l.boxLine(`\u041E\u0448\u0438\u0431\u043E\u043A:                  ${e.errors.length}`),l.boxDiv(),l.boxLine(`\u23F1   \u0412\u0440\u0435\u043C\u044F:  ${e.duration}ms`),l.boxBot(),e.errors.length>0){console.log(""),l.error("\u041E\u0448\u0438\u0431\u043A\u0438:");for(let t of e.errors)l.error(`  ${t}`)}}function it(l){switch(l){case"critical":return"\u{1F534}";case"warning":return"\u{1F7E1}";case"info":return"\u{1F535}"}}function at(l){let o=Math.round(20*l);return"\u2588".repeat(o)+"\u2591".repeat(20-o)}function lt(l){return l.toLocaleString("ru-RU")}function ct(l){let e=new R(l),o=new w(l),t=new $(l),r=new L(l),s=new T(l),n=new C(s,l),i=new P(l),a=new F(l),c=new j(a,l),p=new A(l),d=new D(l),g=new G(l),m=new M(l);return new B({fileAnalyzer:e,godDetector:o,depAnalyzer:t,clusterer:r,importResolver:s,splitPlanner:n,splitValidator:i,codeExtractor:a,moduleGenerator:c,importRewriter:p,barrelGenerator:d,compilationChecker:g,rollbackManager:m,logger:l})}function pt(){let l=z(process.argv);(process.argv.includes("--help")||process.argv.includes("-h"))&&(W(),process.exit(0));let e=U(l),o=new v(e.verbose);tt(o,e);let t=ct(o);l.analyzeOnly&&(dt(o,t,e),process.exit(0)),e.target&&e.dryRun&&(mt(o,t,e),process.exit(0)),gt(o,t,e)}function dt(l,e,o){l.phase(1,3,"\u0421\u041A\u0410\u041D\u0418\u0420\u041E\u0412\u0410\u041D\u0418\u0415"),l.info(`\u041F\u0443\u0442\u044C:    ${o.projectRoot}`),l.info(`\u0420\u0430\u0441\u0448:    ${o.extensions.join(", ")}`),l.info("\u0420\u0435\u0436\u0438\u043C:   \u0422\u043E\u043B\u044C\u043A\u043E \u0430\u043D\u0430\u043B\u0438\u0437"),l.info(`\u041F\u043E\u0440\u043E\u0433\u0438:  \u0441\u0442\u0440\u043E\u043A \u2265${o.thresholds.maxLines}  \u0441\u0438\u043C\u0432\u043E\u043B\u043E\u0432 \u2265${o.thresholds.maxSymbols}  score \u2265${o.thresholds.minGodScore}`);let t=e.analyzeOnly(o);l.phase(2,3,"\u0414\u0415\u0422\u0415\u041A\u0426\u0418\u042F GOD-\u0424\u0410\u0419\u041B\u041E\u0412");let{reports:r,totalFiles:s}=t,n=s>0?Math.round(r.length/s*100):0;if(l.success(`${r.length} god-\u0444\u0430\u0439\u043B\u043E\u0432 \u0438\u0437 ${s}  (${n}%)`),r.length>0){let a=r.filter(d=>d.godFile.severity==="critical").length,c=r.filter(d=>d.godFile.severity==="warning").length,p=r.filter(d=>d.godFile.severity==="info").length;l.info(`\u{1F534} ${a} \u043A\u0440\u0438\u0442\u0438\u0447\u0435\u0441\u043A\u0438\u0445  \u{1F7E1} ${c} \u043F\u0440\u0435\u0434\u0443\u043F\u0440\u0435\u0436\u0434\u0435\u043D\u0438\u0439  \u{1F535} ${p} \u0438\u043D\u0444\u043E`)}l.phase(3,3,"\u041A\u041B\u0410\u0421\u0422\u0415\u0420\u041D\u042B\u0419 \u0410\u041D\u0410\u041B\u0418\u0417");let i=r.reduce((a,c)=>a+c.clusters.length,0);l.success(`${i} \u043A\u043B\u0430\u0441\u0442\u0435\u0440\u043E\u0432 \u0432 ${r.length} \u0444\u0430\u0439\u043B\u0430\u0445`),r.length>0&&ot(l,r),rt(l,t,r),console.log(""),l.success(`\u0410\u043D\u0430\u043B\u0438\u0437 \u0437\u0430\u0432\u0435\u0440\u0448\u0451\u043D \u0437\u0430 ${l.elapsed()}.  --dry-run \u0434\u043B\u044F \u043F\u043B\u0430\u043D\u043E\u0432 \u0440\u0435\u0444\u0430\u043A\u0442\u043E\u0440\u0438\u043D\u0433\u0430.`)}function mt(l,e,o){let t=o.target;if(!t)return;l.phase(1,2,"\u0410\u041D\u0410\u041B\u0418\u0417 \u0426\u0415\u041B\u0415\u0412\u041E\u0413\u041E \u0424\u0410\u0419\u041B\u0410"),l.info(`\u0424\u0430\u0439\u043B: ${t}`);let r=e.planOnly(t,o);if(!r){l.warn(`\u0424\u0430\u0439\u043B "${t}" \u043D\u0435 \u044F\u0432\u043B\u044F\u0435\u0442\u0441\u044F god-\u0444\u0430\u0439\u043B\u043E\u043C \u0438\u043B\u0438 \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D.`);return}l.phase(2,2,"\u041F\u041B\u0410\u041D \u0420\u0410\u0417\u0411\u0418\u0415\u041D\u0418\u042F"),st(l,[r]),l.success("\u041F\u043B\u0430\u043D \u0433\u043E\u0442\u043E\u0432. \u0417\u0430\u043F\u0443\u0441\u0442\u0438\u0442\u0435 \u0431\u0435\u0437 --dry-run \u0434\u043B\u044F \u043F\u0440\u0438\u043C\u0435\u043D\u0435\u043D\u0438\u044F.")}function gt(l,e,o){let t=e.runFullRefactor(o);nt(l,t),process.exit(t.success?0:1)}pt();
