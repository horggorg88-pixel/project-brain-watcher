#!/usr/bin/env node
import{relative as Q,basename as He}from"node:path";import{resolve as ee}from"node:path";import{existsSync as te}from"node:fs";var oe=[".ts",".tsx"],I={maxLines:200,maxSymbols:15,maxResponsibilities:3,minGodScore:.35,criticalThreshold:.7,warningThreshold:.5};function N(l){let e=l.slice(2),t={};for(let o=0;o<e.length;o++){let r=e[o]??"";if(r.startsWith("--")){let s=r.slice(2),n=e[o+1];n&&!n.startsWith("--")?(t[s]=n,o++):t[s]="true"}}return{path:t.path??process.cwd(),dryRun:t["dry-run"]==="true"||t.dryRun==="true",verbose:t.verbose==="true"||t.v==="true",autoApprove:t["auto-approve"]==="true"||t.yes==="true",maxLines:parseInt(t["max-lines"]??String(I.maxLines),10),maxSymbols:parseInt(t["max-symbols"]??String(I.maxSymbols),10),minScore:parseFloat(t["min-score"]??String(I.minGodScore)),extensions:t.exts?t.exts.split(","):[...oe],analyzeOnly:t["analyze-only"]==="true"||t.analyze==="true",target:t.target??null}}function _(l){let e=ee(l.path);if(!te(e))throw new Error(`\u041F\u0443\u0442\u044C \u043D\u0435 \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u0435\u0442: ${e}`);return{projectRoot:e,extensions:l.extensions,thresholds:{maxLines:l.maxLines,maxSymbols:l.maxSymbols,maxResponsibilities:I.maxResponsibilities,minGodScore:l.minScore,criticalThreshold:I.criticalThreshold,warningThreshold:I.warningThreshold},dryRun:l.dryRun,autoApprove:l.autoApprove,verbose:l.verbose,target:l.target}}function z(){let t="\u2500".repeat(62),o=`  \u250C${t}\u2510`,r=`  \u2514${t}\u2518`,s=i=>{let a=Math.max(60-i.length,0);return`  \u2502  ${i}${" ".repeat(a)}\u2502`},n=`  \u2502  ${"\u2500".repeat(60)}\u2502`;console.log(""),console.log(o),console.log(s("\u{1F527} SOLID Refactorer  v1.0.0")),console.log(s("\u042D\u0442\u0430\u043B\u043E\u043D\u043D\u044B\u0439 \u0440\u0435\u0444\u0430\u043A\u0442\u043E\u0440\u0438\u043D\u0433 \u043F\u043E SOLID")),console.log(r),console.log(""),console.log(o),console.log(s("\u{1F4D6}  \u0418\u0421\u041F\u041E\u041B\u042C\u0417\u041E\u0412\u0410\u041D\u0418\u0415")),console.log(n),console.log(s("npx tsx solid-refactor/cli.ts [\u043E\u043F\u0446\u0438\u0438]")),console.log(s("")),console.log(s("\u041E\u041F\u0426\u0418\u0418:")),console.log(s("  --path <\u043F\u0443\u0442\u044C>        \u041F\u0443\u0442\u044C \u043A \u043F\u0440\u043E\u0435\u043A\u0442\u0443 (\u043F\u043E \u0443\u043C\u043E\u043B\u0447\u0430\u043D\u0438\u044E: cwd)")),console.log(s("  --analyze-only       \u041F\u043E\u043A\u0430\u0437\u0430\u0442\u044C god-\u0444\u0430\u0439\u043B\u044B")),console.log(s("  --dry-run            \u0410\u043D\u0430\u043B\u0438\u0437 + \u043F\u043B\u0430\u043D, \u0431\u0435\u0437 \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u0439")),console.log(s("  --target <\u0444\u0430\u0439\u043B>      \u0420\u0435\u0444\u0430\u043A\u0442\u043E\u0440\u0438\u0442\u044C \u043A\u043E\u043D\u043A\u0440\u0435\u0442\u043D\u044B\u0439 \u0444\u0430\u0439\u043B")),console.log(s("  --verbose            \u041F\u043E\u0434\u0440\u043E\u0431\u043D\u044B\u0439 \u0432\u044B\u0432\u043E\u0434")),console.log(s("  --auto-approve       \u0411\u0435\u0437 \u043F\u043E\u0434\u0442\u0432\u0435\u0440\u0436\u0434\u0435\u043D\u0438\u0439")),console.log(s("  --max-lines <N>      \u041F\u043E\u0440\u043E\u0433 \u0441\u0442\u0440\u043E\u043A (\u043F\u043E \u0443\u043C\u043E\u043B\u0447\u0430\u043D\u0438\u044E: 200)")),console.log(s("  --max-symbols <N>    \u041F\u043E\u0440\u043E\u0433 \u0441\u0438\u043C\u0432\u043E\u043B\u043E\u0432 (\u043F\u043E \u0443\u043C\u043E\u043B\u0447\u0430\u043D\u0438\u044E: 15)")),console.log(s("  --min-score <N>      \u041C\u0438\u043D. score (\u043F\u043E \u0443\u043C\u043E\u043B\u0447\u0430\u043D\u0438\u044E: 0.35)")),console.log(s("  --exts <ext1,ext2>   \u0420\u0430\u0441\u0448\u0438\u0440\u0435\u043D\u0438\u044F (\u043F\u043E \u0443\u043C\u043E\u043B\u0447\u0430\u043D\u0438\u044E: .ts,.tsx)")),console.log(n),console.log(s("\u041F\u0420\u0418\u041C\u0415\u0420\u042B:")),console.log(s("  --path ./src --analyze-only")),console.log(s("  --path ./src --dry-run --verbose")),console.log(s("  --path ./src --target index.ts --auto-approve")),console.log(r),console.log("")}var u={r:"\x1B[0m",b:"\x1B[1m",d:"\x1B[2m",red:"\x1B[31m",grn:"\x1B[32m",ylw:"\x1B[33m",blu:"\x1B[34m",mag:"\x1B[35m",cyn:"\x1B[36m",gry:"\x1B[90m"},b=62,y="  ",S=class{verbose;t0=Date.now();constructor(e=!1){this.verbose=e}info(e){this.tsLine("\xB7",e)}warn(e){this.tsLine(`${u.ylw}\u26A0${u.r}`,e)}error(e){this.tsLine(`${u.red}\u2716${u.r}`,`${u.red}${e}${u.r}`)}debug(e){this.verbose&&this.tsLine(`${u.gry}\xB7${u.r}`,`${u.gry}${e}${u.r}`)}success(e){this.tsLine(`${u.grn}\u2713${u.r}`,`${u.grn}${e}${u.r}`)}phase(e,t,o){let r=`${e}/${t}  ${o} `,s=Math.max(b-r.length-2,4);console.log(""),console.log(`${y} ${u.b}${r}${"\u2500".repeat(s)}${u.r}`)}progress(e,t,o){let r=Math.round(e/Math.max(t,1)*100),s=28,n=Math.round(s*r/100),i="\u2588".repeat(n)+"\u2591".repeat(s-n);process.stdout.write(`\r${y}${i} ${r}%  ${e}/${t}  ${o}  `),e>=t&&process.stdout.write(`
`)}boxTop(){console.log(`${y}\u250C${"\u2500".repeat(b)}\u2510`)}boxBot(){console.log(`${y}\u2514${"\u2500".repeat(b)}\u2518`)}boxLine(e){let t=this.strip(e),o=Math.max(b-2-t.length,0);console.log(`${y}\u2502  ${e}${" ".repeat(o)}\u2502`)}boxDiv(){console.log(`${y}\u2502  ${"\u2500".repeat(b-2)}\u2502`)}boxEmpty(){console.log(`${y}\u2502${" ".repeat(b)}\u2502`)}elapsed(){let e=Date.now()-this.t0;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(1)}s`}resetTimer(){this.t0=Date.now()}tsLine(e,t){let o=this.timestamp();console.log(`${y}${u.gry}${o}${u.r}  ${e}  ${t}`)}timestamp(){let e=new Date,t=String(e.getHours()).padStart(2,"0"),o=String(e.getMinutes()).padStart(2,"0"),r=String(e.getSeconds()).padStart(2,"0");return`${t}:${o}:${r}`}strip(e){return e.replace(/\x1b\[[0-9;]*m/g,"")}};import{readFileSync as U,readdirSync as re}from"node:fs";import{join as se,extname as ne}from"node:path";import{createHash as ie}from"node:crypto";var ae=/^[ \t]*import\s+(type\s+)?(?:\{([^}]*)\}|(\w+)(?:\s*,\s*\{([^}]*)\})?)\s+from\s+['"]([^'"]+)['"]/gm;var le=/^[ \t]*(export\s+)?(async\s+)?function\s+(\w+)\s*(?:<[^>]*>)?\s*\(([^)]*)\)(?:\s*:\s*([^\s{]+(?:\s*\|\s*[^\s{]+)*))?\s*\{/gm,ce=/^[ \t]*(export\s+)?(const|let)\s+(\w+)\s*(?::\s*[^=]+)?\s*=\s*(async\s+)?\([^)]*\)\s*(?::\s*[^=]+)?\s*=>/gm,pe=/^[ \t]*(export\s+)?(abstract\s+)?class\s+(\w+)(?:\s+extends\s+\w+)?(?:\s+implements\s+[\w,\s]+)?\s*\{/gm,de=/^[ \t]*(export\s+)?interface\s+(\w+)(?:\s+extends\s+[\w,\s]+)?\s*\{/gm,me=/^[ \t]*(export\s+)?type\s+(\w+)(?:<[^>]*>)?\s*=/gm,ge=/^[ \t]*(export\s+)?(const|let|var)\s+(\w+)\s*(?::\s*[^=]+)?\s*=/gm,v=class{logger;constructor(e){this.logger=e}analyzeFile(e){let t=U(e,"utf-8"),o=t.split(`
`),r=ie("md5").update(t).digest("hex"),s=this.extractSymbolsWithBodies(t,o),n=this.extractImports(t),i=this.extractExports(t,s);return{filePath:e,lineCount:o.length,symbolCount:s.length,symbols:s,imports:n,exports:i,fileHash:r}}analyzeProject(e,t){let o=this.collectFiles(e,t),r=[];for(let s of o)try{r.push(this.analyzeFile(s))}catch(n){this.logger.warn(`\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0440\u043E\u0430\u043D\u0430\u043B\u0438\u0437\u0438\u0440\u043E\u0432\u0430\u0442\u044C: ${s} \u2014 ${String(n)}`)}return r}getSymbolsWithBodies(e){let t=U(e,"utf-8");return this.extractSymbolsWithBodies(t,t.split(`
`))}extractSymbolsWithBodies(e,t){let o=[],r=new Set,s=new Set;for(let n of e.matchAll(new RegExp(ce.source,"gm"))){let i=this.getLineAt(e,n.index??0);if(!this.isTopLevel(t,i))continue;let a=n[3]??"anonymous";if(s.has(a))continue;r.add(a),s.add(a);let c=this.findArrowEnd(t,i);o.push(this.buildSymbol(a,"function",!!n[1],i,c,e,t))}for(let n of e.matchAll(new RegExp(le.source,"gm"))){let i=this.getLineAt(e,n.index??0);if(!this.isTopLevel(t,i))continue;let a=n[3]??"anonymous";if(s.has(a))continue;s.add(a);let c=this.findClosingBrace(t,i);o.push(this.buildSymbol(a,"function",!!n[1],i,c,e,t))}for(let n of e.matchAll(new RegExp(pe.source,"gm"))){let i=this.getLineAt(e,n.index??0);if(!this.isTopLevel(t,i))continue;let a=n[3]??"AnonymousClass";if(s.has(a))continue;s.add(a);let c=this.findClosingBrace(t,i);o.push(this.buildSymbol(a,"class",!!n[1],i,c,e,t))}for(let n of e.matchAll(new RegExp(de.source,"gm"))){let i=this.getLineAt(e,n.index??0);if(!this.isTopLevel(t,i))continue;let a=n[2]??"IUnknown";if(s.has(a))continue;s.add(a);let c=this.findClosingBrace(t,i);o.push(this.buildSymbol(a,"interface",!!n[1],i,c,e,t))}for(let n of e.matchAll(new RegExp(me.source,"gm"))){let i=this.getLineAt(e,n.index??0);if(!this.isTopLevel(t,i))continue;let a=n[2]??"UnknownType";if(s.has(a))continue;s.add(a);let c=this.findStatementEnd(t,i);o.push(this.buildSymbol(a,"type",!!n[1],i,c,e,t))}for(let n of e.matchAll(new RegExp(ge.source,"gm"))){let i=n[3]??"unknown";if(r.has(i))continue;let a=this.getLineAt(e,n.index??0);if(!this.isTopLevel(t,a)||s.has(i))continue;s.add(i);let c=n[2]==="const",p=this.findStatementEnd(t,a);o.push(this.buildSymbol(i,c?"constant":"variable",!!n[1],a,p,e,t))}return o}isTopLevel(e,t){let o=e[t]??"";return o.length-o.trimStart().length===0}buildSymbol(e,t,o,r,s,n,i){let a=i.slice(r,s+1).join(`
`),c=i[r]??"",p=this.findDocComment(i,r),d=this.findCalledSymbols(a),m=this.findThisProperties(a);return{name:e,type:t,isExported:o,body:a,docComment:p,signature:c.trim(),range:this.buildRange(r,s),calledSymbols:d,usedThisProps:m}}extractImports(e){let t=[];for(let o of e.matchAll(new RegExp(ae.source,"gm"))){let r=!!o[1],s=(o[2]??o[4]??"").split(",").map(c=>c.trim()).filter(Boolean),n=o[3]?[o[3]]:[],i=o[5]??"",a=this.getLineAt(e,o.index??0);t.push({source:i,symbols:[...n,...s],isTypeOnly:r,raw:o[0],line:a})}return t}extractExports(e,t){return t.filter(o=>o.isExported).map(o=>({name:o.name,isDefault:!1,isTypeOnly:o.type==="type"||o.type==="interface"}))}findCalledSymbols(e){let t=new Set,o=/(?:this\.)?(\w+)\s*\(/g;for(let r of e.matchAll(o)){let s=r[1];s&&!["if","for","while","switch","catch","return","new","typeof","await"].includes(s)&&t.add(s)}return[...t]}findThisProperties(e){let t=new Set,o=/this\.(\w+)/g;for(let r of e.matchAll(o))r[1]&&t.add(r[1]);return[...t]}findDocComment(e,t){let o=t-1;for(;o>=0&&e[o]?.trim()==="";)o--;if(o<0)return null;if(e[o]?.trim().endsWith("*/")){let r=o;for(;r>=0&&!e[r]?.trim().startsWith("/**");)r--;if(r>=0)return e.slice(r,o+1).map(s=>s.replace(/^\s*\*?\s?/,"").trim()).filter(Boolean).join(" ")}return null}getLineAt(e,t){let o=0;for(let r=0;r<t&&r<e.length;r++)e[r]===`
`&&o++;return o}findArrowEnd(e,t){for(let o=t;o<Math.min(t+20,e.length);o++){let r=e[o]??"",s=r.indexOf("=>");if(s===-1)continue;return r.slice(s+2).trim().startsWith("{")?this.findClosingBrace(e,o):this.findStatementEnd(e,t)}return this.findStatementEnd(e,t)}findStatementEnd(e,t){let o=0,r=0,s=0,n=null,i=!1,a=!1,c=[];for(let p=t;p<e.length;p++){let d=e[p]??"";for(let m=0;m<d.length;m++){let g=d[m]??"",f=d[m+1]??"";if(i){g==="*"&&f==="/"&&(i=!1,m++);continue}if(n){g===n&&!this.isEscaped(d,m)&&(n=null);continue}if(a){if(g==="`"&&!this.isEscaped(d,m)){a=!1;continue}if(g==="$"&&f==="{"&&!this.isEscaped(d,m)){c.push(o),a=!1,m++;continue}continue}if(g==="/"&&f==="/")break;if(g==="/"&&f==="*"){i=!0,m++;continue}if(g==='"'||g==="'"){n=g;continue}if(g==="`"){a=!0;continue}if(g==="("&&r++,g===")"&&r--,g==="["&&s++,g==="]"&&s--,g==="{"&&o++,g==="}"){if(c.length>0&&o===c[c.length-1]){c.pop(),a=!0;continue}if(o--,o===0&&r===0&&s===0)return p}if(g===";"&&o===0&&r===0&&s===0)return p}if(p>t&&o===0&&r===0&&s===0){let m=d.trimEnd();if(m.endsWith(";")||m==="")return p>t?p-1:p}}return this.logger.warn(`findStatementEnd: fallback \u043E\u0442 \u0441\u0442\u0440\u043E\u043A\u0438 ${t}`),Math.min(t+50,e.length-1)}isEscaped(e,t){let o=0,r=t-1;for(;r>=0&&e[r]==="\\";)o++,r--;return o%2===1}findClosingBrace(e,t){let o=0,r=!1,s=null,n=!1,i=!1,a=[];for(let c=t;c<e.length;c++){let p=e[c]??"";for(let d=0;d<p.length;d++){let m=p[d]??"",g=p[d+1]??"";if(n){m==="*"&&g==="/"&&(n=!1,d++);continue}if(s){m===s&&!this.isEscaped(p,d)&&(s=null);continue}if(i){if(m==="`"&&!this.isEscaped(p,d)){i=!1;continue}if(m==="$"&&g==="{"&&!this.isEscaped(p,d)){a.push(o),i=!1,d++;continue}continue}if(m==="/"&&g==="/")break;if(m==="/"&&g==="*"){n=!0,d++;continue}if(m==='"'||m==="'"){s=m;continue}if(m==="`"){i=!0;continue}if(m==="{"&&(o++,r=!0),m==="}"){if(a.length>0&&o===a[a.length-1]){a.pop(),i=!0;continue}if(o--,r&&o===0)return c}}}return this.logger.warn(`findClosingBrace: fallback \u043E\u0442 \u0441\u0442\u0440\u043E\u043A\u0438 ${t}`),Math.min(t+50,e.length-1)}buildRange(e,t){return{start:{line:e,column:0},end:{line:t,column:0}}}collectFiles(e,t){let o=[],r=new Set(["node_modules","dist",".git","build","coverage","out"]),s=n=>{for(let i of re(n,{withFileTypes:!0})){let a=se(n,i.name);i.isDirectory()&&!r.has(i.name)&&!i.name.startsWith(".")?s(a):i.isFile()&&t.includes(ne(i.name).toLowerCase())&&o.push(a)}};return s(e),o}};var fe={maxLines:200,maxSymbols:15,maxResponsibilities:3,minGodScore:.4,criticalThreshold:.7,warningThreshold:.5},$=class{logger;thresholds;constructor(e){this.logger=e,this.thresholds=fe}setThresholds(e){this.thresholds=e}detect(e){let t=[];for(let o of e){let r=this.score(o);if(r.total>=this.thresholds.minGodScore){let s=this.classifySeverity(r.total);t.push({filePath:o.filePath,analysis:o,godScore:r,severity:s}),this.logger.debug(`God-\u0444\u0430\u0439\u043B: ${o.filePath} (score=${r.total.toFixed(2)}, severity=${s})`)}}return t.sort((o,r)=>r.godScore.total-o.godScore.total)}score(e){let t=this.scoreLines(e.lineCount),o=this.scoreSymbols(e.symbolCount),r=this.scoreResponsibilities(e),s=this.scoreCoupling(e),n=t*.25+o*.25+r*.35+s*.15;return{lineScore:t,symbolScore:o,responsibilityScore:r,couplingScore:s,total:n}}scoreLines(e){let t=this.thresholds.maxLines;return e<=t?0:this.sigmoid(e,t,t*3)}scoreSymbols(e){let t=this.thresholds.maxSymbols;return e<=t?0:this.sigmoid(e,t,t*3)}scoreResponsibilities(e){let t=new Set(e.imports.map(n=>n.source)),o=new Set(e.symbols.flatMap(n=>n.usedThisProps)),r=Math.max(t.size,Math.ceil(o.size/3),1),s=this.thresholds.maxResponsibilities;return r<=s?0:this.sigmoid(r,s,s*4)}scoreCoupling(e){if(e.symbols.length<3)return 0;let t=new Set(e.symbols.flatMap(i=>i.calledSymbols)),o=new Set(e.symbols.map(i=>i.name)),r=[...t].filter(i=>o.has(i)),s=e.symbols.length*(e.symbols.length-1)/2;if(s===0)return 0;let n=r.length/s;return Math.max(0,1-n*2)}sigmoid(e,t,o){let r=(e-t)/(o-t);return Math.min(1,Math.max(0,r))}classifySeverity(e){return e>=this.thresholds.criticalThreshold?"critical":e>=this.thresholds.warningThreshold?"warning":"info"}};var R=class{logger;constructor(e){this.logger=e}buildSymbolGraph(e,t){let o=new Set(t.map(a=>a.name)),r=new Map,s=[];for(let a of t){let c=a.calledSymbols.filter(p=>o.has(p)&&p!==a.name);r.set(a.name,{name:a.name,type:a.type,calls:c,calledBy:[],thisProperties:[...a.usedThisProps],importedFrom:[]})}for(let a of t)for(let c of a.calledSymbols){let p=r.get(c);p&&c!==a.name&&r.set(c,{...p,calledBy:[...p.calledBy,a.name]})}for(let a of t)for(let c of a.calledSymbols)o.has(c)&&c!==a.name&&s.push({from:a.name,to:c,edgeType:"call",weight:1});let n=this.buildThisEdges(t,o);s.push(...n);let i=this.findSharedState(t);return this.logger.debug(`\u0413\u0440\u0430\u0444 \u0441\u0438\u043C\u0432\u043E\u043B\u043E\u0432 ${e}: ${r.size} \u043D\u043E\u0434, ${s.length} \u0440\u0451\u0431\u0435\u0440`),{nodes:r,edges:s,sharedState:i,externalImports:new Map}}findCallsites(e,t){return t.filter(o=>o.calledSymbols.includes(e)&&o.name!==e).map(o=>o.name)}findSharedState(e){let t=new Map;for(let r of e)for(let s of r.usedThisProps){let n=t.get(s)??[];n.push(r.name),t.set(s,n)}let o=new Map;for(let[r,s]of t)s.length>1&&o.set(r,s);return o}buildThisEdges(e,t){let o=[],r=new Set;for(let s=0;s<e.length;s++)for(let n=s+1;n<e.length;n++){let i=e[s],a=e[n],c=i.usedThisProps.filter(m=>a.usedThisProps.includes(m));if(c.length===0)continue;let p=`${i.name}\u2192${a.name}:this-access`;if(r.has(p))continue;r.add(p);let d=c.length/Math.max(i.usedThisProps.length,a.usedThisProps.length,1);o.push({from:i.name,to:a.name,edgeType:"this-access",weight:d})}return o}};var w=class{logger;constructor(e){this.logger=e}clusterize(e,t){let o=e.analysis.symbols,r=new Map(o.map(a=>[a.name,a])),s=new Map;for(let a of o)s.set(a.name,a.name);for(let a of t.edges)a.weight>=.1&&this.union(s,a.from,a.to);for(let[a,c]of t.sharedState)if(c.length>1){let p=c[0];for(let d=1;d<c.length;d++)this.union(s,p,c[d])}let n=new Map;for(let a of o){let c=this.find(s,a.name),p=n.get(c)??[];p.push(a),n.set(c,p)}let i=[];for(let[a,c]of n){if(c.length<1)continue;let p=this.buildCluster(c,t,e.analysis.imports);i.push(p)}return this.logger.debug(`\u041A\u043B\u0430\u0441\u0442\u0435\u0440\u0438\u0437\u0430\u0446\u0438\u044F ${e.filePath}: ${i.length} \u043A\u043B\u0430\u0441\u0442\u0435\u0440\u043E\u0432`),i.sort((a,c)=>c.linesCount-a.linesCount)}suggestName(e){let t=e.filter(i=>i.type==="class");if(t.length===1)return this.toKebab(t[0].name);let o=e.filter(i=>i.type==="interface");if(o.length===1)return this.toKebab(o[0].name.replace(/^I/,""));let r=e.map(i=>i.name),s=this.longestCommonPrefix(r);if(s.length>=3)return this.toKebab(s);let n=e.reduce((i,a)=>i.body.length>a.body.length?i:a,e[0]);return this.toKebab(n.name)}measureCohesion(e,t){if(e.length<=1)return 1;let o=new Set(e.map(n=>n.name)),r=0;for(let n of t.edges)o.has(n.from)&&o.has(n.to)&&r++;let s=e.length*(e.length-1)/2;return s>0?r/s:0}buildCluster(e,t,o){let r=new Set(e.map(p=>p.name)),s=new Set;for(let p of e)for(let d of p.usedThisProps)s.add(d);let n=new Set;for(let p of e)for(let d of p.calledSymbols)r.has(d)&&d!==p.name&&n.add(d);let i=this.collectExternalImports(e,o),a=e.reduce((p,d)=>p+d.body.split(`
`).length,0),c=this.measureCohesion(e,t);return{suggestedName:this.suggestName(e),symbols:e,sharedState:[...s],internalDeps:[...n],externalImports:i,cohesionScore:c,linesCount:a}}collectExternalImports(e,t){let o=new Set(e.flatMap(s=>[...s.calledSymbols,...s.usedThisProps])),r=new Set;for(let s of t)s.symbols.some(n=>o.has(n))&&r.add(s.source);return[...r]}find(e,t){let o=e.get(t)??t;for(;o!==(e.get(o)??o);)o=e.get(o)??o;let r=t;for(;r!==o;){let s=e.get(r)??r;e.set(r,o),r=s}return o}union(e,t,o){let r=this.find(e,t),s=this.find(e,o);r!==s&&e.set(s,r)}toKebab(e){return e.replace(/([a-z0-9])([A-Z])/g,"$1-$2").replace(/([A-Z])([A-Z][a-z])/g,"$1-$2").toLowerCase().replace(/[^a-z0-9-]/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")}longestCommonPrefix(e){if(e.length===0)return"";let t=e[0]??"";for(let o=1;o<e.length;o++){let r=e[o]??"";for(;!r.startsWith(t)&&t.length>0;)t=t.slice(0,-1)}return t}};import{readFileSync as W,readdirSync as ue}from"node:fs";import{join as he,dirname as L,relative as ye,extname as Ie,resolve as k,sep as be,posix as xe}from"node:path";var Se=new Set([".ts",".tsx",".js",".jsx"]),ve=new Set(["node_modules","dist",".git","build","coverage","out"]),E=class{logger;constructor(e){this.logger=e}resolve(e,t){let o=L(t);return e.startsWith(".")?k(o,e):e}findAllConsumers(e,t){let o=this.collectAllFiles(t),r=[],s=this.buildImportVariants(e);for(let n of o)if(n!==e)try{let i=W(n,"utf-8");this.fileImports(i,n,e,s)&&r.push(n)}catch{}return this.logger.debug(`\u041F\u043E\u0442\u0440\u0435\u0431\u0438\u0442\u0435\u043B\u0438 ${e}: \u043D\u0430\u0439\u0434\u0435\u043D\u043E ${r.length}`),r}findUsedSymbolsFrom(e,t){try{let o=W(e,"utf-8"),r=L(e),s=t.replace(/\.(ts|tsx|js|jsx)$/,""),n=/import\s+(?:type\s+)?(?:\{([^}]*)\}|(\w+)(?:\s*,\s*\{([^}]*)\})?)\s+from\s+['"]([^'"]+)['"]/g,i=[];for(let a of o.matchAll(n)){let c=a[4]??"";if(!c.startsWith("."))continue;let p=k(r,c);if(p.replace(/\.(ts|tsx|js|jsx)$/,"")===s||p===t){let m=(a[1]??a[3]??"").split(",").map(f=>f.trim()).filter(Boolean),g=a[2]?[a[2]]:[];i.push(...g,...m)}}return i}catch{return[]}}computeNewPath(e,t){let o=L(e),r=ye(o,t);return r=r.split(be).join(xe.sep),r=r.replace(/\.(ts|tsx|js|jsx)$/,""),r.startsWith(".")||(r="./"+r),r+=".js",r}buildImportVariants(e){let t=[],o=e.replace(/\.(ts|tsx|js|jsx)$/,"");return t.push(e),t.push(o),t.push(o+".js"),t.push(o+".ts"),t}fileImports(e,t,o,r){if(!e.includes("from ")&&!e.includes("require("))return!1;let s=/(?:from\s+['"]([^'"]+)['"]|require\(['"]([^'"]+)['"]\))/g,n=L(t);for(let i of e.matchAll(s)){let a=i[1]??i[2];if(!a||!a.startsWith("."))continue;let c=k(n,a),p=c.replace(/\.(ts|tsx|js|jsx)$/,""),d=o.replace(/\.(ts|tsx|js|jsx)$/,"");if(p===d||c===o)return!0}return!1}collectAllFiles(e){let t=[],o=r=>{try{for(let s of ue(r,{withFileTypes:!0})){let n=he(r,s.name);s.isDirectory()&&!ve.has(s.name)&&!s.name.startsWith(".")?o(n):s.isFile()&&Se.has(Ie(s.name).toLowerCase())&&t.push(n)}}catch{}};return o(e),t}};import{dirname as $e,join as V,basename as H,posix as Re,sep as we}from"node:path";var T=class{importResolver;logger;constructor(e,t){this.importResolver=e,this.logger=t}createPlan(e,t,o,r){let s=$e(e.filePath),n=H(e.filePath,".ts"),i=V(s,n),a=t.map((g,f)=>this.buildTarget(g,i,e,f)),c=this.importResolver.findAllConsumers(e.filePath,r),p=this.buildConsumerUpdates(c,e,a),d=a.map(g=>{let f=g.targetPath.split(we).join(Re.sep);return`./${H(f,".ts")}.js`}),m=this.computeImpact(a,p);return this.logger.info(`\u041F\u043B\u0430\u043D: ${a.length} \u043C\u043E\u0434\u0443\u043B\u0435\u0439, ${m.consumersAffected} \u043F\u043E\u0442\u0440\u0435\u0431\u0438\u0442\u0435\u043B\u0435\u0439, ${m.totalSymbolsMoved} \u0441\u0438\u043C\u0432\u043E\u043B\u043E\u0432`),{sourceFile:e.filePath,targets:a,barrelExports:d,consumerUpdates:p,impact:m,createdAt:Date.now()}}estimateImpact(e){return e.impact.consumersAffected*2+e.impact.filesCreated}buildTarget(e,t,o,r){let s=`${e.suggestedName}.ts`,n=V(t,s),i=this.resolveClusterImports(e,o),a=e.symbols.filter(p=>p.isExported).map(p=>p.name),c=e.linesCount+i.length*2+5;return{targetPath:n,symbols:e.symbols,imports:i,exports:a,estimatedLines:c}}resolveClusterImports(e,t){let o=t.analysis.imports,r=new Set(e.symbols.flatMap(i=>[...i.calledSymbols,...i.usedThisProps])),s=new Map;for(let i of o){let a=i.symbols.filter(p=>r.has(p));if(a.length===0)continue;let c=s.get(i.source);if(c){for(let p of a)c.symbols.add(p);i.isTypeOnly||(c.isTypeOnly=!1)}else s.set(i.source,{symbols:new Set(a),isTypeOnly:i.isTypeOnly})}let n=[];for(let[i,a]of s)n.push({source:i,symbols:[...a.symbols],isTypeOnly:a.isTypeOnly});return n}buildConsumerUpdates(e,t,o){let r=[],s=new Map;for(let n of o)for(let i of n.exports)s.set(i,n);for(let n of e){let i=this.importResolver.findUsedSymbolsFrom(n,t.filePath);if(i.length===0)continue;let a=new Map;for(let c of i){let p=s.get(c);if(!p)continue;let d=p.targetPath,m=a.get(d)??[];m.push(c),a.set(d,m)}for(let[c,p]of a){let d=this.importResolver.computeNewPath(n,c);r.push({consumerFile:n,oldImportPath:this.computeRelPath(n,t.filePath),newImportPath:d,importedSymbols:p,isTypeOnly:!1})}}return r}computeRelPath(e,t){return this.importResolver.computeNewPath(e,t)}computeImpact(e,t){let o=new Set(t.map(s=>s.consumerFile)),r=e.reduce((s,n)=>s+n.symbols.length,0);return{filesCreated:e.length+1,filesModified:o.size,filesDeleted:1,totalSymbolsMoved:r,consumersAffected:o.size}}};import{existsSync as Le,readFileSync as Ee}from"node:fs";import{basename as x}from"node:path";var C=class{logger;constructor(e){this.logger=e}validate(e,t,o=200){let r=[],s=[];this.checkEmptyTargets(e.targets,r),this.checkFileNameConflicts(e.targets,r),this.checkDuplicateSymbols(e.targets,r);let n=this.checkCircularDeps(e.targets);for(let c of n)s.push({code:"CIRCULAR_DEP",message:`\u0426\u0438\u043A\u043B\u0438\u0447\u0435\u0441\u043A\u0430\u044F \u0437\u0430\u0432\u0438\u0441\u0438\u043C\u043E\u0441\u0442\u044C: ${c}`,file:e.sourceFile,severity:"warning"});let i=this.checkExportIntegrity(e);for(let c of i)r.push({code:"MISSING_EXPORT",message:`\u041F\u043E\u0442\u0435\u0440\u044F\u043D \u044D\u043A\u0441\u043F\u043E\u0440\u0442: ${c}`,file:e.sourceFile,severity:"critical"});this.checkExistingFiles(e.targets,s),this.checkTargetSizes(e.targets,s,o);let a=r.length===0;return this.logger.debug(`\u0412\u0430\u043B\u0438\u0434\u0430\u0446\u0438\u044F \u043F\u043B\u0430\u043D\u0430: ${a?"OK":"FAIL"} (${r.length} \u043E\u0448\u0438\u0431\u043E\u043A, ${s.length} \u043F\u0440\u0435\u0434\u0443\u043F\u0440\u0435\u0436\u0434\u0435\u043D\u0438\u0439)`),{isValid:a,errors:r,warnings:s}}checkCircularDeps(e){let t=[],o=new Map;for(let i of e){let a=new Set,c=new Set(i.symbols.map(p=>p.name));for(let p of i.symbols)for(let d of p.calledSymbols)if(!c.has(d)){for(let m of e)if(m!==i&&m.symbols.some(g=>g.name===d)){a.add(m.targetPath);break}}o.set(i.targetPath,a)}let r=new Set,s=new Set,n=(i,a)=>{if(s.has(i)){let c=a.indexOf(i),p=a.slice(c).map(d=>x(d,".ts")).join(" \u2192 ");t.push(`${p} \u2192 ${x(i,".ts")}`);return}if(!r.has(i)){r.add(i),s.add(i),a.push(i);for(let c of o.get(i)??[])n(c,[...a]);s.delete(i)}};for(let i of e)n(i.targetPath,[]);return t}checkExportIntegrity(e){let t=this.extractOriginalExports(e.sourceFile),o=new Set(e.targets.flatMap(r=>r.exports));return t.filter(r=>!o.has(r))}extractOriginalExports(e){try{let t=Ee(e,"utf-8"),o=[],r=/^[ \t]*export\s+(?:default\s+)?(?:type|interface|class|function|const|let|var|async|abstract)\s+(\w+)/gm;for(let s of t.matchAll(r))s[1]&&o.push(s[1]);return o}catch{return this.logger.warn(`\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0440\u043E\u0447\u0438\u0442\u0430\u0442\u044C \u0444\u0430\u0439\u043B \u0434\u043B\u044F \u043F\u0440\u043E\u0432\u0435\u0440\u043A\u0438 \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u043E\u0432: ${e}`),[]}}checkEmptyTargets(e,t){for(let o of e)o.symbols.length===0&&t.push({code:"EMPTY_TARGET",message:`\u041F\u0443\u0441\u0442\u043E\u0439 \u043C\u043E\u0434\u0443\u043B\u044C: ${x(o.targetPath)}`,file:o.targetPath,severity:"critical"})}checkFileNameConflicts(e,t){let o=new Set;for(let r of e)o.has(r.targetPath)&&t.push({code:"DUPLICATE_PATH",message:`\u0414\u0443\u0431\u043B\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u0435 \u043F\u0443\u0442\u0438: ${r.targetPath}`,file:r.targetPath,severity:"critical"}),o.add(r.targetPath)}checkDuplicateSymbols(e,t){let o=new Map;for(let r of e)for(let s of r.symbols){let n=o.get(s.name);n&&t.push({code:"DUPLICATE_SYMBOL",message:`\u0421\u0438\u043C\u0432\u043E\u043B "${s.name}" \u043F\u0440\u0438\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u0435\u0442 \u0432 "${x(n)}" \u0438 "${x(r.targetPath)}"`,file:r.targetPath,severity:"critical"}),o.set(s.name,r.targetPath)}}checkExistingFiles(e,t){for(let o of e)Le(o.targetPath)&&t.push({code:"FILE_EXISTS",message:`\u0424\u0430\u0439\u043B \u0443\u0436\u0435 \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u0435\u0442: ${o.targetPath}`,file:o.targetPath,severity:"warning"})}checkTargetSizes(e,t,o){for(let r of e)r.estimatedLines>o&&t.push({code:"TARGET_TOO_LARGE",message:`\u041C\u043E\u0434\u0443\u043B\u044C ${x(r.targetPath)} \u2248${r.estimatedLines} \u0441\u0442\u0440\u043E\u043A (\u043F\u043E\u0440\u043E\u0433: ${o})`,file:r.targetPath,severity:"warning"})}};var P=class{logger;constructor(e){this.logger=e}extractSymbolCode(e,t){let o=e.split(`
`),r=t.range.start.line,s=t.range.end.line,n=this.extractDocComment(o,r),i=o.slice(r,s+1);return[...n,...i].join(`
`)}extractImportsForSymbols(e,t){let o=this.collectUsedIdentifiers(t),r=[];for(let s of e){let n=s.symbols.filter(i=>o.has(i));n.length!==0&&r.push({source:s.source,symbols:n,isTypeOnly:s.isTypeOnly,raw:this.rebuildImportLine(n,s.source,s.isTypeOnly),line:s.line})}return this.logger.debug(`\u0418\u0437\u0432\u043B\u0435\u0447\u0435\u043D\u043E ${r.length} \u0438\u043C\u043F\u043E\u0440\u0442\u043E\u0432 \u0434\u043B\u044F ${t.length} \u0441\u0438\u043C\u0432\u043E\u043B\u043E\u0432`),r}extractDocComment(e,t){let o=t-1;for(;o>=0&&(e[o]??"").trim()==="";)o--;if(o<0)return[];if(!(e[o]??"").trim().endsWith("*/"))return[];let s=o;for(;s>=0&&!(e[s]??"").trim().startsWith("/**");)s--;return s<0?[]:e.slice(s,o+1).map(n=>n)}collectUsedIdentifiers(e){let t=new Set;for(let o of e){for(let s of o.calledSymbols)t.add(s);let r=this.scanBodyIdentifiers(o.body);for(let s of r)t.add(s)}return t}scanBodyIdentifiers(e){let t=new Set,o=/\b([A-Z][a-zA-Z0-9]+|[a-z][a-zA-Z0-9]+)\b/g,r=new Set(["if","else","for","while","do","switch","case","break","continue","return","throw","try","catch","finally","new","delete","typeof","instanceof","void","this","class","interface","type","enum","extends","implements","import","export","default","from","as","async","await","const","let","var","function","true","false","null","undefined","string","number","boolean","object","any","unknown","never","void","readonly","private","public","protected","static","abstract","override"]);for(let s of e.matchAll(o)){let n=s[1]??"";n.length>=2&&!r.has(n)&&t.add(n)}return t}rebuildImportLine(e,t,o){let r=o?"type ":"",s=e.join(", ");return`import ${r}{ ${s} } from '${t}';`}};import{basename as Te}from"node:path";var Ce=(l,e)=>`/**
 * ${l} \u2014 \u043C\u043E\u0434\u0443\u043B\u044C, \u0441\u043E\u0434\u0435\u0440\u0436\u0430\u0449\u0438\u0439 ${e} \u0441\u0438\u043C\u0432\u043E\u043B(\u043E\u0432).
 * \u0421\u043E\u0437\u0434\u0430\u043D \u0430\u0432\u0442\u043E\u043C\u0430\u0442\u0438\u0447\u0435\u0441\u043A\u0438 SOLID Refactorer.
 */
`,F=class{codeExtractor;logger;constructor(e,t){this.codeExtractor=e,this.logger=t}generate(e,t,o){let r=Te(e.targetPath,".ts"),s=[];s.push(Ce(r,e.symbols.length));let n=this.buildImportLines(e.imports,o,e.symbols);n.length>0&&(s.push(n.join(`
`)),s.push(""));for(let a of e.symbols){let c=this.codeExtractor.extractSymbolCode(t,a),p=this.ensureExport(c,a);s.push(p),s.push("")}let i=s.join(`
`).trimEnd()+`
`;return this.logger.debug(`\u0421\u0433\u0435\u043D\u0435\u0440\u0438\u0440\u043E\u0432\u0430\u043D \u043C\u043E\u0434\u0443\u043B\u044C: ${r} (${i.split(`
`).length} \u0441\u0442\u0440\u043E\u043A)`),{path:e.targetPath,content:i,isNew:!0}}buildImportLines(e,t,o){let r=this.collectAllUsedIdentifiers(o),s=new Map,n=(a,c,p)=>{let d=c.filter(g=>r.has(g));if(d.length===0)return;let m=s.get(a);if(m){for(let g of d)m.symbols.add(g);p||(m.isTypeOnly=!1)}else s.set(a,{symbols:new Set(d),isTypeOnly:p})};for(let a of e)n(a.source,a.symbols,a.isTypeOnly);for(let a of t)n(a.source,a.symbols,a.isTypeOnly);let i=[];for(let[a,c]of s){let p=c.isTypeOnly?"type ":"",d=[...c.symbols].sort();i.push(`import ${p}{ ${d.join(", ")} } from '${a}';`)}return i}collectAllUsedIdentifiers(e){let t=new Set,o=new Set(["if","else","for","while","do","switch","case","break","continue","return","throw","try","catch","finally","new","delete","typeof","instanceof","void","this","class","interface","type","enum","extends","implements","import","export","default","from","as","async","await","const","let","var","function","true","false","null","undefined","string","number","boolean","object","any","unknown","never","readonly","private","public","protected","static","abstract","override"]);for(let r of e){for(let n of r.calledSymbols)t.add(n);for(let n of r.usedThisProps)t.add(n);let s=/\b([A-Za-z][a-zA-Z0-9]{1,})\b/g;for(let n of r.body.matchAll(s)){let i=n[1]??"";i.length>=2&&!o.has(i)&&t.add(i)}}return t}ensureExport(e,t){return!t.isExported||e.trimStart().startsWith("export ")?e:e.replace(/^(\s*)(async\s+)?(function|class|interface|type|const|let|var|abstract)/m,"$1export $2$3")}};var A=class{logger;constructor(e){this.logger=e}rewriteFile(e,t,o){let r=t,s=this.groupByOldPath(o);for(let[n,i]of s)r=this.rewriteImportGroup(r,n,i);return{path:e,content:r,isNew:!1}}findImportsFrom(e,t){let o=[],r=e.split(`
`),s=t.replace(/\.(ts|tsx|js|jsx)$/,"");for(let n=0;n<r.length;n++){let i=r[n]??"",a=i.match(/^[ \t]*import\s+(type\s+)?(?:\{([^}]*)\}|(\w+))\s+from\s+['"]([^'"]+)['"]/);if(!a)continue;let c=a[4]??"";if(c.replace(/\.(ts|tsx|js|jsx)$/,"")===s||c===t){let d=!!a[1],m=(a[2]??"").split(",").map(f=>f.trim()).filter(Boolean),g=a[3]?[a[3]]:[];o.push({source:c,symbols:[...g,...m],isTypeOnly:d,raw:i.trim(),line:n})}}return o}groupByOldPath(e){let t=new Map;for(let o of e){let r=t.get(o.oldImportPath)??[];r.push(o),t.set(o.oldImportPath,r)}return t}rewriteImportGroup(e,t,o){let r=e.split(`
`),s=t.replace(/\.(ts|tsx|js|jsx)$/,""),n=[],i="";for(let p=0;p<r.length;p++){let d=r[p]??"",m=d.match(/from\s+['"]([^'"]+)['"]/);if(!m)continue;(m[1]??"").replace(/\.(ts|tsx|js|jsx)$/,"")===s&&(n.push(p),i||(i=d))}if(n.length===0)return e;let a=this.buildNewImportLines(o,i),c=[...r];for(let p=n.length-1;p>=0;p--){let d=n[p];p===0?c.splice(d,1,...a):c.splice(d,1)}return c.join(`
`)}buildNewImportLines(e,t){let o=[],r=t.match(/^(\s*)/)?.[1]??"",s=t.includes("import type");for(let n of e){let i=n.isTypeOnly?"type ":"",a=n.importedSymbols.join(", ");o.push(`${r}import ${i}{ ${a} } from '${n.newImportPath}';`)}return o}};import{basename as Z,dirname as X,relative as Pe,posix as Fe,sep as Ae}from"node:path";var j=class{logger;constructor(e){this.logger=e}generate(e,t){let o=Z(e,".ts"),r=X(t[0]?.targetPath??e),s=e,n=[];n.push("/**"),n.push(" * Barrel-\u0444\u0430\u0439\u043B: re-export \u0438\u0437 \u0440\u0430\u0437\u0431\u0438\u0442\u044B\u0445 \u043C\u043E\u0434\u0443\u043B\u0435\u0439."),n.push(` * \u041E\u0440\u0438\u0433\u0438\u043D\u0430\u043B\u044C\u043D\u044B\u0439 \u0444\u0430\u0439\u043B: ${o}.ts`),n.push(" * \u0421\u043E\u0437\u0434\u0430\u043D \u0430\u0432\u0442\u043E\u043C\u0430\u0442\u0438\u0447\u0435\u0441\u043A\u0438 SOLID Refactorer."),n.push(" */"),n.push("");for(let a of t){let c=Z(a.targetPath,".ts"),p=this.computeRelativePath(e,a.targetPath);if(a.exports.length===0)n.push(`export * from '${p}';`);else{let d=a.exports.join(", ");n.push(`export { ${d} } from '${p}';`)}}n.push("");let i=n.join(`
`);return this.logger.debug(`Barrel: ${s} \u2014 ${t.length} re-export'\u043E\u0432`),{path:s,content:i,isNew:!1}}computeRelativePath(e,t){let o=X(e),r=Pe(o,t);return r=r.split(Ae).join(Fe.sep),r=r.replace(/\.(ts|tsx)$/,""),r.startsWith(".")||(r="./"+r),r+=".js",r}};import{execSync as je}from"node:child_process";import{join as Ge}from"node:path";import{existsSync as De}from"node:fs";var G=class{logger;constructor(e){this.logger=e}check(e){let t=this.findTsConfig(e);if(!t)return this.logger.warn("tsconfig.json \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D \u2014 \u043F\u0440\u043E\u043F\u0443\u0441\u043A\u0430\u0435\u043C \u043F\u0440\u043E\u0432\u0435\u0440\u043A\u0443 \u043A\u043E\u043C\u043F\u0438\u043B\u044F\u0446\u0438\u0438"),{success:!0,errors:[],duration:0};let o=Date.now();this.logger.info("\u0417\u0430\u043F\u0443\u0441\u043A tsc --noEmit...");try{let r=`npx tsc --noEmit --project "${t}"`;je(r,{cwd:e,encoding:"utf-8",stdio:["pipe","pipe","pipe"],timeout:6e4});let s=Date.now()-o;return this.logger.success(`\u041A\u043E\u043C\u043F\u0438\u043B\u044F\u0446\u0438\u044F OK (${s}ms)`),{success:!0,errors:[],duration:s}}catch(r){let s=Date.now()-o,n=this.extractErrorOutput(r),i=this.parseTscErrors(n);return this.logger.error(`\u041A\u043E\u043C\u043F\u0438\u043B\u044F\u0446\u0438\u044F FAIL: ${i.length} \u043E\u0448\u0438\u0431\u043E\u043A (${s}ms)`),{success:!1,errors:i,duration:s}}}parseTscErrors(e){let t=[],o=/^(.+)\((\d+),(\d+)\):\s*(error|warning)\s+(TS\d+):\s*(.+)$/gm;for(let s of e.matchAll(o))t.push({file:s[1]??"",line:parseInt(s[2]??"0",10),column:parseInt(s[3]??"0",10),code:s[5]??"",message:s[6]??""});let r=/^(.+):(\d+):(\d+)\s*-\s*(error|warning)\s+(TS\d+):\s*(.+)$/gm;for(let s of e.matchAll(r))t.find(i=>i.file===s[1]&&i.line===parseInt(s[2]??"0",10))||t.push({file:s[1]??"",line:parseInt(s[2]??"0",10),column:parseInt(s[3]??"0",10),code:s[5]??"",message:s[6]??""});return t}findTsConfig(e){let t=["tsconfig.json","tsconfig.build.json"];for(let o of t){let r=Ge(e,o);if(De(r))return r}return null}extractErrorOutput(e){if(e&&typeof e=="object"){let t=e,o=t.stderr,r=t.stdout;if(typeof o=="string"&&o.length>0)return o;if(typeof r=="string"&&r.length>0)return r;if(typeof t.message=="string")return t.message}return String(e)}};import{readFileSync as Oe,writeFileSync as Me,existsSync as D,mkdirSync as Be,unlinkSync as ke,rmdirSync as Ne}from"node:fs";import{dirname as K}from"node:path";import{randomUUID as _e}from"node:crypto";var O=class{logger;snapshots=new Map;constructor(e){this.logger=e}createSnapshot(e){let t=new Map,o=0;for(let n of e)if(D(n)){let i=Oe(n,"utf-8");t.set(n,i),o++}else t.set(n,"___FILE_NOT_EXISTS___");let r=_e().slice(0,8),s={id:r,files:t,createdAt:Date.now()};return this.snapshots.set(r,s),this.logger.info(`\u0421\u043D\u0438\u043C\u043E\u043A \u0441\u043E\u0437\u0434\u0430\u043D: ${r} (${o} \u0444\u0430\u0439\u043B\u043E\u0432)`),s}rollback(e){this.logger.warn(`\u041E\u0442\u043A\u0430\u0442 \u043A \u0441\u043D\u0438\u043C\u043A\u0443 ${e.id}...`);let t=0,o=0;for(let[r,s]of e.files)try{s==="___FILE_NOT_EXISTS___"?D(r)&&(ke(r),o++):(this.ensureDir(r),Me(r,s,"utf-8"),t++)}catch(n){this.logger.error(`\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C: ${r} \u2014 ${String(n)}`)}this.cleanupEmptyDirs(e),this.logger.info(`\u041E\u0442\u043A\u0430\u0442 \u0437\u0430\u0432\u0435\u0440\u0448\u0451\u043D: ${t} \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u043E, ${o} \u0443\u0434\u0430\u043B\u0435\u043D\u043E`)}commit(e){this.snapshots.delete(e.id),this.logger.debug(`\u0421\u043D\u0438\u043C\u043E\u043A ${e.id} \u0437\u0430\u0444\u0438\u043A\u0441\u0438\u0440\u043E\u0432\u0430\u043D (\u0443\u0434\u0430\u043B\u0451\u043D \u0438\u0437 \u043F\u0430\u043C\u044F\u0442\u0438)`)}ensureDir(e){let t=K(e);D(t)||Be(t,{recursive:!0})}cleanupEmptyDirs(e){let t=new Set;for(let[o,r]of e.files)r==="___FILE_NOT_EXISTS___"&&t.add(K(o));for(let o of t)try{D(o)&&(Ne(o),this.logger.debug(`\u0423\u0434\u0430\u043B\u0435\u043D\u0430 \u043F\u0443\u0441\u0442\u0430\u044F \u0434\u0438\u0440\u0435\u043A\u0442\u043E\u0440\u0438\u044F: ${o}`))}catch{}}};import{readFileSync as Y,writeFileSync as ze,mkdirSync as Ue,existsSync as We}from"node:fs";import{dirname as Ve,relative as q,basename as J}from"node:path";var M=class{deps;constructor(e){this.deps=e}runFullRefactor(e){let t=Date.now(),{logger:o}=this.deps;o.phase(1,5,"\u0410\u041D\u0410\u041B\u0418\u0417");let s=this.analyzeOnly(e).reports;if(s.length===0)return o.success("God-\u0444\u0430\u0439\u043B\u044B \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u044B. \u041F\u0440\u043E\u0435\u043A\u0442 \u0447\u0438\u0441\u0442!"),this.buildResult("analyze",0,0,[],[],[],t);let n=e.target?s.filter(f=>f.godFile.filePath.includes(e.target??"")):s;if(n.length===0&&e.target)return o.warn(`\u0424\u0430\u0439\u043B "${e.target}" \u043D\u0435 \u044F\u0432\u043B\u044F\u0435\u0442\u0441\u044F god-\u0444\u0430\u0439\u043B\u043E\u043C.`),this.buildResult("analyze",s.length,0,[],[],[],t);o.info(`\u041D\u0430\u0439\u0434\u0435\u043D\u043E ${n.length} god-\u0444\u0430\u0439\u043B(\u043E\u0432)`),o.phase(2,5,"\u041F\u041B\u0410\u041D\u0418\u0420\u041E\u0412\u0410\u041D\u0418\u0415");let i=[];for(let f of n){let h=this.planSingleFile(f,e);h&&i.push(h)}if(i.length===0)return o.warn("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u0444\u043E\u0440\u043C\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u043D\u0438 \u043E\u0434\u043D\u043E\u0433\u043E \u043F\u043B\u0430\u043D\u0430"),this.buildResult("plan",n.length,0,[],[],[],t);if(e.dryRun)return this.printPlans(i),this.buildResult("plan",n.length,0,[],[],[],t);o.phase(3,5,"\u0413\u0415\u041D\u0415\u0420\u0410\u0426\u0418\u042F \u041A\u041E\u0414\u0410");let a=[],c=[];for(let f of i){let{files:h,affectedPaths:B}=this.generateForPlan(f,e);a.push(...h),c.push(...B)}o.phase(4,5,"\u0417\u0410\u041F\u0418\u0421\u042C \u0424\u0410\u0419\u041B\u041E\u0412");let p=this.deps.rollbackManager.createSnapshot(c);this.writeFiles(a),o.phase(5,5,"\u0412\u0415\u0420\u0418\u0424\u0418\u041A\u0410\u0426\u0418\u042F");let d=this.deps.compilationChecker.check(e.projectRoot);if(!d.success){o.error("\u041A\u043E\u043C\u043F\u0438\u043B\u044F\u0446\u0438\u044F \u043F\u0440\u043E\u0432\u0430\u043B\u0435\u043D\u0430 \u2014 \u043E\u0442\u043A\u0430\u0442!"),this.deps.rollbackManager.rollback(p);let f=d.errors.map(h=>`${h.file}:${h.line} \u2014 ${h.code}: ${h.message}`);return this.buildResult("verify",n.length,0,[],[],f,t)}this.deps.rollbackManager.commit(p);let m=a.filter(f=>f.isNew).map(f=>f.path),g=a.filter(f=>!f.isNew).map(f=>f.path);return o.success(`\u0420\u0435\u0444\u0430\u043A\u0442\u043E\u0440\u0438\u043D\u0433 \u0437\u0430\u0432\u0435\u0440\u0448\u0451\u043D: ${m.length} \u0441\u043E\u0437\u0434\u0430\u043D\u043E, ${g.length} \u043C\u043E\u0434\u0438\u0444\u0438\u0446\u0438\u0440\u043E\u0432\u0430\u043D\u043E`),this.buildResult("verify",n.length,i.length,m,g,[],t)}analyzeOnly(e){let{fileAnalyzer:t,godDetector:o,depAnalyzer:r,clusterer:s,logger:n}=this.deps;o.setThresholds(e.thresholds);let i=t.analyzeProject(e.projectRoot,e.extensions),a=i.length,c=i.reduce((m,g)=>m+g.lineCount,0);n.success(`\u041D\u0430\u0439\u0434\u0435\u043D\u043E ${a} \u0444\u0430\u0439\u043B\u043E\u0432  (${c.toLocaleString("ru-RU")} \u0441\u0442\u0440\u043E\u043A)`);let p=o.detect(i),d=[];for(let m of p){let g=r.buildSymbolGraph(m.filePath,m.analysis.symbols),f=s.clusterize(m,g);d.push({godFile:m,clusters:f,symbolGraph:g})}return{reports:d,totalFiles:a,totalLines:c}}planOnly(e,t){let{reports:o}=this.analyzeOnly(t),r=o.find(s=>s.godFile.filePath.includes(e));return r?this.planSingleFile(r,t):null}planSingleFile(e,t){let{splitPlanner:o,splitValidator:r,logger:s}=this.deps,n=o.createPlan(e.godFile,e.clusters,e.symbolGraph,t.projectRoot),i=r.validate(n,t.projectRoot,t.thresholds.maxLines);if(!i.isValid){for(let a of i.errors)s.error(`\u0412\u0430\u043B\u0438\u0434\u0430\u0446\u0438\u044F: [${a.code}] ${a.message}`);return null}for(let a of i.warnings)s.warn(`\u0412\u0430\u043B\u0438\u0434\u0430\u0446\u0438\u044F: [${a.code}] ${a.message}`);return n}generateForPlan(e,t){let{moduleGenerator:o,importRewriter:r,barrelGenerator:s,logger:n}=this.deps,i=[],a=[e.sourceFile],c=Y(e.sourceFile,"utf-8"),p=this.deps.fileAnalyzer.analyzeFile(e.sourceFile).imports;for(let g of e.targets){let f=o.generate(g,c,p);i.push(f),a.push(g.targetPath),n.progress(i.length,e.targets.length,J(g.targetPath))}let d=s.generate(e.sourceFile,e.targets);i.push(d);let m=this.groupUpdatesByConsumer(e);for(let[g,f]of m)try{let h=Y(g,"utf-8"),B=r.rewriteFile(g,h,f);i.push(B),a.push(g)}catch{n.warn(`\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0440\u043E\u0447\u0438\u0442\u0430\u0442\u044C \u043F\u043E\u0442\u0440\u0435\u0431\u0438\u0442\u0435\u043B\u044C: ${g}`)}return{files:i,affectedPaths:a}}groupUpdatesByConsumer(e){let t=new Map;for(let o of e.consumerUpdates){let r=t.get(o.consumerFile)??[];r.push(o),t.set(o.consumerFile,r)}return t}writeFiles(e){for(let t of e){let o=Ve(t.path);We(o)||Ue(o,{recursive:!0}),ze(t.path,t.content,"utf-8"),this.deps.logger.debug(`\u0417\u0430\u043F\u0438\u0441\u0430\u043D: ${q(process.cwd(),t.path)}`)}}printPlans(e){let{logger:t}=this.deps;for(let o of e){t.info(`
\u{1F4C4} ${q(process.cwd(),o.sourceFile)}`);for(let r of o.targets){let s=r.symbols.map(n=>n.name).join(", ");t.info(`  \u2192 ${J(r.targetPath)} (${s})`)}t.info(`  \u{1F4CA} \u0412\u043B\u0438\u044F\u043D\u0438\u0435: ${o.impact.filesCreated} \u0441\u043E\u0437\u0434\u0430\u043D\u043E, ${o.impact.consumersAffected} \u043F\u043E\u0442\u0440\u0435\u0431\u0438\u0442\u0435\u043B\u0435\u0439`)}}buildResult(e,t,o,r,s,n,i){return{success:n.length===0,phase:e,godFilesFound:t,godFilesRefactored:o,filesCreated:r,filesModified:s,errors:n,duration:Date.now()-i}}};var Ze="1.0.0";function Xe(l,e){let t=e.dryRun?"dry-run":"analyze",o=e.extensions.join(", "),r=e.projectRoot.length>36?"..."+e.projectRoot.slice(-33):e.projectRoot;console.log(""),l.boxTop(),l.boxLine(`\u{1F527} SOLID Refactorer  v${Ze}`),l.boxLine(`\u25CF ${r}    ${o}`),l.boxBot(),console.log("")}function Ke(l,e){console.log(""),l.boxTop(),l.boxLine(`\u{1F4CA}  GOD-\u0424\u0410\u0419\u041B\u042B  (${e.length} \u043D\u0430\u0439\u0434\u0435\u043D\u043E)`),l.boxDiv();for(let t of e){let{godFile:o,clusters:r}=t,s=Q(process.cwd(),o.filePath),n=o.godScore,i=Qe(o.severity);if(l.boxEmpty(),l.boxLine(`${i} ${s}`),l.boxLine(`   \u0421\u0442\u0440\u043E\u043A: ${o.analysis.lineCount}  \xB7  \u0421\u0438\u043C\u0432\u043E\u043B\u043E\u0432: ${o.analysis.symbolCount}  \xB7  Score: ${n.total.toFixed(2)}`),l.boxLine(`   ${et(n.total)}  ${(n.total*100).toFixed(0)}%`),r.length>0){let c=r.slice(0,3),p=r.length-3;for(let d=0;d<c.length;d++){let m=c[d],g=d<c.length-1&&p<=0?"\u251C\u2500\u2500":d===c.length-1&&p<=0?"\u2514\u2500\u2500":"\u251C\u2500\u2500";l.boxLine(`   ${g} ${m.suggestedName} [${m.linesCount} \u0441\u0442\u0440\u043E\u043A]`)}p>0&&l.boxLine(`   \u2514\u2500\u2500 +${p} \u0435\u0449\u0451`)}}l.boxEmpty(),l.boxBot()}function Ye(l,e,t){let{totalFiles:o,totalLines:r}=e,s=t.filter(p=>p.godFile.severity==="critical").length,n=t.filter(p=>p.godFile.severity==="warning").length,i=t.filter(p=>p.godFile.severity==="info").length,a=t.reduce((p,d)=>p+d.clusters.length,0),c=o>0?Math.round(t.length/o*100):0;console.log(""),l.boxTop(),l.boxLine("\u{1F4C8}  \u0421\u0412\u041E\u0414\u041A\u0410 \u0410\u041D\u0410\u041B\u0418\u0417\u0410"),l.boxDiv(),l.boxLine(`\u{1F4C1}  \u0424\u0430\u0439\u043B\u043E\u0432 \u043F\u0440\u043E\u0430\u043D\u0430\u043B\u0438\u0437\u0438\u0440\u043E\u0432\u0430\u043D\u043E:   ${o}  (${tt(r)} \u0441\u0442\u0440\u043E\u043A)`),l.boxLine(`\u{1F50D}  God-\u0444\u0430\u0439\u043B\u043E\u0432:                ${t.length}  (${c}%)`),l.boxDiv(),l.boxLine(`\u{1F534}  \u041A\u0440\u0438\u0442\u0438\u0447\u0435\u0441\u043A\u0438\u0445 (score \u2265 0.6): ${s}`),l.boxLine(`\u{1F7E1}  \u041F\u0440\u0435\u0434\u0443\u043F\u0440\u0435\u0436\u0434\u0435\u043D\u0438\u0439:            ${n}`),l.boxLine(`\u{1F535}  \u0418\u043D\u0444\u043E\u0440\u043C\u0430\u0446\u0438\u043E\u043D\u043D\u044B\u0445:            ${i}`),l.boxDiv(),l.boxLine(`\u{1F4E6}  \u041A\u043B\u0430\u0441\u0442\u0435\u0440\u043E\u0432:                 ${a} \u043E\u0442\u0432\u0435\u0442\u0441\u0442\u0432\u0435\u043D\u043D\u043E\u0441\u0442\u0435\u0439`),l.boxLine(`\u23F1   \u0412\u0440\u0435\u043C\u044F:                     ${l.elapsed()}`),l.boxBot()}function qe(l,e){console.log(""),l.boxTop(),l.boxLine(`\u{1F5C2}   \u041F\u041B\u0410\u041D\u042B \u0420\u0415\u0424\u0410\u041A\u0422\u041E\u0420\u0418\u041D\u0413\u0410  (${e.length} \u0444\u0430\u0439\u043B\u043E\u0432)`),l.boxDiv();for(let t of e){let o=Q(process.cwd(),t.sourceFile);l.boxEmpty(),l.boxLine(`\u{1F4C4} ${o}`);for(let r=0;r<t.targets.length;r++){let s=t.targets[r],n=s.symbols.map(c=>c.name).slice(0,3).join(", "),i=s.symbols.length>3?` +${s.symbols.length-3}`:"",a=r<t.targets.length-1?"\u251C\u2500\u2500":"\u2514\u2500\u2500";l.boxLine(`   ${a} \u2192 ${He(s.targetPath)}  (${n}${i})`)}l.boxLine(`   \u{1F4CA} ${t.impact.filesCreated} \u0441\u043E\u0437\u0434\u0430\u043D\u043E \xB7 ${t.impact.consumersAffected} \u043F\u043E\u0442\u0440\u0435\u0431\u0438\u0442\u0435\u043B\u0435\u0439`)}l.boxEmpty(),l.boxBot()}function Je(l,e){let t=e.success?"\u2705":"\u274C";if(console.log(""),l.boxTop(),l.boxLine(`${t}  \u0420\u0415\u0417\u0423\u041B\u042C\u0422\u0410\u0422 \u0420\u0415\u0424\u0410\u041A\u0422\u041E\u0420\u0418\u041D\u0413\u0410`),l.boxDiv(),l.boxLine(`God-\u0444\u0430\u0439\u043B\u043E\u0432 \u043D\u0430\u0439\u0434\u0435\u043D\u043E:      ${e.godFilesFound}`),l.boxLine(`God-\u0444\u0430\u0439\u043B\u043E\u0432 \u0440\u0435\u0444\u0430\u043A\u0442\u043E\u0440\u0435\u043D\u043E:  ${e.godFilesRefactored}`),l.boxLine(`\u0424\u0430\u0439\u043B\u043E\u0432 \u0441\u043E\u0437\u0434\u0430\u043D\u043E:          ${e.filesCreated.length}`),l.boxLine(`\u0424\u0430\u0439\u043B\u043E\u0432 \u043C\u043E\u0434\u0438\u0444\u0438\u0446\u0438\u0440\u043E\u0432\u0430\u043D\u043E:   ${e.filesModified.length}`),l.boxLine(`\u041E\u0448\u0438\u0431\u043E\u043A:                  ${e.errors.length}`),l.boxDiv(),l.boxLine(`\u23F1   \u0412\u0440\u0435\u043C\u044F:  ${e.duration}ms`),l.boxBot(),e.errors.length>0){console.log(""),l.error("\u041E\u0448\u0438\u0431\u043A\u0438:");for(let o of e.errors)l.error(`  ${o}`)}}function Qe(l){switch(l){case"critical":return"\u{1F534}";case"warning":return"\u{1F7E1}";case"info":return"\u{1F535}"}}function et(l){let t=Math.round(20*l);return"\u2588".repeat(t)+"\u2591".repeat(20-t)}function tt(l){return l.toLocaleString("ru-RU")}function ot(l){let e=new v(l),t=new $(l),o=new R(l),r=new w(l),s=new E(l),n=new T(s,l),i=new C(l),a=new P(l),c=new F(a,l),p=new A(l),d=new j(l),m=new G(l),g=new O(l);return new M({fileAnalyzer:e,godDetector:t,depAnalyzer:o,clusterer:r,importResolver:s,splitPlanner:n,splitValidator:i,codeExtractor:a,moduleGenerator:c,importRewriter:p,barrelGenerator:d,compilationChecker:m,rollbackManager:g,logger:l})}function rt(){let l=N(process.argv);(process.argv.includes("--help")||process.argv.includes("-h"))&&(z(),process.exit(0));let e=_(l),t=new S(e.verbose);Xe(t,e);let o=ot(t);l.analyzeOnly&&(st(t,o,e),process.exit(0)),e.target&&e.dryRun&&(nt(t,o,e),process.exit(0)),it(t,o,e)}function st(l,e,t){l.phase(1,3,"\u0421\u041A\u0410\u041D\u0418\u0420\u041E\u0412\u0410\u041D\u0418\u0415"),l.info(`\u041F\u0443\u0442\u044C:    ${t.projectRoot}`),l.info(`\u0420\u0430\u0441\u0448:    ${t.extensions.join(", ")}`),l.info("\u0420\u0435\u0436\u0438\u043C:   \u0422\u043E\u043B\u044C\u043A\u043E \u0430\u043D\u0430\u043B\u0438\u0437"),l.info(`\u041F\u043E\u0440\u043E\u0433\u0438:  \u0441\u0442\u0440\u043E\u043A \u2265${t.thresholds.maxLines}  \u0441\u0438\u043C\u0432\u043E\u043B\u043E\u0432 \u2265${t.thresholds.maxSymbols}  score \u2265${t.thresholds.minGodScore}`);let o=e.analyzeOnly(t);l.phase(2,3,"\u0414\u0415\u0422\u0415\u041A\u0426\u0418\u042F GOD-\u0424\u0410\u0419\u041B\u041E\u0412");let{reports:r,totalFiles:s}=o,n=s>0?Math.round(r.length/s*100):0;if(l.success(`${r.length} god-\u0444\u0430\u0439\u043B\u043E\u0432 \u0438\u0437 ${s}  (${n}%)`),r.length>0){let a=r.filter(d=>d.godFile.severity==="critical").length,c=r.filter(d=>d.godFile.severity==="warning").length,p=r.filter(d=>d.godFile.severity==="info").length;l.info(`\u{1F534} ${a} \u043A\u0440\u0438\u0442\u0438\u0447\u0435\u0441\u043A\u0438\u0445  \u{1F7E1} ${c} \u043F\u0440\u0435\u0434\u0443\u043F\u0440\u0435\u0436\u0434\u0435\u043D\u0438\u0439  \u{1F535} ${p} \u0438\u043D\u0444\u043E`)}l.phase(3,3,"\u041A\u041B\u0410\u0421\u0422\u0415\u0420\u041D\u042B\u0419 \u0410\u041D\u0410\u041B\u0418\u0417");let i=r.reduce((a,c)=>a+c.clusters.length,0);l.success(`${i} \u043A\u043B\u0430\u0441\u0442\u0435\u0440\u043E\u0432 \u0432 ${r.length} \u0444\u0430\u0439\u043B\u0430\u0445`),r.length>0&&Ke(l,r),Ye(l,o,r),console.log(""),l.success(`\u0410\u043D\u0430\u043B\u0438\u0437 \u0437\u0430\u0432\u0435\u0440\u0448\u0451\u043D \u0437\u0430 ${l.elapsed()}.  --dry-run \u0434\u043B\u044F \u043F\u043B\u0430\u043D\u043E\u0432 \u0440\u0435\u0444\u0430\u043A\u0442\u043E\u0440\u0438\u043D\u0433\u0430.`)}function nt(l,e,t){let o=t.target;if(!o)return;l.phase(1,2,"\u0410\u041D\u0410\u041B\u0418\u0417 \u0426\u0415\u041B\u0415\u0412\u041E\u0413\u041E \u0424\u0410\u0419\u041B\u0410"),l.info(`\u0424\u0430\u0439\u043B: ${o}`);let r=e.planOnly(o,t);if(!r){l.warn(`\u0424\u0430\u0439\u043B "${o}" \u043D\u0435 \u044F\u0432\u043B\u044F\u0435\u0442\u0441\u044F god-\u0444\u0430\u0439\u043B\u043E\u043C \u0438\u043B\u0438 \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D.`);return}l.phase(2,2,"\u041F\u041B\u0410\u041D \u0420\u0410\u0417\u0411\u0418\u0415\u041D\u0418\u042F"),qe(l,[r]),l.success("\u041F\u043B\u0430\u043D \u0433\u043E\u0442\u043E\u0432. \u0417\u0430\u043F\u0443\u0441\u0442\u0438\u0442\u0435 \u0431\u0435\u0437 --dry-run \u0434\u043B\u044F \u043F\u0440\u0438\u043C\u0435\u043D\u0435\u043D\u0438\u044F.")}function it(l,e,t){let o=e.runFullRefactor(t);Je(l,o),process.exit(o.success?0:1)}rt();
