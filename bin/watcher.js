#!/usr/bin/env node
import{createHash as Ue}from"node:crypto";import{readFileSync as Ke,statSync as Tt,readdirSync as Zs,existsSync as Qs}from"node:fs";import{join as tn,relative as Ct,extname as Lt}from"node:path";import{stat as vs}from"fs";import{stat as Is,readdir as Ts}from"fs/promises";import{EventEmitter as Cs}from"events";import*as _ from"path";import{stat as Ze,lstat as se,readdir as Qe,realpath as ts}from"node:fs/promises";import{Readable as es}from"node:stream";import{resolve as ne,relative as ss,join as ns,sep as rs}from"node:path";var C={FILE_TYPE:"files",DIR_TYPE:"directories",FILE_DIR_TYPE:"files_directories",EVERYTHING_TYPE:"all"},Dt={root:".",fileFilter:n=>!0,directoryFilter:n=>!0,type:C.FILE_TYPE,lstat:!1,depth:2147483648,alwaysStat:!1,highWaterMark:4096};Object.freeze(Dt);var ae="READDIRP_RECURSIVE_ERROR",os=new Set(["ENOENT","EPERM","EACCES","ELOOP",ae]),re=[C.DIR_TYPE,C.EVERYTHING_TYPE,C.FILE_DIR_TYPE,C.FILE_TYPE],is=new Set([C.DIR_TYPE,C.EVERYTHING_TYPE,C.FILE_DIR_TYPE]),as=new Set([C.EVERYTHING_TYPE,C.FILE_DIR_TYPE,C.FILE_TYPE]),cs=n=>os.has(n.code),ls=process.platform==="win32",oe=n=>!0,ie=n=>{if(n===void 0)return oe;if(typeof n=="function")return n;if(typeof n=="string"){let t=n.trim();return e=>e.basename===t}if(Array.isArray(n)){let t=n.map(e=>e.trim());return e=>t.some(r=>e.basename===r)}return oe},Mt=class extends es{constructor(t={}){super({objectMode:!0,autoDestroy:!0,highWaterMark:t.highWaterMark});let e={...Dt,...t},{root:r,type:s}=e;this._fileFilter=ie(e.fileFilter),this._directoryFilter=ie(e.directoryFilter);let o=e.lstat?se:Ze;ls?this._stat=i=>o(i,{bigint:!0}):this._stat=o,this._maxDepth=e.depth??Dt.depth,this._wantsDir=s?is.has(s):!1,this._wantsFile=s?as.has(s):!1,this._wantsEverything=s===C.EVERYTHING_TYPE,this._root=ne(r),this._isDirent=!e.alwaysStat,this._statsProp=this._isDirent?"dirent":"stats",this._rdOptions={encoding:"utf8",withFileTypes:this._isDirent},this.parents=[this._exploreDir(r,1)],this.reading=!1,this.parent=void 0}async _read(t){if(!this.reading){this.reading=!0;try{for(;!this.destroyed&&t>0;){let e=this.parent,r=e&&e.files;if(r&&r.length>0){let{path:s,depth:o}=e,i=r.splice(0,t).map(c=>this._formatEntry(c,s)),a=await Promise.all(i);for(let c of a){if(!c)continue;if(this.destroyed)return;let h=await this._getEntryType(c);h==="directory"&&this._directoryFilter(c)?(o<=this._maxDepth&&this.parents.push(this._exploreDir(c.fullPath,o+1)),this._wantsDir&&(this.push(c),t--)):(h==="file"||this._includeAsFile(c))&&this._fileFilter(c)&&this._wantsFile&&(this.push(c),t--)}}else{let s=this.parents.pop();if(!s){this.push(null);break}if(this.parent=await s,this.destroyed)return}}}catch(e){this.destroy(e)}finally{this.reading=!1}}}async _exploreDir(t,e){let r;try{r=await Qe(t,this._rdOptions)}catch(s){this._onError(s)}return{files:r,depth:e,path:t}}async _formatEntry(t,e){let r,s=this._isDirent?t.name:t;try{let o=ne(ns(e,s));r={path:ss(this._root,o),fullPath:o,basename:s},r[this._statsProp]=this._isDirent?t:await this._stat(o)}catch(o){this._onError(o);return}return r}_onError(t){cs(t)&&!this.destroyed?this.emit("warn",t):this.destroy(t)}async _getEntryType(t){if(!t&&this._statsProp in t)return"";let e=t[this._statsProp];if(e.isFile())return"file";if(e.isDirectory())return"directory";if(e&&e.isSymbolicLink()){let r=t.fullPath;try{let s=await ts(r),o=await se(s);if(o.isFile())return"file";if(o.isDirectory()){let i=s.length;if(r.startsWith(s)&&r.substr(i,1)===rs){let a=new Error(`Circular symlink detected: "${r}" points to "${s}"`);return a.code=ae,this._onError(a)}return"directory"}}catch(s){return this._onError(s),""}}}_includeAsFile(t){let e=t&&t[this._statsProp];return e&&this._wantsEverything&&!e.isDirectory()}};function ce(n,t={}){let e=t.entryType||t.type;if(e==="both"&&(e=C.FILE_DIR_TYPE),e&&(t.type=e),n){if(typeof n!="string")throw new TypeError("readdirp: root argument must be a string. Usage: readdirp(root, options)");if(e&&!re.includes(e))throw new Error(`readdirp: Invalid type passed. Use one of ${re.join(", ")}`)}else throw new Error("readdirp: root argument is required. Usage: readdirp(root, options)");return t.root=n,new Mt(t)}import{watchFile as hs,unwatchFile as le,watch as us}from"fs";import{open as ds,stat as ue,lstat as ps,realpath as At}from"fs/promises";import*as $ from"path";import{type as ms}from"os";var fs="data",Nt="end",de="close",ht=()=>{};var ut=process.platform,Ot=ut==="win32",gs=ut==="darwin",ys=ut==="linux",ws=ut==="freebsd",pe=ms()==="OS400",R={ALL:"all",READY:"ready",ADD:"add",CHANGE:"change",ADD_DIR:"addDir",UNLINK:"unlink",UNLINK_DIR:"unlinkDir",RAW:"raw",ERROR:"error"},D=R,xs="watch",_s={lstat:ps,stat:ue},K="listeners",it="errHandlers",J="rawEmitters",bs=[K,it,J],Es=new Set(["3dm","3ds","3g2","3gp","7z","a","aac","adp","afdesign","afphoto","afpub","ai","aif","aiff","alz","ape","apk","appimage","ar","arj","asf","au","avi","bak","baml","bh","bin","bk","bmp","btif","bz2","bzip2","cab","caf","cgm","class","cmx","cpio","cr2","cur","dat","dcm","deb","dex","djvu","dll","dmg","dng","doc","docm","docx","dot","dotm","dra","DS_Store","dsk","dts","dtshd","dvb","dwg","dxf","ecelp4800","ecelp7470","ecelp9600","egg","eol","eot","epub","exe","f4v","fbs","fh","fla","flac","flatpak","fli","flv","fpx","fst","fvt","g3","gh","gif","graffle","gz","gzip","h261","h263","h264","icns","ico","ief","img","ipa","iso","jar","jpeg","jpg","jpgv","jpm","jxr","key","ktx","lha","lib","lvp","lz","lzh","lzma","lzo","m3u","m4a","m4v","mar","mdi","mht","mid","midi","mj2","mka","mkv","mmr","mng","mobi","mov","movie","mp3","mp4","mp4a","mpeg","mpg","mpga","mxu","nef","npx","numbers","nupkg","o","odp","ods","odt","oga","ogg","ogv","otf","ott","pages","pbm","pcx","pdb","pdf","pea","pgm","pic","png","pnm","pot","potm","potx","ppa","ppam","ppm","pps","ppsm","ppsx","ppt","pptm","pptx","psd","pya","pyc","pyo","pyv","qt","rar","ras","raw","resources","rgb","rip","rlc","rmf","rmvb","rpm","rtf","rz","s3m","s7z","scpt","sgi","shar","snap","sil","sketch","slk","smv","snk","so","stl","suo","sub","swf","tar","tbz","tbz2","tga","tgz","thmx","tif","tiff","tlz","ttc","ttf","txz","udf","uvh","uvi","uvm","uvp","uvs","uvu","viv","vob","war","wav","wax","wbmp","wdp","weba","webm","webp","whl","wim","wm","wma","wmv","wmx","woff","woff2","wrm","wvx","xbm","xif","xla","xlam","xls","xlsb","xlsm","xlsx","xlt","xltm","xltx","xm","xmind","xpi","xpm","xwd","xz","z","zip","zipx"]),$s=n=>Es.has($.extname(n).slice(1).toLowerCase()),Bt=(n,t)=>{n instanceof Set?n.forEach(t):t(n)},et=(n,t,e)=>{let r=n[t];r instanceof Set||(n[t]=r=new Set([r])),r.add(e)},Rs=n=>t=>{let e=n[t];e instanceof Set?e.clear():delete n[t]},st=(n,t,e)=>{let r=n[t];r instanceof Set?r.delete(e):r===e&&delete n[t]},me=n=>n instanceof Set?n.size===0:!n,at=new Map;function he(n,t,e,r,s){let o=(i,a)=>{e(n),s(i,a,{watchedPath:n}),a&&n!==a&&ct($.resolve(n,a),K,$.join(n,a))};try{return us(n,{persistent:t.persistent},o)}catch(i){r(i);return}}var ct=(n,t,e,r,s)=>{let o=at.get(n);o&&Bt(o[t],i=>{i(e,r,s)})},Ss=(n,t,e,r)=>{let{listener:s,errHandler:o,rawEmitter:i}=r,a=at.get(t),c;if(!e.persistent)return c=he(n,e,s,o,i),c?c.close.bind(c):void 0;if(a)et(a,K,s),et(a,it,o),et(a,J,i);else{if(c=he(n,e,ct.bind(null,t,K),o,ct.bind(null,t,J)),!c)return;c.on(D.ERROR,async h=>{let l=ct.bind(null,t,it);if(a&&(a.watcherUnusable=!0),Ot&&h.code==="EPERM")try{await(await ds(n,"r")).close(),l(h)}catch{}else l(h)}),a={listeners:s,errHandlers:o,rawEmitters:i,watcher:c},at.set(t,a)}return()=>{st(a,K,s),st(a,it,o),st(a,J,i),me(a.listeners)&&(a.watcher.close(),at.delete(t),bs.forEach(Rs(a)),a.watcher=void 0,Object.freeze(a))}},jt=new Map,Ps=(n,t,e,r)=>{let{listener:s,rawEmitter:o}=r,i=jt.get(t),a=i&&i.options;return a&&(a.persistent<e.persistent||a.interval>e.interval)&&(le(t),i=void 0),i?(et(i,K,s),et(i,J,o)):(i={listeners:s,rawEmitters:o,options:e,watcher:hs(t,e,(c,h)=>{Bt(i.rawEmitters,d=>{d(D.CHANGE,t,{curr:c,prev:h})});let l=c.mtimeMs;(c.size!==h.size||l>h.mtimeMs||l===0)&&Bt(i.listeners,d=>d(n,c))})},jt.set(t,i)),()=>{st(i,K,s),st(i,J,o),me(i.listeners)&&(jt.delete(t),le(t),i.options=i.watcher=void 0,Object.freeze(i))}},lt=class{constructor(t){this.fsw=t,this._boundHandleError=e=>t._handleError(e)}_watchWithNodeFs(t,e){let r=this.fsw.options,s=$.dirname(t),o=$.basename(t);this.fsw._getWatchedDir(s).add(o);let a=$.resolve(t),c={persistent:r.persistent};e||(e=ht);let h;if(r.usePolling){let l=r.interval!==r.binaryInterval;c.interval=l&&$s(o)?r.binaryInterval:r.interval,h=Ps(t,a,c,{listener:e,rawEmitter:this.fsw._emitRaw})}else h=Ss(t,a,c,{listener:e,errHandler:this._boundHandleError,rawEmitter:this.fsw._emitRaw});return h}_handleFile(t,e,r){if(this.fsw.closed)return;let s=$.dirname(t),o=$.basename(t),i=this.fsw._getWatchedDir(s),a=e;if(i.has(o))return;let c=async(l,d)=>{if(this.fsw._throttle(xs,t,5)){if(!d||d.mtimeMs===0)try{let p=await ue(t);if(this.fsw.closed)return;let m=p.atimeMs,f=p.mtimeMs;if((!m||m<=f||f!==a.mtimeMs)&&this.fsw._emit(D.CHANGE,t,p),(gs||ys||ws)&&a.ino!==p.ino){this.fsw._closeFile(l),a=p;let w=this._watchWithNodeFs(t,c);w&&this.fsw._addPathCloser(l,w)}else a=p}catch{this.fsw._remove(s,o)}else if(i.has(o)){let p=d.atimeMs,m=d.mtimeMs;(!p||p<=m||m!==a.mtimeMs)&&this.fsw._emit(D.CHANGE,t,d),a=d}}},h=this._watchWithNodeFs(t,c);if(!(r&&this.fsw.options.ignoreInitial)&&this.fsw._isntIgnored(t)){if(!this.fsw._throttle(D.ADD,t,0))return;this.fsw._emit(D.ADD,t,e)}return h}async _handleSymlink(t,e,r,s){if(this.fsw.closed)return;let o=t.fullPath,i=this.fsw._getWatchedDir(e);if(!this.fsw.options.followSymlinks){this.fsw._incrReadyCount();let a;try{a=await At(r)}catch{return this.fsw._emitReady(),!0}return this.fsw.closed?void 0:(i.has(s)?this.fsw._symlinkPaths.get(o)!==a&&(this.fsw._symlinkPaths.set(o,a),this.fsw._emit(D.CHANGE,r,t.stats)):(i.add(s),this.fsw._symlinkPaths.set(o,a),this.fsw._emit(D.ADD,r,t.stats)),this.fsw._emitReady(),!0)}if(this.fsw._symlinkPaths.has(o))return!0;this.fsw._symlinkPaths.set(o,!0)}_handleRead(t,e,r,s,o,i,a){if(t=$.join(t,""),a=this.fsw._throttle("readdir",t,1e3),!a)return;let c=this.fsw._getWatchedDir(r.path),h=new Set,l=this.fsw._readdirp(t,{fileFilter:d=>r.filterPath(d),directoryFilter:d=>r.filterDir(d)});if(l)return l.on(fs,async d=>{if(this.fsw.closed){l=void 0;return}let p=d.path,m=$.join(t,p);if(h.add(p),!(d.stats.isSymbolicLink()&&await this._handleSymlink(d,t,m,p))){if(this.fsw.closed){l=void 0;return}(p===s||!s&&!c.has(p))&&(this.fsw._incrReadyCount(),m=$.join(o,$.relative(o,m)),this._addToNodeFs(m,e,r,i+1))}}).on(D.ERROR,this._boundHandleError),new Promise((d,p)=>{if(!l)return p();l.once(Nt,()=>{if(this.fsw.closed){l=void 0;return}let m=a?a.clear():!1;d(void 0),c.getChildren().filter(f=>f!==t&&!h.has(f)).forEach(f=>{this.fsw._remove(t,f)}),l=void 0,m&&this._handleRead(t,!1,r,s,o,i,a)})})}async _handleDir(t,e,r,s,o,i,a){let c=this.fsw._getWatchedDir($.dirname(t)),h=c.has($.basename(t));!(r&&this.fsw.options.ignoreInitial)&&!o&&!h&&this.fsw._emit(D.ADD_DIR,t,e),c.add($.basename(t)),this.fsw._getWatchedDir(t);let l,d,p=this.fsw.options.depth;if((p==null||s<=p)&&!this.fsw._symlinkPaths.has(a)){if(!o&&(await this._handleRead(t,r,i,o,t,s,l),this.fsw.closed))return;d=this._watchWithNodeFs(t,(m,f)=>{f&&f.mtimeMs===0||this._handleRead(m,!1,i,o,t,s,l)})}return d}async _addToNodeFs(t,e,r,s,o){let i=this.fsw._emitReady;if(this.fsw._isIgnored(t)||this.fsw.closed)return i(),!1;let a=this.fsw._getWatchHelpers(t);r&&(a.filterPath=c=>r.filterPath(c),a.filterDir=c=>r.filterDir(c));try{let c=await _s[a.statMethod](a.watchPath);if(this.fsw.closed)return;if(this.fsw._isIgnored(a.watchPath,c))return i(),!1;let h=this.fsw.options.followSymlinks,l;if(c.isDirectory()){let d=$.resolve(t),p=h?await At(t):t;if(this.fsw.closed||(l=await this._handleDir(a.watchPath,c,e,s,o,a,p),this.fsw.closed))return;d!==p&&p!==void 0&&this.fsw._symlinkPaths.set(d,p)}else if(c.isSymbolicLink()){let d=h?await At(t):t;if(this.fsw.closed)return;let p=$.dirname(a.watchPath);if(this.fsw._getWatchedDir(p).add(a.watchPath),this.fsw._emit(D.ADD,a.watchPath,c),l=await this._handleDir(p,c,e,s,t,a,d),this.fsw.closed)return;d!==void 0&&this.fsw._symlinkPaths.set($.resolve(t),d)}else l=this._handleFile(a.watchPath,c,e);return i(),l&&this.fsw._addPathCloser(t,l),!1}catch(c){if(this.fsw._handleError(c))return i(),t}}};var Wt="/",Ls="//",_e=".",ks="..",Fs="string",Ds=/\\/g,fe=/\/\//,Ms=/\..*\.(sw[px])$|~$|\.subl.*\.tmp/,As=/^\.[/\\]/;function dt(n){return Array.isArray(n)?n:[n]}var zt=n=>typeof n=="object"&&n!==null&&!(n instanceof RegExp);function js(n){return typeof n=="function"?n:typeof n=="string"?t=>n===t:n instanceof RegExp?t=>n.test(t):typeof n=="object"&&n!==null?t=>{if(n.path===t)return!0;if(n.recursive){let e=_.relative(n.path,t);return e?!e.startsWith("..")&&!_.isAbsolute(e):!1}return!1}:()=>!1}function Bs(n){if(typeof n!="string")throw new Error("string expected");n=_.normalize(n),n=n.replace(/\\/g,"/");let t=!1;n.startsWith("//")&&(t=!0);let e=/\/\//;for(;n.match(e);)n=n.replace(e,"/");return t&&(n="/"+n),n}function ge(n,t,e){let r=Bs(t);for(let s=0;s<n.length;s++){let o=n[s];if(o(r,e))return!0}return!1}function Ns(n,t){if(n==null)throw new TypeError("anymatch: specify first argument");let r=dt(n).map(s=>js(s));return t==null?(s,o)=>ge(r,s,o):ge(r,t)}var ye=n=>{let t=dt(n).flat();if(!t.every(e=>typeof e===Fs))throw new TypeError(`Non-string provided as watch path: ${t}`);return t.map(be)},we=n=>{let t=n.replace(Ds,Wt),e=!1;for(t.startsWith(Ls)&&(e=!0);t.match(fe);)t=t.replace(fe,Wt);return e&&(t=Wt+t),t},be=n=>we(_.normalize(we(n))),xe=(n="")=>t=>typeof t=="string"?be(_.isAbsolute(t)?t:_.join(n,t)):t,Os=(n,t)=>_.isAbsolute(n)?n:_.join(t,n),Ws=Object.freeze(new Set),Ht=class{constructor(t,e){this.path=t,this._removeWatcher=e,this.items=new Set}add(t){let{items:e}=this;e&&t!==_e&&t!==ks&&e.add(t)}async remove(t){let{items:e}=this;if(!e||(e.delete(t),e.size>0))return;let r=this.path;try{await Ts(r)}catch{this._removeWatcher&&this._removeWatcher(_.dirname(r),_.basename(r))}}has(t){let{items:e}=this;if(e)return e.has(t)}getChildren(){let{items:t}=this;return t?[...t.values()]:[]}dispose(){this.items.clear(),this.path="",this._removeWatcher=ht,this.items=Ws,Object.freeze(this)}},zs="stat",Hs="lstat",Yt=class{constructor(t,e,r){this.fsw=r;let s=t;this.path=t=t.replace(As,""),this.watchPath=s,this.fullWatchPath=_.resolve(s),this.dirParts=[],this.dirParts.forEach(o=>{o.length>1&&o.pop()}),this.followSymlinks=e,this.statMethod=e?zs:Hs}entryPath(t){return _.join(this.watchPath,_.relative(this.watchPath,t.fullPath))}filterPath(t){let{stats:e}=t;if(e&&e.isSymbolicLink())return this.filterDir(t);let r=this.entryPath(t);return this.fsw._isntIgnored(r,e)&&this.fsw._hasReadPermissions(e)}filterDir(t){return this.fsw._isntIgnored(this.entryPath(t),t.stats)}},pt=class extends Cs{constructor(t={}){super(),this.closed=!1,this._closers=new Map,this._ignoredPaths=new Set,this._throttled=new Map,this._streams=new Set,this._symlinkPaths=new Map,this._watched=new Map,this._pendingWrites=new Map,this._pendingUnlinks=new Map,this._readyCount=0,this._readyEmitted=!1;let e=t.awaitWriteFinish,r={stabilityThreshold:2e3,pollInterval:100},s={persistent:!0,ignoreInitial:!1,ignorePermissionErrors:!1,interval:100,binaryInterval:300,followSymlinks:!0,usePolling:!1,atomic:!0,...t,ignored:t.ignored?dt(t.ignored):dt([]),awaitWriteFinish:e===!0?r:typeof e=="object"?{...r,...e}:!1};pe&&(s.usePolling=!0),s.atomic===void 0&&(s.atomic=!s.usePolling);let o=process.env.CHOKIDAR_USEPOLLING;if(o!==void 0){let c=o.toLowerCase();c==="false"||c==="0"?s.usePolling=!1:c==="true"||c==="1"?s.usePolling=!0:s.usePolling=!!c}let i=process.env.CHOKIDAR_INTERVAL;i&&(s.interval=Number.parseInt(i,10));let a=0;this._emitReady=()=>{a++,a>=this._readyCount&&(this._emitReady=ht,this._readyEmitted=!0,process.nextTick(()=>this.emit(R.READY)))},this._emitRaw=(...c)=>this.emit(R.RAW,...c),this._boundRemove=this._remove.bind(this),this.options=s,this._nodeFsHandler=new lt(this),Object.freeze(s)}_addIgnoredPath(t){if(zt(t)){for(let e of this._ignoredPaths)if(zt(e)&&e.path===t.path&&e.recursive===t.recursive)return}this._ignoredPaths.add(t)}_removeIgnoredPath(t){if(this._ignoredPaths.delete(t),typeof t=="string")for(let e of this._ignoredPaths)zt(e)&&e.path===t&&this._ignoredPaths.delete(e)}add(t,e,r){let{cwd:s}=this.options;this.closed=!1,this._closePromise=void 0;let o=ye(t);return s&&(o=o.map(i=>Os(i,s))),o.forEach(i=>{this._removeIgnoredPath(i)}),this._userIgnored=void 0,this._readyCount||(this._readyCount=0),this._readyCount+=o.length,Promise.all(o.map(async i=>{let a=await this._nodeFsHandler._addToNodeFs(i,!r,void 0,0,e);return a&&this._emitReady(),a})).then(i=>{this.closed||i.forEach(a=>{a&&this.add(_.dirname(a),_.basename(e||a))})}),this}unwatch(t){if(this.closed)return this;let e=ye(t),{cwd:r}=this.options;return e.forEach(s=>{!_.isAbsolute(s)&&!this._closers.has(s)&&(r&&(s=_.join(r,s)),s=_.resolve(s)),this._closePath(s),this._addIgnoredPath(s),this._watched.has(s)&&this._addIgnoredPath({path:s,recursive:!0}),this._userIgnored=void 0}),this}close(){if(this._closePromise)return this._closePromise;this.closed=!0,this.removeAllListeners();let t=[];return this._closers.forEach(e=>e.forEach(r=>{let s=r();s instanceof Promise&&t.push(s)})),this._streams.forEach(e=>e.destroy()),this._userIgnored=void 0,this._readyCount=0,this._readyEmitted=!1,this._watched.forEach(e=>e.dispose()),this._closers.clear(),this._watched.clear(),this._streams.clear(),this._symlinkPaths.clear(),this._throttled.clear(),this._closePromise=t.length?Promise.all(t).then(()=>{}):Promise.resolve(),this._closePromise}getWatched(){let t={};return this._watched.forEach((e,r)=>{let o=(this.options.cwd?_.relative(this.options.cwd,r):r)||_e;t[o]=e.getChildren().sort()}),t}emitWithAll(t,e){this.emit(t,...e),t!==R.ERROR&&this.emit(R.ALL,t,...e)}async _emit(t,e,r){if(this.closed)return;let s=this.options;Ot&&(e=_.normalize(e)),s.cwd&&(e=_.relative(s.cwd,e));let o=[e];r!=null&&o.push(r);let i=s.awaitWriteFinish,a;if(i&&(a=this._pendingWrites.get(e)))return a.lastChange=new Date,this;if(s.atomic){if(t===R.UNLINK)return this._pendingUnlinks.set(e,[t,...o]),setTimeout(()=>{this._pendingUnlinks.forEach((c,h)=>{this.emit(...c),this.emit(R.ALL,...c),this._pendingUnlinks.delete(h)})},typeof s.atomic=="number"?s.atomic:100),this;t===R.ADD&&this._pendingUnlinks.has(e)&&(t=R.CHANGE,this._pendingUnlinks.delete(e))}if(i&&(t===R.ADD||t===R.CHANGE)&&this._readyEmitted){let c=(h,l)=>{h?(t=R.ERROR,o[0]=h,this.emitWithAll(t,o)):l&&(o.length>1?o[1]=l:o.push(l),this.emitWithAll(t,o))};return this._awaitWriteFinish(e,i.stabilityThreshold,t,c),this}if(t===R.CHANGE&&!this._throttle(R.CHANGE,e,50))return this;if(s.alwaysStat&&r===void 0&&(t===R.ADD||t===R.ADD_DIR||t===R.CHANGE)){let c=s.cwd?_.join(s.cwd,e):e,h;try{h=await Is(c)}catch{}if(!h||this.closed)return;o.push(h)}return this.emitWithAll(t,o),this}_handleError(t){let e=t&&t.code;return t&&e!=="ENOENT"&&e!=="ENOTDIR"&&(!this.options.ignorePermissionErrors||e!=="EPERM"&&e!=="EACCES")&&this.emit(R.ERROR,t),t||this.closed}_throttle(t,e,r){this._throttled.has(t)||this._throttled.set(t,new Map);let s=this._throttled.get(t);if(!s)throw new Error("invalid throttle");let o=s.get(e);if(o)return o.count++,!1;let i,a=()=>{let h=s.get(e),l=h?h.count:0;return s.delete(e),clearTimeout(i),h&&clearTimeout(h.timeoutObject),l};i=setTimeout(a,r);let c={timeoutObject:i,clear:a,count:0};return s.set(e,c),c}_incrReadyCount(){return this._readyCount++}_awaitWriteFinish(t,e,r,s){let o=this.options.awaitWriteFinish;if(typeof o!="object")return;let i=o.pollInterval,a,c=t;this.options.cwd&&!_.isAbsolute(t)&&(c=_.join(this.options.cwd,t));let h=new Date,l=this._pendingWrites;function d(p){vs(c,(m,f)=>{if(m||!l.has(t)){m&&m.code!=="ENOENT"&&s(m);return}let w=Number(new Date);p&&f.size!==p.size&&(l.get(t).lastChange=w);let E=l.get(t);w-E.lastChange>=e?(l.delete(t),s(void 0,f)):a=setTimeout(d,i,f)})}l.has(t)||(l.set(t,{lastChange:h,cancelWait:()=>(l.delete(t),clearTimeout(a),r)}),a=setTimeout(d,i))}_isIgnored(t,e){if(this.options.atomic&&Ms.test(t))return!0;if(!this._userIgnored){let{cwd:r}=this.options,o=(this.options.ignored||[]).map(xe(r)),a=[...[...this._ignoredPaths].map(xe(r)),...o];this._userIgnored=Ns(a,void 0)}return this._userIgnored(t,e)}_isntIgnored(t,e){return!this._isIgnored(t,e)}_getWatchHelpers(t){return new Yt(t,this.options.followSymlinks,this)}_getWatchedDir(t){let e=_.resolve(t);return this._watched.has(e)||this._watched.set(e,new Ht(e,this._boundRemove)),this._watched.get(e)}_hasReadPermissions(t){return this.options.ignorePermissionErrors?!0:!!(Number(t.mode)&256)}_remove(t,e,r){let s=_.join(t,e),o=_.resolve(s);if(r=r??(this._watched.has(s)||this._watched.has(o)),!this._throttle("remove",s,100))return;!r&&this._watched.size===1&&this.add(t,e,!0),this._getWatchedDir(s).getChildren().forEach(p=>this._remove(s,p));let c=this._getWatchedDir(t),h=c.has(e);c.remove(e),this._symlinkPaths.has(o)&&this._symlinkPaths.delete(o);let l=s;if(this.options.cwd&&(l=_.relative(this.options.cwd,s)),this.options.awaitWriteFinish&&this._pendingWrites.has(l)&&this._pendingWrites.get(l).cancelWait()===R.ADD)return;this._watched.delete(s),this._watched.delete(o);let d=r?R.UNLINK_DIR:R.UNLINK;h&&!this._isIgnored(s)&&this._emit(d,s),this._closePath(s)}_closePath(t){this._closeFile(t);let e=_.dirname(t);this._getWatchedDir(e).remove(_.basename(t))}_closeFile(t){let e=this._closers.get(t);e&&(e.forEach(r=>r()),this._closers.delete(t))}_addPathCloser(t,e){if(!e)return;let r=this._closers.get(t);r||(r=[],this._closers.set(t,r)),r.push(e)}_readdirp(t,e){if(this.closed)return;let r={type:R.ALL,alwaysStat:!0,lstat:!0,...e,depth:0},s=ce(t,r);return this._streams.add(s),s.once(de,()=>{s=void 0}),s.once(Nt,()=>{s&&(this._streams.delete(s),s=void 0)}),s}};function Ys(n,t={}){let e=new pt(t);return e.add(n),e}var Ee={watch:Ys,FSWatcher:pt};import{readFileSync as $e}from"node:fs";var mt=class{parsersByExtension=new Map;parsersByLanguage=new Map;register(t){this.parsersByLanguage.set(t.language,t);for(let e of t.extensions)this.parsersByExtension.set(e.toLowerCase(),t)}getByExtension(t){return this.parsersByExtension.get(t.toLowerCase())??null}getByLanguage(t){return this.parsersByLanguage.get(t)??null}getByFilePath(t){let e=t.lastIndexOf(".");if(e===-1)return null;let r=t.slice(e).toLowerCase();return this.getByExtension(r)}getSupportedExtensions(){return[...this.parsersByExtension.keys()]}isSupported(t){return this.getByFilePath(t)!==null}};import{createHash as Us}from"node:crypto";var ft=class{logger;constructor(t){this.logger=t}parse(t,e){let r=(s,o)=>({path:e,language:this.language,hash:Us("md5").update(s).digest("hex"),sizeBytes:Buffer.byteLength(s,"utf-8"),lineCount:s.split(`
`).length,symbolCount:o.length,lastModified:Date.now(),isIndexed:!1});try{let s=this.extractSymbols(t,e);return{metadata:r(t,s),symbols:s,imports:this.extractImports(t),exports:s.filter(o=>o.isExported).map(o=>o.name),errors:[]}}catch(s){return this.logger.warn(`Parse error in ${e}: ${s}`),{metadata:r(t,[]),symbols:[],imports:[],exports:[],errors:[{message:String(s)}]}}}extractImports(t){let e=[],r=/^[ \t]*import\s+(?:type\s+)?(?:\{[^}]*\}|[\w*]+(?:\s*,\s*\{[^}]*\})?)\s+from\s+['"]([^'"]+)['"]/gm,s;for(;(s=r.exec(t))!==null;)e.push(s[1]);return e}extractDocComments(t){let e=new Map,r=/\/\*\*\s*([\s\S]*?)\s*\*\//g,s;for(;(s=r.exec(t))!==null;){let o=t.substring(0,s.index).split(`
`).length;e.set(o,s[1].replace(/^\s*\*\s?/gm,"").trim())}return e}};var j={FUNCTION:/^[ \t]*(export\s+)?(default\s+)?(async\s+)?function\s+(\w+)\s*(?:<[^>]*>)?\s*\(([^)]*)\)(?:\s*:\s*([^\s{]+(?:\s*\|\s*[^\s{]+)*))?\s*\{/gm,ARROW_FUNCTION:/^[ \t]*(export\s+)?(const|let)\s+(\w+)\s*(?::\s*[^=]+)?\s*=\s*(async\s+)?(?:\(([^)]*)\)|(\w+))(?:\s*:\s*([^\s=]+(?:\s*\|\s*[^\s=]+)*))?\s*=>/gm,CLASS:/^[ \t]*(export\s+)?(default\s+)?(abstract\s+)?class\s+(\w+)(?:\s+extends\s+(\w+))?(?:\s+implements\s+([\w\s,]+))?\s*\{/gm,INTERFACE:/^[ \t]*(export\s+)?interface\s+(\w+)(?:\s+extends\s+([\w\s,]+))?\s*\{/gm,TYPE_ALIAS:/^[ \t]*(export\s+)?type\s+(\w+)(?:<[^>]*>)?\s*=\s*(.+)/gm,VARIABLE:/^[ \t]*(export\s+)?(const|let|var)\s+(\w+)(?:\s*:\s*([^=]+))?\s*=/gm,METHOD:/^[ \t]*(public|private|protected|static|abstract|async|readonly|\s)*(\w+)\s*(?:<[^>]*>)?\s*\(([^)]*)\)(?:\s*:\s*([^\s{]+(?:\s*\|\s*[^\s{]+)*))?\s*\{/gm,IMPORT:/^[ \t]*import\s+(?:type\s+)?(?:\{[^}]*\}|[\w*]+(?:\s*,\s*\{[^}]*\})?)\s+from\s+['"]([^'"]+)['"]/gm,JSDOC:/\/\*\*\s*([\s\S]*?)\s*\*\//g},gt=class extends ft{language="typescript";extensions=[".ts",".tsx",".js",".jsx"];constructor(t){super(t)}extractSymbols(t,e){let r=[],s=t.split(`
`),o=this.extractDocComments(t);return r.push(...this.extractFunctions(t,e,s,o)),r.push(...this.extractArrowFunctions(t,e,s,o)),r.push(...this.extractClasses(t,e,s)),r.push(...this.extractInterfaces(t,e,s)),r.push(...this.extractTypeAliases(t,e,s)),r.push(...this.extractVariables(t,e,s)),r}extractImports(t){let e=[],r=new RegExp(j.IMPORT.source,"gm"),s;for(;(s=r.exec(t))!==null;)s[1]&&e.push(s[1]);return e}extractExports(t,e){return e.filter(r=>r.isExported).map(r=>r.name)}extractFunctions(t,e,r,s){let o=[],i=new RegExp(j.FUNCTION.source,"gm"),a;for(;(a=i.exec(t))!==null;){let c=this.getLineNumber(t,a.index),h=a[4]??"anonymous",l=!!a[1],d=!!a[3],p=a[5]??"",m=a[6]??null,f=this.parseParameters(p),w=this.findDocComment(s,c),E=this.findClosingBrace(r,c),P=this.buildFunctionSignature(l,d,h,f,m);o.push({id:`${e}:${h}:${c}`,name:h,type:"function",filePath:e,range:this.buildRange(c,E),signature:P,isExported:l,parameters:f,returnType:m,isAsync:d,isStatic:!1,docComment:w})}return o}extractArrowFunctions(t,e,r,s){let o=[],i=new RegExp(j.ARROW_FUNCTION.source,"gm"),a;for(;(a=i.exec(t))!==null;){let c=this.getLineNumber(t,a.index),h=a[3]??"anonymous",l=!!a[1],d=!!a[4],p=a[5]??a[6]??"",m=a[7]??null,f=this.parseParameters(p),w=this.findDocComment(s,c),E=this.buildFunctionSignature(l,d,h,f,m);o.push({id:`${e}:${h}:${c}`,name:h,type:"function",filePath:e,range:this.buildRange(c,c),signature:E,isExported:l,parameters:f,returnType:m,isAsync:d,isStatic:!1,docComment:w})}return o}extractClasses(t,e,r){let s=[],o=new RegExp(j.CLASS.source,"gm"),i;for(;(i=o.exec(t))!==null;){let a=this.getLineNumber(t,i.index),c=i[4]??"AnonymousClass",h=!!i[1],l=!!i[3],d=i[5]??null,p=i[6]?i[6].split(",").map(P=>P.trim()).filter(Boolean):[],m=this.findClosingBrace(r,a),f=r.slice(a,m+1).join(`
`),w=this.extractClassMethods(f,e,a),E=this.buildClassSignature(h,l,c,d,p);s.push({id:`${e}:${c}:${a}`,name:c,type:"class",filePath:e,range:this.buildRange(a,m),signature:E,isExported:h,extends:d,implements:p,members:w,isAbstract:l})}return s}extractInterfaces(t,e,r){let s=[],o=new RegExp(j.INTERFACE.source,"gm"),i;for(;(i=o.exec(t))!==null;){let a=this.getLineNumber(t,i.index),c=i[2]??"AnonymousInterface",h=!!i[1],l=i[3]??"",d=this.findClosingBrace(r,a),p=h?`export interface ${c}${l?` extends ${l.trim()}`:""}`:`interface ${c}${l?` extends ${l.trim()}`:""}`;s.push({id:`${e}:${c}:${a}`,name:c,type:"interface",filePath:e,range:this.buildRange(a,d),signature:p,isExported:h})}return s}extractTypeAliases(t,e,r){let s=[],o=new RegExp(j.TYPE_ALIAS.source,"gm"),i;for(;(i=o.exec(t))!==null;){let a=this.getLineNumber(t,i.index),c=i[2]??"AnonymousType",h=!!i[1],l=(i[3]??"").trim().slice(0,100),d=h?`export type ${c} = ${l}`:`type ${c} = ${l}`;s.push({id:`${e}:${c}:${a}`,name:c,type:"type",filePath:e,range:this.buildRange(a,a),signature:d,isExported:h})}return s}extractVariables(t,e,r){let s=[],o=new RegExp(j.VARIABLE.source,"gm"),i,a=new Set,c=new RegExp(j.ARROW_FUNCTION.source,"gm"),h;for(;(h=c.exec(t))!==null;)h[3]&&a.add(h[3]);for(;(i=o.exec(t))!==null;){let l=i[3]??"anonymous";if(a.has(l))continue;let d=this.getLineNumber(t,i.index),p=!!i[1],m=i[2]??"const",f=i[4]?.trim()??null,w=m==="const",E=`${p?"export ":""}${m} ${l}${f?`: ${f}`:""}`;s.push({id:`${e}:${l}:${d}`,name:l,type:w?"constant":"variable",filePath:e,range:this.buildRange(d,d),signature:E,isExported:p,dataType:f,isConst:w})}return s}extractClassMethods(t,e,r){let s=[],o=new RegExp(j.METHOD.source,"gm"),i;for(;(i=o.exec(t))!==null;){let a=(i[1]??"").trim(),c=i[2];if(!c||c==="constructor"||c==="class"||c==="if"||c==="for"||c==="while")continue;let h=r+this.getLineNumber(t,i.index),l=i[3]??"",d=i[4]??null,p=`${a?a+" ":""}${c}(${l})${d?`: ${d}`:""}`;s.push({id:`${e}:${c}:${h}`,name:c,type:"method",filePath:e,range:this.buildRange(h,h),signature:p,isExported:!1})}return s}parseParameters(t){return t.trim()?t.split(",").map(e=>{let r=e.trim(),s=r.includes("?"),o=r.includes("="),i=r.split(/[?:=]/).map(l=>l.trim()).filter(Boolean),a=i[0]??"param",c=i[1]??null,h=o?i[2]??null:null;return{name:a,type:c,isOptional:s||o,defaultValue:h}}):[]}extractDocComments(t){let e=new Map,r=new RegExp(j.JSDOC.source,"g"),s;for(;(s=r.exec(t))!==null;){let o=this.getLineNumber(t,s.index+s[0].length),i=(s[1]??"").split(`
`).map(a=>a.replace(/^\s*\*\s?/,"").trim()).filter(Boolean).join(" ");e.set(o+1,i)}return e}findDocComment(t,e){return t.get(e)??t.get(e-1)??null}getLineNumber(t,e){let r=0;for(let s=0;s<e&&s<t.length;s++)t[s]===`
`&&r++;return r}findClosingBrace(t,e){let r=0,s=!1,o=!1,i=null;for(let a=e;a<t.length;a++){let c=t[a]??"";for(let h=0;h<c.length;h++){let l=c[h],d=c[h+1]??"";if(o){l==="*"&&d==="/"&&(o=!1,h++);continue}if(i!==null){if(l==="\\"){h++;continue}l===i&&(i=null);continue}if(l==="/"&&d==="/")break;if(l==="/"&&d==="*"){o=!0,h++;continue}if(l==="'"||l==='"'||l==="`"){i=l;continue}if(l==="{"?(r++,s=!0):l==="}"&&r--,s&&r===0)return a}}return Math.min(e+50,t.length-1)}buildRange(t,e){return{start:{line:t,column:0},end:{line:e,column:0}}}buildFunctionSignature(t,e,r,s,o){let i=[];t&&i.push("export"),e&&i.push("async"),i.push("function"),i.push(r);let a=s.map(c=>`${c.name}${c.isOptional?"?":""}${c.type?`: ${c.type}`:""}`).join(", ");return`${i.join(" ")}(${a})${o?`: ${o}`:""}`}buildClassSignature(t,e,r,s,o){let i=[];return t&&i.push("export"),e&&i.push("abstract"),i.push("class"),i.push(r),s&&i.push(`extends ${s}`),o.length>0&&i.push(`implements ${o.join(", ")}`),i.join(" ")}};var yt=class{level="L1";compactMode=!1;setCompactMode(t){this.compactMode=t}compress(t,e){let r=[];for(let a of t){let c=this.formatSymbol(a);c&&r.push(c)}let s=r.join(`

`),o=this.estimateTokens(e),i=this.estimateTokens(s);return{level:"L1",content:s,originalTokens:o,compressedTokens:i,compressionRatio:o>0?1-i/o:0,symbols:t}}formatSymbol(t){switch(t.type){case"function":case"method":return this.formatFunction(t);case"class":return this.formatClass(t);case"interface":case"type":case"variable":case"constant":case"property":return t.signature;default:return t.signature}}formatFunction(t){let e=[];if(t.docComment){let r=this.compactMode?this.compactJSDoc(t.docComment):t.docComment;r&&e.push(`/** ${r} */`)}return e.push(`${t.signature};`),e.join(`
`)}formatClass(t){let e=[];e.push(`${t.signature} {`);for(let r of t.members)e.push(`  ${r.signature};`);return e.push("}"),e.join(`
`)}compactJSDoc(t){let e=t.split(`
`),r=[];for(let o of e){let i=o.trim().replace(/^\*\s?/,"");if(i.startsWith("@"))break;i.length>0&&r.push(i)}return(r[0]??"").slice(0,120)}estimateTokens(t){return Math.ceil(t.length/3.3)}};var wt=class{level="L2";compress(t,e){let r=[];for(let a of t){let c=this.formatSymbol(a);c&&r.push(c)}let s=r.join(`
`),o=this.estimateTokens(e),i=this.estimateTokens(s);return{level:"L2",content:s,originalTokens:o,compressedTokens:i,compressionRatio:o>0?1-i/o:0,symbols:t}}formatSymbol(t){switch(t.type){case"function":case"method":return this.formatFunction(t);case"class":return this.formatClass(t);case"interface":return`interface ${t.name}`;case"type":return`type ${t.name}`;case"variable":case"constant":return`${t.type} ${t.name}`;case"property":return`  ${t.name}`;default:return null}}formatFunction(t){let e=t.parameters.map(s=>`${s.name}${s.type?`: ${s.type}`:""}`).join(", "),r=t.returnType?` \u2192 ${t.returnType}`:"";return`${t.name}(${e})${r}`}formatClass(t){let e=[],r=`class ${t.name}`;t.extends&&(r+=` extends ${t.extends}`),e.push(r);for(let s of t.members)e.push(`  ${s.name}`);return e.join(`
`)}estimateTokens(t){return Math.ceil(t.length/3.3)}};var xt=class{level="L3";compress(t,e){let r=this.groupByType(t),s=[];for(let[c,h]of r)s.push(`${c}: ${h.join(", ")}`);let o=s.join(`
`),i=this.estimateTokens(e),a=this.estimateTokens(o);return{level:"L3",content:o,originalTokens:i,compressedTokens:a,compressionRatio:i>0?1-a/i:0,symbols:t}}groupByType(t){let e=new Map;for(let r of t){if(r.type==="class"){let i=r,a=i.members.map(l=>l.name),c=a.length>0?`${i.name} { ${a.join(", ")} }`:i.name,h=e.get("class")??[];h.push(c),e.set("class",h);continue}let s=this.getGroupKey(r.type),o=e.get(s)??[];o.push(r.name),e.set(s,o)}return e}getGroupKey(t){switch(t){case"function":case"method":return"fn";case"class":return"class";case"interface":return"iface";case"type":return"type";case"variable":case"constant":return"const";case"property":return"prop";default:return"other"}}estimateTokens(t){return Math.ceil(t.length/3.3)}};var _t=class{parserRegistry;strategies;logger;constructor(t){this.logger=t,this.parserRegistry=new mt,this.parserRegistry.register(new gt(t)),this.strategies=new Map([["L1",new yt],["L2",new wt],["L3",new xt]])}compressFile(t,e="L1"){let r=$e(t,"utf-8");return this.compressCode(r,t,e=void 0)}compressCode(t,e,r="L1"){if(r==="L0")return this.buildL0Result(t);let s=this.parserRegistry.getByFilePath(e);if(!s)return this.logger.warn(`\u041F\u0430\u0440\u0441\u0435\u0440 \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D \u0434\u043B\u044F \u0444\u0430\u0439\u043B\u0430: ${e}. \u0412\u043E\u0437\u0432\u0440\u0430\u0449\u0430\u0435\u043C L0.`),this.buildL0Result(t);let o=s.parse(t,e);if(o.errors.length>0)return this.logger.warn(`\u041E\u0448\u0438\u0431\u043A\u0438 \u043F\u0430\u0440\u0441\u0438\u043D\u0433\u0430 ${e}: ${o.errors.length}. \u0412\u043E\u0437\u0432\u0440\u0430\u0449\u0430\u0435\u043C L0.`),this.buildL0Result(t);let i=this.strategies.get(r);if(!i){this.logger.warn(`\u0421\u0442\u0440\u0430\u0442\u0435\u0433\u0438\u044F \u0441\u0436\u0430\u0442\u0438\u044F ${r} \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430. \u0412\u043E\u0437\u0432\u0440\u0430\u0449\u0430\u0435\u043C L1.`);let c=this.strategies.get("L1");return c?c.compress(o.symbols,t):this.buildL0Result(t)}let a=i.compress(o.symbols,t);return this.logger.debug(`\u0421\u0436\u0430\u0442\u0438\u0435 ${e} [${r}]: ${a.originalTokens} \u2192 ${a.compressedTokens} (${(a.compressionRatio*100).toFixed(1)}% \u044D\u043A\u043E\u043D\u043E\u043C\u0438\u044F)`),a}extractSymbols(t){let e=$e(t,"utf-8");return this.extractSymbolsFromCode(e,t)}extractSymbolsFromCode(t,e){let r=this.parserRegistry.getByFilePath(e);return r?r.parse(t,e).symbols:[]}findSymbolInFile(t,e){return this.extractSymbols(t).find(s=>s.name===e)??null}isFileSupported(t){return this.parserRegistry.isSupported(t)}getSupportedExtensions(){return this.parserRegistry.getSupportedExtensions()}getParser(t){return this.parserRegistry.getByFilePath(t)}setCompactJSDoc(t){let e=this.strategies.get("L1");e&&"setCompactMode"in e&&e.setCompactMode(t)}setStripImports(t){}buildL0Result(t){let e=Math.ceil(t.length/3.3);return{level:"L0",content:t,originalTokens:e,compressedTokens:e,compressionRatio:0,symbols:[]}}};import{gzipSync as Ks}from"node:zlib";var Gs={maxRetries:3,baseDelayMs:500,maxDelayMs:5e3,timeoutMs:3e4},bt=class{serverUrl;authToken;projectId;onRetry;onSplit;constructor(t){this.serverUrl=t.serverUrl.replace(/\/$/,""),this.authToken=t.authToken,this.projectId=t.projectId,this.onRetry=t.onRetry,this.onSplit=t.onSplit}async healthCheck(){try{return(await fetch(`${this.serverUrl}/health`,{signal:AbortSignal.timeout(5e3)})).ok}catch{return!1}}async pushBatch(t){let e=JSON.stringify({project_id:this.projectId,files:t.map(s=>({path:s.path,hash:s.hash,sizeBytes:s.sizeBytes,language:s.language,lineCount:s.lineCount,l1Summary:s.l1Summary,l3Summary:s.l3Summary,imports:s.imports,symbols:s.symbols,rawSnippet:s.rawSnippet}))}),r=Ks(Buffer.from(e,"utf-8"));await this.fetchWithRetry(`${this.serverUrl}/api/push_indexed`,{method:"POST",headers:{"Content-Type":"application/json","Content-Encoding":"gzip",Authorization:`Bearer ${this.authToken}`,Connection:"close"},body:r},Gs)}async pushBatchAdaptive(t,e=0){if(t.length===0)return{uploaded:[],failed:[]};try{return await this.pushBatch(t),{uploaded:t,failed:[]}}catch{if(t.length===1)return{uploaded:[],failed:t};let r=Math.ceil(t.length/2),s=t.slice(0,r),o=t.slice(r);this.onSplit?.(t.length,r,e+1);let i=await this.pushBatchAdaptive(s,e+1);await new Promise(c=>setTimeout(c,200));let a=await this.pushBatchAdaptive(o,e+1);return{uploaded:[...i.uploaded,...a.uploaded],failed:[...i.failed,...a.failed]}}}async fetchWithRetry(t,e,r){let s=null;for(let o=0;o<=r.maxRetries;o++)try{let i=await fetch(t,{...e,signal:AbortSignal.timeout(r.timeoutMs)});if(i.status>=400&&i.status<500){let a=await i.text().catch(()=>"Unknown error");throw new Error(`HTTP ${i.status}: ${a}`)}if(i.status>=500){let a=await i.text().catch(()=>"Server error");if(s=new Error(`HTTP ${i.status}: ${a}`),o<r.maxRetries){await this.backoff(o,r);continue}throw s}return i}catch(i){let a=i instanceof Error?i:new Error(String(i));if(a.message.startsWith("HTTP 4")||(s=a,o>=r.maxRetries))throw a;this.onRetry?.(o+1,r.maxRetries,a.message),await this.backoff(o,r)}throw s??new Error("fetchWithRetry: unexpected end")}backoff(t,e){let r=e.baseDelayMs*Math.pow(2,t),s=Math.random()*500,o=Math.min(r+s,e.maxDelayMs);return new Promise(i=>setTimeout(i,o))}};var Vs="\x1B[0m",F="\x1B[1m",qs="\x1B[2m",Et="\x1B[33m",Js="\x1B[34m",nt="\x1B[36m",Xs="\x1B[37m",B="\x1B[31m",y="\x1B[90m",v="\x1B[92m",X="\x1B[93m",Pe="\x1B[94m",M="\x1B[96m",N="\x1B[97m",Pt=process.stdout.isTTY!==!1;function u(n,t){return Pt?`${n}${t}${Vs}`:t}function L(n){return n<1024?`${n} B`:n<1024*1024?`${(n/1024).toFixed(1)} KB`:`${(n/1024/1024).toFixed(2)} MB`}function St(n){return n<1e3?`${n}ms`:`${(n/1e3).toFixed(1)}s`}function z(){return u(y,new Date().toLocaleTimeString("ru-RU",{hour12:!1}))}function ve(n,t,e=28){if(t===0)return u(y,"\u2591".repeat(e));let r=Math.min(n/t,1),s=Math.round(r*e),o=e-s,i=u(v,"\u2588".repeat(s))+u(y,"\u2591".repeat(o)),a=u(N,`${Math.round(r*100)}%`).padStart(4);return`${i} ${a}`}function Ie(n,t,e="0.7.0"){let s="\u2500".repeat(62);console.log(""),console.log(u(M,`  \u250C${s}\u2510`)),console.log(u(M,"  \u2502")+u(F+N,"  \u{1F9E0} Project Brain Smart Watcher")+u(y,`  v${e}`)+" ".repeat(26-e.length)+u(M,"\u2502")),console.log(u(M,"  \u2502")+u(nt,"  \u25CF ")+u(N,n.padEnd(24))+u(y,"\u2192  ")+u(Js,t.slice(0,30).padEnd(30))+u(M,"\u2502")),console.log(u(M,`  \u2514${s}\u2518`)),console.log("")}function vt(n,t,e){let r=u(Pe+F,` ${n}/${t} `),s=u(F+N,` ${e} `),o=u(y,"\u2500".repeat(46));console.log(`
  ${r}${s}${o}`)}function Z(n){console.log(`  ${z()}  ${u(nt,"\xB7")}  ${n}`)}function Q(n){console.log(`  ${z()}  ${u(v,"\u2713")}  ${n}`)}function U(n){console.log(`  ${z()}  ${u(X,"\u26A0")}  ${u(Et,n)}`)}function A(n){console.log(`  ${z()}  ${u(B,"\u2717")}  ${u(B,n)}`)}function Te(n){console.log(`  ${z()}  ${u(y,"\u25CB")}  ${u(qs+y,n)}`)}var Re=0;function Ce(n,t,e){if(n===1&&(Re=Date.now()),!Pt){(n%10===0||n===t)&&console.log(`  [${n}/${t}] ${e}`);return}let r=ve(n,t),s=u(y,`${n}/${t}`),o=Date.now()-Re,i=n>0?o/n:0,a=Math.round(i*(t-n)/1e3),c=a>0?u(y,`~${a}\u0441 \u043E\u0441\u0442\u0430\u043B\u043E\u0441\u044C`):u(v,"\u0433\u043E\u0442\u043E\u0432\u043E");process.stdout.write(`\r\x1B[2K  ${r}  ${s}  ${c}  ${u(y,e.slice(0,28))}  `),n===t&&process.stdout.write(`
`)}var $t=0;function Le(n,t,e,r,s){n===1&&$t===0&&($t=Date.now());let o=s?u(v,"\u2713"):u(B,"\u2717"),i=ve(n,t,20),a=u(N,`${e} files`),c=u(y,`~${r}`),h=Date.now()-$t,l=n>0?h/n:0,d=Math.round(l*(t-n)/1e3),p=n<t?u(y,`~${d}\u0441`):u(v,"\u0433\u043E\u0442\u043E\u0432\u043E");Pt?(process.stdout.write(`\r\x1B[2K  ${i}  ${o} ${a} ${c}  ${p}`),n===t&&process.stdout.write(`
`)):console.log(`  Batch ${n}/${t}  ${s?"OK":"FAIL"}  ${e} files  ~${r}`)}function ke(){$t=0}var Se=["\u280B","\u2819","\u2839","\u2838","\u283C","\u2834","\u2826","\u2827","\u2807","\u280F"],Rt=null,Ut=0;function Kt(n){Pt&&(Ut=0,Rt=setInterval(()=>{let t=u(M,Se[Ut%Se.length]);process.stdout.write(`\r\x1B[2K  ${t}  ${u(y,n)}`),Ut++},80))}function Gt(){Rt&&(clearInterval(Rt),Rt=null,process.stdout.write("\r\x1B[2K"))}function Fe(n){let t=n.originalKb>0?(n.originalKb/Math.max(n.summaryKb,1)).toFixed(1):"\u2014",e=n.originalKb>0?Math.round((1-n.summaryKb/n.originalKb)*100):0,r=62,s="\u2500".repeat(r);console.log(""),console.log(u(v,`  \u250C${s}\u2510`));let o=n.errors===0?`  \u2705  \u041F\u0440\u043E\u0438\u043D\u0434\u0435\u043A\u0441\u0438\u0440\u043E\u0432\u0430\u043D\u043E ${n.files} \u0444\u0430\u0439\u043B\u043E\u0432 \u0437\u0430 ${St(n.elapsedMs)}`:`  \u26A0\uFE0F   \u041F\u0440\u043E\u0438\u043D\u0434\u0435\u043A\u0441\u0438\u0440\u043E\u0432\u0430\u043D\u043E ${n.files} \u0444\u0430\u0439\u043B\u043E\u0432 (${n.errors} \u043E\u0448\u0438\u0431\u043E\u043A) \u0437\u0430 ${St(n.elapsedMs)}`;console.log(u(v,"  \u2502")+u(F+N,o).padEnd(r+8)+u(v,"\u2502"));let i=`  \u{1F4BE}  \u041E\u0442\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u043E ${L(n.summaryKb*1024)}  (\u0438\u0437 ~${L(n.originalKb*1024)} \u0438\u0441\u0445\u043E\u0434\u043D\u044B\u0445)  \xD7${t} \u0441\u0436\u0430\u0442\u0438\u0435  (${e}%)`;console.log(u(v,"  \u2502")+u(nt,i).padEnd(r+9)+u(v,"\u2502")),console.log(u(v,`  \u2514${s}\u2518`)),console.log("")}function De(n,t,e){if(e===0)return;let r=4,s=Math.round(n/r),o=Math.round(t/r),i=s-o,a=s>0?Math.round(i/s*100):0,c=s>0?(s/Math.max(o,1)).toFixed(0):"\u2014",h=Math.round(n/e),l=Math.round(t/e),d=P=>P>=1e6?`${(P/1e6).toFixed(2)}M`:P>=1e3?`${(P/1e3).toFixed(1)}K`:String(P),p=62,m="\u2500".repeat(p),f="\u2500".repeat(p-2),w=Pe,E=(P,T)=>u(w,"  \u2502")+u(T,P).padEnd(p+9)+u(w,"\u2502");console.log(u(w,`  \u250C${m}\u2510`)),console.log(u(w,"  \u2502")+u(F+N,"  \u{1F9EE}  \u042D\u041A\u041E\u041D\u041E\u041C\u0418\u042F \u0422\u041E\u041A\u0415\u041D\u041E\u0412").padEnd(p+8)+u(w,"\u2502")),console.log(u(w,"  \u2502")+u(y,`  ${f}`).padEnd(p+8)+u(w,"\u2502")),console.log(E(`  \u{1F4C4}  \u0418\u0441\u0445\u043E\u0434\u043D\u044B\u0439 \u043A\u043E\u0434:   ~${d(s)} \u0442\u043E\u043A\u0435\u043D\u043E\u0432  (${L(n)})`,B)),console.log(E(`  \u{1F9E0}  L1+L3 \u0441\u0443\u043C\u043C\u0430\u0440\u0438:  ~${d(o)} \u0442\u043E\u043A\u0435\u043D\u043E\u0432  (${L(t)})`,v)),console.log(u(w,"  \u2502")+u(y,`  ${f}`).padEnd(p+8)+u(w,"\u2502")),console.log(E(`  \u{1F4B0}  \u042D\u043A\u043E\u043D\u043E\u043C\u0438\u044F:       ~${d(i)} \u0442\u043E\u043A\u0435\u043D\u043E\u0432  (${a}%)`,F+X)),console.log(E(`  \u{1F4CA}  \u0421\u0442\u0435\u043F\u0435\u043D\u044C \u0441\u0436\u0430\u0442\u0438\u044F: \xD7${c}  (${e} \u0444\u0430\u0439\u043B\u043E\u0432)`,M)),console.log(u(w,"  \u2502")+u(y,`  ${f}`).padEnd(p+8)+u(w,"\u2502")),console.log(E(`  \u{1F4D0}  \u0421\u0440\u0435\u0434\u043D\u0438\u0439 \u0444\u0430\u0439\u043B:   ${L(h)} \u2192 ${L(l)}`,y)),console.log(E("  \u26A1  \u041D\u0430 \u043F\u0440\u043E\u0432\u043E\u0434\u0435:     gzip \u0435\u0449\u0451 ~70% \u043C\u0435\u043D\u044C\u0448\u0435",y)),console.log(u(w,`  \u2514${m}\u2518`)),console.log("")}function Me(n){let t=[];if(n.added>0&&t.push(u(v,`+${n.added} \u043D\u043E\u0432\u044B\u0445`)),n.changed>0&&t.push(u(X,`~${n.changed} \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u043E`)),n.removed>0&&t.push(u(B,`-${n.removed} \u0443\u0434\u0430\u043B\u0435\u043D\u043E`)),t.length===0){console.log(`  ${z()}  ${u(y,"\u25CB")}  ${u(y,`Rescan: \u0431\u0435\u0437 \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u0439 (${n.unchanged} \u0444\u0430\u0439\u043B\u043E\u0432)  \u0441\u043B\u0435\u0434\u0443\u044E\u0449\u0438\u0439 \u0447\u0435\u0440\u0435\u0437 ${n.nextInMin} \u043C\u0438\u043D`)}`);return}let e=t.join(u(y,", ")),r=u(y,St(n.elapsedMs)),s=u(y,`\u0441\u043B\u0435\u0434\u0443\u044E\u0449\u0438\u0439 \u0447\u0435\u0440\u0435\u0437 ${n.nextInMin} \u043C\u0438\u043D`);console.log(`  ${z()}  ${u(M,"\u21BB")}  Rescan: ${e}  ${u(y,"|")}  \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u043E ${n.uploaded}  ${r}  ${s}`)}function Ae(n){let e="\u2500".repeat(62),r="\u2500".repeat(60),s=M,o=(m,f)=>u(s,"  \u2502")+u(f,m).padEnd(71)+u(s,"\u2502");console.log(u(s,`  \u250C${e}\u2510`)),console.log(u(s,"  \u2502")+u(F+N,"  \u{1F4CB}  \u0412\u0415\u0420\u0418\u0424\u0418\u041A\u0410\u0426\u0418\u042F \u0421\u041A\u0410\u041D\u0418\u0420\u041E\u0412\u0410\u041D\u0418\u042F").padEnd(70)+u(s,"\u2502")),console.log(u(s,"  \u2502")+u(y,`  ${r}`).padEnd(70)+u(s,"\u2502"));let i=Object.entries(n.byExt).sort((m,f)=>f[1]-m[1]);console.log(o("  \u{1F4C2}  \u041E\u0431\u0440\u0430\u0431\u043E\u0442\u0430\u043D\u043E \u043F\u043E \u0442\u0438\u043F\u0430\u043C \u0444\u0430\u0439\u043B\u043E\u0432:",F+N));for(let[m,f]of i){let w=n.compressed>0?Math.round(f/n.compressed*100):0,E="\u2588".repeat(Math.max(1,Math.round(w/5)));console.log(o(`       ${m.padEnd(8)} ${String(f).padStart(4)} \u0444\u0430\u0439\u043B(\u043E\u0432)  ${w}%  ${E}`,nt))}console.log(u(s,"  \u2502")+u(y,`  ${r}`).padEnd(70)+u(s,"\u2502"));let a=Object.entries(n.skippedByExt).sort((m,f)=>f[1]-m[1]);if(a.length>0){console.log(o("  \u{1F6AB}  \u041F\u0440\u043E\u043F\u0443\u0449\u0435\u043D\u043D\u044B\u0435 \u0440\u0430\u0441\u0448\u0438\u0440\u0435\u043D\u0438\u044F (\u043D\u0435 \u0432 \u0441\u043F\u0438\u0441\u043A\u0435 --exts):",F+X));let m=a.slice(0,10);for(let[f,w]of m)console.log(o(`       ${f.padEnd(8)} ${String(w).padStart(4)} \u0444\u0430\u0439\u043B(\u043E\u0432)`,Et));if(a.length>10){let f=a.slice(10).reduce((w,[,E])=>w+E,0);console.log(o(`       ...\u0438 \u0435\u0449\u0451 ${a.length-10} \u0442\u0438\u043F\u043E\u0432 (${f} \u0444\u0430\u0439\u043B\u043E\u0432)`,y))}console.log(u(s,"  \u2502")+u(y,`  ${r}`).padEnd(70)+u(s,"\u2502"))}let{tooLarge:c,readError:h,compressError:l}=n.skipInfo,d=c.length+h.length+l.length;if(d>0){if(console.log(o(`  \u26A0\uFE0F   \u041F\u0440\u043E\u043F\u0443\u0449\u0435\u043D\u043D\u044B\u0435 \u0444\u0430\u0439\u043B\u044B: ${d}`,F+X)),c.length>0){console.log(o(`       \u{1F5C4}\uFE0F  \u0421\u043B\u0438\u0448\u043A\u043E\u043C \u0431\u043E\u043B\u044C\u0448\u0438\u0435 (>500KB): ${c.length}`,Et));for(let m of c.slice(0,5))console.log(o(`          ${m}`,y));c.length>5&&console.log(o(`          ...\u0438 \u0435\u0449\u0451 ${c.length-5}`,y))}if(h.length>0){console.log(o(`       \u{1F4DB}  \u041E\u0448\u0438\u0431\u043A\u0438 \u0447\u0442\u0435\u043D\u0438\u044F: ${h.length}`,B));for(let m of h.slice(0,5))console.log(o(`          ${m}`,y));h.length>5&&console.log(o(`          ...\u0438 \u0435\u0449\u0451 ${h.length-5}`,y))}if(l.length>0){console.log(o(`       \u{1F527}  AST \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D (raw fallback): ${l.length}`,Et));for(let m of l.slice(0,5))console.log(o(`          ${m}`,y));l.length>5&&console.log(o(`          ...\u0438 \u0435\u0449\u0451 ${l.length-5}`,y))}console.log(u(s,"  \u2502")+u(y,`  ${r}`).padEnd(70)+u(s,"\u2502"))}let p=n.total>0?Math.round(n.compressed/n.total*100):0;if(console.log(o(`  \u2705  \u041F\u043E\u043A\u0440\u044B\u0442\u0438\u0435: ${n.compressed}/${n.total} \u0444\u0430\u0439\u043B\u043E\u0432 (${p}%)`,F+v)),a.length>0){let m=a.reduce((f,[,w])=>f+w,0);console.log(o(`  \u{1F4A1}  +${m} \u0444\u0430\u0439\u043B\u043E\u0432 \u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E \u0441 \u0440\u0430\u0441\u0448\u0438\u0440\u0435\u043D\u043D\u044B\u043C --exts`,y))}console.log(u(s,`  \u2514${e}\u2518`)),console.log("")}function je(n){console.log(""),console.log(`  ${u(M+F,"  \u{1F441}  WATCH MODE  ")}  ${u(y,n)}`),console.log(u(y,`  ${"\u2500".repeat(60)}`)),console.log(u(y,`  Ctrl+C \u0434\u043B\u044F \u043E\u0441\u0442\u0430\u043D\u043E\u0432\u043A\u0438
`))}function It(n,t,e=void 0){let r={modified:u(X,"\u270E"),added:u(v,"+"),deleted:u(B,"\u2212"),error:u(B,"\u2717")},s={modified:N,added:v,deleted:y,error:B},o=r[n]??"\xB7",i=u(s[n]??Xs,t.padEnd(40)),a=e?u(y,e):"";console.log(`  ${z()}  ${o}  ${i}  ${a}`)}function Be(n,t,e){let r=t?u(v,"\u2713 \u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D"):u(B,"\u2717 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D");console.log(`  ${z()}  ${u(nt,"\u21D7")}  ${u(y,n)}  ${r}  ${u(y,St(e))}`)}function Ne(n){return new Promise(t=>setTimeout(t,n))}function en(n,t,e){let r=`  \u21BB \u043F\u043E\u043F\u044B\u0442\u043A\u0430 ${n}/${t}: ${e}`;process.stdout.write(`\x1B[33m${r}\x1B[0m
`)}function sn(n){let t=d=>{let p=n.indexOf(d);return p!==-1?n[p+1]:void 0},e=t("--path")??process.cwd(),r=t("--server")??"",s=t("--token")??"",o=t("--project")??e.split(/[/\\]/).pop()??"default",i=n.includes("--watch"),a=t("--exts")??".ts,.tsx,.js,.jsx,.mjs,.cjs,.py,.cs,.go,.rs,.java,.kt,.swift,.rb,.php,.c,.cpp,.h,.hpp,.cc,.vue,.svelte,.html,.htm,.css,.scss,.sass,.less,.json,.yaml,.yml,.xml,.sql,.sh,.md,.graphql,.gql,.dart,.scala,.lua,.r,.ex,.exs,.proto",c=t("--ignore")??"node_modules,dist,.git,build,out,coverage,__pycache__,.venv,venv,env,.next,.nuxt,vendor,target,.cache,bin,obj,.idea,.vscode,.DS_Store,package-lock.json,yarn.lock,pnpm-lock.yaml",h=parseInt(t("--batch")??"10",10),l=parseInt(t("--interval")??"3",10);return{path:e,server:r.replace(/\/$/,""),token:s,project:o,watch:i,exts:a.split(",").map(d=>d.trim()),ignore:c.split(",").map(d=>d.trim()),batchSize:h,intervalMin:l}}function Oe(n,t,e){let r=[],s={},o=e.map(h=>h.toLowerCase()),i=new Set(t.filter(h=>h.includes("."))),a=new Set(t.filter(h=>!h.includes(".")));function c(h){let l;try{l=Zs(h,{withFileTypes:!0})}catch{return}for(let d of l){let p=String(d.name);if(p.startsWith("."))continue;let m=tn(h,p);if(d.isDirectory()){if(a.has(p))continue;c(m)}else if(d.isFile()){if(i.has(p))continue;let f=Lt(p).toLowerCase();o.includes(f)?r.push(m):f&&(s[f]=(s[f]||0)+1)}}}return c(n),{files:r,skippedByExt:s}}var nn=/import\s+(?:type\s+)?(?:\{[^}]*\}|[^;{]*)\s+from\s+['"]([^'"]+)['"]/g,rn=/require\s*\(\s*['"]([^'"]+)['"]\s*\)/g,on=/import\s*\(\s*['"]([^'"]+)['"]\s*\)/g;function an(n){let t=new Set;for(let e of[nn,rn,on]){e.lastIndex=0;let r;for(;(r=e.exec(n))!==null;)t.add(r[1])}return[...t]}var cn=[{regex:/export\s+(?:default\s+)?(?:async\s+)?function\s+(\w+)/g,type:"function",exported:!0},{regex:/export\s+(?:default\s+)?class\s+(\w+)/g,type:"class",exported:!0},{regex:/export\s+(?:default\s+)?(?:const|let|var)\s+(\w+)/g,type:"variable",exported:!0},{regex:/export\s+(?:default\s+)?(?:type|interface)\s+(\w+)/g,type:"type",exported:!0},{regex:/(?:^|\n)\s*(?:async\s+)?function\s+(\w+)/g,type:"function",exported:!1},{regex:/(?:^|\n)\s*class\s+(\w+)/g,type:"class",exported:!1}];function ln(n){let t=new Set,e=[];for(let{regex:r,type:s,exported:o}of cn){r.lastIndex=0;let i;for(;(i=r.exec(n))!==null;){let a=i[1];t.has(a)||(t.add(a),e.push({name:a,type:s,isExported:o}))}}return e}var Vt=3e3,hn=15e3,un=2e3;function We(n){if(n.length<=Vt)return n;let t=n.lastIndexOf(`
`,Vt);return n.slice(0,t>0?t:Vt)}function ze(n,t,e){if(n.length<=t)return n;let r=n.lastIndexOf(`
`,t),s=n.slice(0,r>0?r:t);return`${s}
// ... ${e}: \u043E\u0431\u0440\u0435\u0437\u0430\u043D\u043E (${n.length} \u2192 ${s.length} \u0441\u0438\u043C\u0432\u043E\u043B\u043E\u0432)`}var He={".ts":"typescript",".tsx":"typescript",".js":"javascript",".jsx":"javascript",".mjs":"javascript",".cjs":"javascript",".py":"python",".cs":"csharp",".go":"go",".rs":"rust",".java":"java",".kt":"kotlin",".kts":"kotlin",".swift":"swift",".rb":"ruby",".php":"php",".c":"c",".cpp":"cpp",".cc":"cpp",".h":"c-header",".hpp":"cpp-header",".vue":"vue",".svelte":"svelte",".html":"html",".htm":"html",".css":"css",".scss":"scss",".sass":"sass",".less":"less",".json":"json",".yaml":"yaml",".yml":"yaml",".xml":"xml",".svg":"xml",".sql":"sql",".sh":"shell",".bash":"shell",".md":"markdown",".graphql":"graphql",".gql":"graphql",".proto":"protobuf",".dart":"dart",".scala":"scala",".lua":"lua",".r":"r",".ex":"elixir",".exs":"elixir"};function qt(n,t,e,r){let s=Ct(t,n).replace(/\\/g,"/"),o;try{o=Tt(n)}catch{return r?.readError.push(s),null}if(o.size>500*1024)return r?.tooLarge.push(`${s} (${L(o.size)})`),null;let i;try{i=Ke(n,"utf-8")}catch{return r?.readError.push(s),null}let a=Ue("md5").update(i).digest("hex"),c=i.split(`
`).length,h=Lt(n).toLowerCase(),l,d;try{let w=e.compressCode(i,s,"L1"),E=e.compressCode(i,s,"L3");l=w.content,d=E.content}catch{l=We(i),d=`// ${s} (${c} lines, ${He[h]??h})`,r?.compressError.push(s)}l=ze(l,hn,"L1"),d=ze(d,un,"L3");let p=an(i),m=ln(i),f=We(i);return{path:s,hash:a,sizeBytes:o.size,language:He[h]??null,lineCount:c,l1Summary:l,l3Summary:d,imports:p,symbols:m,rawSnippet:f}}var Jt=30*1024;function rt(n){let t=n.l1Summary?.length??0,e=n.l3Summary?.length??0,r=n.rawSnippet?.length??0,s=n.path?.length??0,o=n.imports?n.imports.reduce((a,c)=>a+c.length+4,20):0,i=n.symbols?n.symbols.reduce((a,c)=>a+c.name.length+c.type.length+30,20):0;return t+e+r+s+o+i+200}function Ye(n,t=Jt){if(n.length===0)return[];let e=[...n].sort((i,a)=>rt(i)-rt(a)),r=[],s=[],o=0;for(let i of e){let a=rt(i);if(a>t){s.length>0&&(r.push({batchIndex:r.length+1,files:s}),s=[],o=0),r.push({batchIndex:r.length+1,files:[i]});continue}o+a>t&&s.length>0&&(r.push({batchIndex:r.length+1,files:s}),s=[],o=0),s.push(i),o+=a}return s.length>0&&r.push({batchIndex:r.length+1,files:s}),r}async function dn(){let n=sn(process.argv.slice(2));n.server||(A("--server \u043E\u0431\u044F\u0437\u0430\u0442\u0435\u043B\u0435\u043D  (\u043D\u0430\u043F\u0440\u0438\u043C\u0435\u0440: https://your-mcp.com)"),process.exit(1)),n.token||(A("--token \u043E\u0431\u044F\u0437\u0430\u0442\u0435\u043B\u0435\u043D"),process.exit(1)),Qs(n.path)||(A(`\u041F\u0443\u0442\u044C \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D: ${n.path}`),process.exit(1)),Ie(n.project,n.server,"0.10.0"),vt(1,3,"\u041F\u041E\u0414\u041A\u041B\u042E\u0427\u0415\u041D\u0418\u0415");let t=Date.now(),e=new bt({serverUrl:n.server,authToken:n.token,projectId:n.project,batchSize:n.batchSize,onRetry:en,onSplit:(g,x,b)=>{let I="  ".repeat(b);U(`${I}\u26A1 \u0414\u0440\u043E\u0431\u043B\u0435\u043D\u0438\u0435 \u0431\u0430\u0442\u0447\u0430: ${g} \u2192 ${x} + ${g-x} \u0444\u0430\u0439\u043B\u043E\u0432 (\u0433\u043B\u0443\u0431\u0438\u043D\u0430 ${b})`)}});Kt(`\u041F\u043E\u0434\u043A\u043B\u044E\u0447\u0435\u043D\u0438\u0435 \u043A ${n.server}...`);let r=await e.healthCheck();Gt(),Be(n.server,r,Date.now()-t),r||(A(`\u0421\u0435\u0440\u0432\u0435\u0440 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D: ${n.server}`),process.exit(1)),vt(2,3,"\u0421\u041A\u0410\u041D\u0418\u0420\u041E\u0412\u0410\u041D\u0418\u0415 \u0418 \u0421\u0416\u0410\u0422\u0418\u0415"),Z(`\u041F\u0443\u0442\u044C:  ${n.path}`),Z(`\u0420\u0430\u0441\u0448:  ${n.exts.join(", ")}   Smart Batch: \u2264${Math.round(Jt/1024)} \u041A\u0411`);let s=Date.now(),o=Oe(n.path,n.ignore,n.exts),i=o.files;Q(`\u041D\u0430\u0439\u0434\u0435\u043D\u043E ${i.length} \u0444\u0430\u0439\u043B\u043E\u0432  (${L(i.reduce((g,x)=>{try{return g+Tt(x).size}catch{return g}},0))} \u0438\u0441\u0445\u043E\u0434\u043D\u044B\u0445)`);let a=Object.values(o.skippedByExt).reduce((g,x)=>g+x,0);if(a>0){let g=Object.entries(o.skippedByExt).sort((x,b)=>b[1]-x[1]).slice(0,5).map(([x,b])=>`${x}(${b})`).join(", ");U(`${a} \u0444\u0430\u0439\u043B\u043E\u0432 \u043F\u0440\u043E\u043F\u0443\u0449\u0435\u043D\u043E (\u0440\u0430\u0441\u0448\u0438\u0440\u0435\u043D\u0438\u0435 \u043D\u0435 \u0432 --exts): ${g}`)}let c={info:()=>{},warn:()=>{},error:()=>{},debug:()=>{},trace:()=>{},fatal:()=>{}},h=new _t(c),l=[],d={tooLarge:[],readError:[],compressError:[]};for(let g=0;g<i.length;g++){let x=i[g];Ce(g+1,i.length,Ct(n.path,x).replace(/\\/g,"/"));let b=qt(x,n.path,h,d);b&&l.push(b)}let p=d.tooLarge.length+d.readError.length,m=Date.now()-s,f=Math.round(i.reduce((g,x)=>{try{return g+Tt(x).size}catch{return g}},0)/1024),w=Math.round(l.reduce((g,x)=>g+x.l1Summary.length,0)/1024),E=f>0?(f/Math.max(w,1)).toFixed(1):"\u2014";Q(`\u0421\u0436\u0430\u0442\u043E ${l.length} \u0444\u0430\u0439\u043B\u043E\u0432 \u0437\u0430 ${(m/1e3).toFixed(1)}\u0441  \u2192  ${L(w*1024)}  (\xD7${E})`),p>0&&U(`${p} \u0444\u0430\u0439\u043B\u043E\u0432 \u043F\u0440\u043E\u043F\u0443\u0449\u0435\u043D\u043E (\u0441\u043B\u0438\u0448\u043A\u043E\u043C \u0431\u043E\u043B\u044C\u0448\u0438\u0435 \u0438\u043B\u0438 \u043D\u0435\u0447\u0438\u0442\u0430\u0435\u043C\u044B\u0435)`),d.compressError.length>0&&Z(`${d.compressError.length} \u0444\u0430\u0439\u043B\u043E\u0432 \u0431\u0435\u0437 AST (raw fallback)`),vt(3,3,"\u0417\u0410\u0413\u0420\u0423\u0417\u041A\u0410");let P=Ye(l),T=P.length;Z(`${T} \u0431\u0430\u0442\u0447\u0435\u0439 (smart: \u2264${Math.round(Jt/1024)} \u041A\u0411/\u0431\u0430\u0442\u0447)`),ke();let Xt=Date.now(),tt=0,H=[],Zt=new Set;for(let g=0;g<P.length;g++){let x=P[g],I=(x.files.reduce((V,k)=>V+rt(k),0)/1024).toFixed(1);Kt(`\u0411\u0430\u0442\u0447 ${x.batchIndex}/${T} (${x.files.length} \u0444\u0430\u0439\u043B\u043E\u0432, ~${I} \u041A\u0411)...`);let S=await e.pushBatchAdaptive(x.files);Gt(),tt+=S.uploaded.length;for(let V of S.uploaded)Zt.add(V.path);H.push(...S.failed);let G=Date.now()-Xt,W=T>1?` ~${((T-g-1)*(G/(g+1))/1e3).toFixed(0)}\u0441`:"";S.failed.length===0?Q(`  \u0411\u0430\u0442\u0447 ${x.batchIndex}/${T}: ${x.files.length} \u0444\u0430\u0439\u043B\u043E\u0432 \u2713${W}`):S.uploaded.length>0?U(`  \u0411\u0430\u0442\u0447 ${x.batchIndex}/${T}: ${S.uploaded.length} \u2713 / ${S.failed.length} \u2717${W}`):A(`  \u0411\u0430\u0442\u0447 ${x.batchIndex}/${T}: \u0432\u0441\u0435 ${x.files.length} \u0444\u0430\u0439\u043B\u043E\u0432 \u2717${W}`),g<P.length-1&&await Ne(150)}let Ge=Date.now()-Xt;if(Le(T,T,tt,L(w*1024),H.length===0),Q(`\u0417\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u043E: ${tt} \u0444\u0430\u0439\u043B\u043E\u0432 \u0437\u0430 ${(Ge/1e3).toFixed(1)}\u0441 (${T} \u0431\u0430\u0442\u0447\u0435\u0439)`),H.length>0){U(`  ${H.length} \u0444\u0430\u0439\u043B\u043E\u0432 \u043D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C:`);for(let g of H.slice(0,10))A(`    \u2717 ${g.path} (~${(rt(g)/1024).toFixed(1)} \u041A\u0411)`);H.length>10&&A(`    ... \u0438 \u0435\u0449\u0451 ${H.length-10}`)}Fe({files:tt,batches:T,originalKb:f,summaryKb:w,elapsedMs:Date.now()-s,errors:H.length+p});let Ve=i.reduce((g,x)=>{try{return g+Tt(x).size}catch{return g}},0),qe=l.reduce((g,x)=>g+x.l1Summary.length+x.l3Summary.length,0);De(Ve,qe,tt);let kt={};for(let g of l){let x=Lt(g.path).toLowerCase()||"(\u0431\u0435\u0437 \u0440\u0430\u0441\u0448.)";kt[x]=(kt[x]||0)+1}Ae({byExt:kt,skipInfo:d,total:i.length+a,compressed:l.length,skippedByExt:o.skippedByExt});let O=new Map;for(let g of l)Zt.has(g.path)&&O.set(g.path,g.hash);let Je=n.intervalMin*60*1e3,Ft=!1,Xe=async()=>{if(Ft)return;Ft=!0;let g=Date.now();try{let{files:x}=Oe(n.path,n.ignore,n.exts),b=new Set,I=[],S=0,G=0;for(let k of x){let ot=(()=>{try{return Ke(k,"utf-8")}catch{return null}})();if(!ot)continue;let Y=Ct(n.path,k).replace(/\\/g,"/");b.add(Y);let q=Ue("md5").update(ot).digest("hex"),te=O.get(Y);if(te===q)continue;let ee=qt(k,n.path,h);ee&&(I.push(ee),te===void 0?S++:G++)}let W=[];for(let[k]of O)b.has(k)||W.push(k);for(let k of W)O.delete(k);let V=0;if(I.length>0){let k=Ye(I);for(let ot of k){let Y=await e.pushBatchAdaptive(ot.files);V+=Y.uploaded.length;for(let q of Y.uploaded)O.set(q.path,q.hash);for(let q of Y.failed)O.delete(q.path);Y.failed.length>0&&A(`  Rescan: ${Y.failed.length} \u0444\u0430\u0439\u043B\u043E\u0432 \u043D\u0435 \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u043E`),await Ne(150)}}Me({changed:G,added:S,removed:W.length,unchanged:b.size-I.length,uploaded:V,elapsedMs:Date.now()-g,nextInMin:n.intervalMin})}catch(x){A(`Rescan \u043E\u0448\u0438\u0431\u043A\u0430: ${String(x)}`)}finally{Ft=!1}},Qt=setInterval(()=>void Xe(),Je);if(Q(`Periodic rescan \u043A\u0430\u0436\u0434\u044B\u0435 ${n.intervalMin} \u043C\u0438\u043D (${O.size} \u0444\u0430\u0439\u043B\u043E\u0432 \u043E\u0442\u0441\u043B\u0435\u0436\u0438\u0432\u0430\u044E\u0442\u0441\u044F)`),n.watch){je(n.path);let g=Ee.watch(n.path,{ignored:b=>b.split(/[/\\]/).some(S=>n.ignore.includes(S)||S.startsWith(".")),ignoreInitial:!0,persistent:!0}),x=async(b,I)=>{if(!n.exts.includes(Lt(b)))return;let S=qt(b,n.path,h);if(!S)return;O.set(S.path,S.hash);let G=`${L(S.sizeBytes)} \u2192 ${L(S.l1Summary.length)} \u0441\u0443\u043C\u043C\u0430\u0440\u0438`;try{await e.pushBatch([S]),It(I,S.path,G)}catch(W){It("error",S.path,String(W))}};g.on("change",b=>void x(b,"modified")),g.on("add",b=>void x(b,"added")),g.on("unlink",b=>{let I=Ct(n.path,b).replace(/\\/g,"/");O.delete(I),It("deleted",I,"\u0443\u0434\u0430\u043B\u0451\u043D \u0438\u0437 \u0438\u043D\u0434\u0435\u043A\u0441\u0430")}),process.on("SIGINT",async()=>{console.log(""),U("\u041E\u0441\u0442\u0430\u043D\u043E\u0432\u043A\u0430 \u0432\u043E\u0442\u0447\u0435\u0440\u0430..."),clearInterval(Qt),await g.close(),process.exit(0)})}else Te("\u0421\u043E\u0432\u0435\u0442: \u0434\u043E\u0431\u0430\u0432\u044C --watch \u0434\u043B\u044F \u043C\u0433\u043D\u043E\u0432\u0435\u043D\u043D\u043E\u0439 \u0440\u0435\u0430\u043A\u0446\u0438\u0438 \u043D\u0430 \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u044F \u0444\u0430\u0439\u043B\u043E\u0432"),Z("\u041F\u0440\u043E\u0446\u0435\u0441\u0441 \u043E\u0441\u0442\u0430\u0451\u0442\u0441\u044F \u0437\u0430\u043F\u0443\u0449\u0435\u043D\u043D\u044B\u043C \u0434\u043B\u044F periodic rescan. Ctrl+C \u0434\u043B\u044F \u043E\u0441\u0442\u0430\u043D\u043E\u0432\u043A\u0438."),process.on("SIGINT",()=>{console.log(""),U("\u041E\u0441\u0442\u0430\u043D\u043E\u0432\u043A\u0430..."),clearInterval(Qt),process.exit(0)})}dn().catch(n=>{A(`\u041A\u0440\u0438\u0442\u0438\u0447\u0435\u0441\u043A\u0430\u044F \u043E\u0448\u0438\u0431\u043A\u0430: ${String(n)}`),process.exit(1)});
/*! Bundled license information:

chokidar/esm/index.js:
  (*! chokidar - MIT License (c) 2012 Paul Miller (paulmillr.com) *)
*/
