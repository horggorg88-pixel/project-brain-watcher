#!/usr/bin/env node
import{createRequire}from'module';const require=createRequire(import.meta.url);
import{createHash as ts}from"node:crypto";import{readFileSync as se,writeFileSync as Ge,mkdirSync as ln,statSync as Mt,readdirSync as hn,existsSync as Dt}from"node:fs";import{join as it,relative as At,extname as jt}from"node:path";import{stat as js}from"fs";import{stat as Bs,readdir as Ns}from"fs/promises";import{EventEmitter as Os}from"events";import*as x from"path";import{stat as cs,lstat as he,readdir as ls,realpath as hs}from"node:fs/promises";import{Readable as us}from"node:stream";import{resolve as ue,relative as ps,join as ds,sep as ms}from"node:path";var C={FILE_TYPE:"files",DIR_TYPE:"directories",FILE_DIR_TYPE:"files_directories",EVERYTHING_TYPE:"all"},Nt={root:".",fileFilter:n=>!0,directoryFilter:n=>!0,type:C.FILE_TYPE,lstat:!1,depth:2147483648,alwaysStat:!1,highWaterMark:4096};Object.freeze(Nt);var ge="READDIRP_RECURSIVE_ERROR",gs=new Set(["ENOENT","EPERM","EACCES","ELOOP",ge]),pe=[C.DIR_TYPE,C.EVERYTHING_TYPE,C.FILE_DIR_TYPE,C.FILE_TYPE],fs=new Set([C.DIR_TYPE,C.EVERYTHING_TYPE,C.FILE_DIR_TYPE]),ys=new Set([C.EVERYTHING_TYPE,C.FILE_DIR_TYPE,C.FILE_TYPE]),ws=n=>gs.has(n.code),bs=process.platform==="win32",de=n=>!0,me=n=>{if(n===void 0)return de;if(typeof n=="function")return n;if(typeof n=="string"){let t=n.trim();return e=>e.basename===t}if(Array.isArray(n)){let t=n.map(e=>e.trim());return e=>t.some(r=>e.basename===r)}return de},Ot=class extends us{constructor(t={}){super({objectMode:!0,autoDestroy:!0,highWaterMark:t.highWaterMark});let e={...Nt,...t},{root:r,type:s}=e;this._fileFilter=me(e.fileFilter),this._directoryFilter=me(e.directoryFilter);let o=e.lstat?he:cs;bs?this._stat=i=>o(i,{bigint:!0}):this._stat=o,this._maxDepth=e.depth??Nt.depth,this._wantsDir=s?fs.has(s):!1,this._wantsFile=s?ys.has(s):!1,this._wantsEverything=s===C.EVERYTHING_TYPE,this._root=ue(r),this._isDirent=!e.alwaysStat,this._statsProp=this._isDirent?"dirent":"stats",this._rdOptions={encoding:"utf8",withFileTypes:this._isDirent},this.parents=[this._exploreDir(r,1)],this.reading=!1,this.parent=void 0}async _read(t){if(!this.reading){this.reading=!0;try{for(;!this.destroyed&&t>0;){let e=this.parent,r=e&&e.files;if(r&&r.length>0){let{path:s,depth:o}=e,i=r.splice(0,t).map(c=>this._formatEntry(c,s)),a=await Promise.all(i);for(let c of a){if(!c)continue;if(this.destroyed)return;let h=await this._getEntryType(c);h==="directory"&&this._directoryFilter(c)?(o<=this._maxDepth&&this.parents.push(this._exploreDir(c.fullPath,o+1)),this._wantsDir&&(this.push(c),t--)):(h==="file"||this._includeAsFile(c))&&this._fileFilter(c)&&this._wantsFile&&(this.push(c),t--)}}else{let s=this.parents.pop();if(!s){this.push(null);break}if(this.parent=await s,this.destroyed)return}}}catch(e){this.destroy(e)}finally{this.reading=!1}}}async _exploreDir(t,e){let r;try{r=await ls(t,this._rdOptions)}catch(s){this._onError(s)}return{files:r,depth:e,path:t}}async _formatEntry(t,e){let r,s=this._isDirent?t.name:t;try{let o=ue(ds(e,s));r={path:ps(this._root,o),fullPath:o,basename:s},r[this._statsProp]=this._isDirent?t:await this._stat(o)}catch(o){this._onError(o);return}return r}_onError(t){ws(t)&&!this.destroyed?this.emit("warn",t):this.destroy(t)}async _getEntryType(t){if(!t&&this._statsProp in t)return"";let e=t[this._statsProp];if(e.isFile())return"file";if(e.isDirectory())return"directory";if(e&&e.isSymbolicLink()){let r=t.fullPath;try{let s=await hs(r),o=await he(s);if(o.isFile())return"file";if(o.isDirectory()){let i=s.length;if(r.startsWith(s)&&r.substr(i,1)===ms){let a=new Error(`Circular symlink detected: "${r}" points to "${s}"`);return a.code=ge,this._onError(a)}return"directory"}}catch(s){return this._onError(s),""}}}_includeAsFile(t){let e=t&&t[this._statsProp];return e&&this._wantsEverything&&!e.isDirectory()}};function fe(n,t={}){let e=t.entryType||t.type;if(e==="both"&&(e=C.FILE_DIR_TYPE),e&&(t.type=e),n){if(typeof n!="string")throw new TypeError("readdirp: root argument must be a string. Usage: readdirp(root, options)");if(e&&!pe.includes(e))throw new Error(`readdirp: Invalid type passed. Use one of ${pe.join(", ")}`)}else throw new Error("readdirp: root argument is required. Usage: readdirp(root, options)");return t.root=n,new Ot(t)}import{watchFile as xs,unwatchFile as ye,watch as _s}from"fs";import{open as Es,stat as be,lstat as $s,realpath as Wt}from"fs/promises";import*as $ from"path";import{type as Ss}from"os";var Is="data",Ut="end",xe="close",gt=()=>{};var ft=process.platform,Yt=ft==="win32",Rs=ft==="darwin",vs=ft==="linux",Ps=ft==="freebsd",_e=Ss()==="OS400",I={ALL:"all",READY:"ready",ADD:"add",CHANGE:"change",ADD_DIR:"addDir",UNLINK:"unlink",UNLINK_DIR:"unlinkDir",RAW:"raw",ERROR:"error"},A=I,Cs="watch",Ts={lstat:$s,stat:be},J="listeners",ut="errHandlers",et="rawEmitters",Ls=[J,ut,et],Fs=new Set(["3dm","3ds","3g2","3gp","7z","a","aac","adp","afdesign","afphoto","afpub","ai","aif","aiff","alz","ape","apk","appimage","ar","arj","asf","au","avi","bak","baml","bh","bin","bk","bmp","btif","bz2","bzip2","cab","caf","cgm","class","cmx","cpio","cr2","cur","dat","dcm","deb","dex","djvu","dll","dmg","dng","doc","docm","docx","dot","dotm","dra","DS_Store","dsk","dts","dtshd","dvb","dwg","dxf","ecelp4800","ecelp7470","ecelp9600","egg","eol","eot","epub","exe","f4v","fbs","fh","fla","flac","flatpak","fli","flv","fpx","fst","fvt","g3","gh","gif","graffle","gz","gzip","h261","h263","h264","icns","ico","ief","img","ipa","iso","jar","jpeg","jpg","jpgv","jpm","jxr","key","ktx","lha","lib","lvp","lz","lzh","lzma","lzo","m3u","m4a","m4v","mar","mdi","mht","mid","midi","mj2","mka","mkv","mmr","mng","mobi","mov","movie","mp3","mp4","mp4a","mpeg","mpg","mpga","mxu","nef","npx","numbers","nupkg","o","odp","ods","odt","oga","ogg","ogv","otf","ott","pages","pbm","pcx","pdb","pdf","pea","pgm","pic","png","pnm","pot","potm","potx","ppa","ppam","ppm","pps","ppsm","ppsx","ppt","pptm","pptx","psd","pya","pyc","pyo","pyv","qt","rar","ras","raw","resources","rgb","rip","rlc","rmf","rmvb","rpm","rtf","rz","s3m","s7z","scpt","sgi","shar","snap","sil","sketch","slk","smv","snk","so","stl","suo","sub","swf","tar","tbz","tbz2","tga","tgz","thmx","tif","tiff","tlz","ttc","ttf","txz","udf","uvh","uvi","uvm","uvp","uvs","uvu","viv","vob","war","wav","wax","wbmp","wdp","weba","webm","webp","whl","wim","wm","wma","wmv","wmx","woff","woff2","wrm","wvx","xbm","xif","xla","xlam","xls","xlsb","xlsm","xlsx","xlt","xltm","xltx","xm","xmind","xpi","xpm","xwd","xz","z","zip","zipx"]),ks=n=>Fs.has($.extname(n).slice(1).toLowerCase()),Ht=(n,t)=>{n instanceof Set?n.forEach(t):t(n)},nt=(n,t,e)=>{let r=n[t];r instanceof Set||(n[t]=r=new Set([r])),r.add(e)},Ms=n=>t=>{let e=n[t];e instanceof Set?e.clear():delete n[t]},rt=(n,t,e)=>{let r=n[t];r instanceof Set?r.delete(e):r===e&&delete n[t]},Ee=n=>n instanceof Set?n.size===0:!n,pt=new Map;function we(n,t,e,r,s){let o=(i,a)=>{e(n),s(i,a,{watchedPath:n}),a&&n!==a&&dt($.resolve(n,a),J,$.join(n,a))};try{return _s(n,{persistent:t.persistent},o)}catch(i){r(i);return}}var dt=(n,t,e,r,s)=>{let o=pt.get(n);o&&Ht(o[t],i=>{i(e,r,s)})},As=(n,t,e,r)=>{let{listener:s,errHandler:o,rawEmitter:i}=r,a=pt.get(t),c;if(!e.persistent)return c=we(n,e,s,o,i),c?c.close.bind(c):void 0;if(a)nt(a,J,s),nt(a,ut,o),nt(a,et,i);else{if(c=we(n,e,dt.bind(null,t,J),o,dt.bind(null,t,et)),!c)return;c.on(A.ERROR,async h=>{let l=dt.bind(null,t,ut);if(a&&(a.watcherUnusable=!0),Yt&&h.code==="EPERM")try{await(await Es(n,"r")).close(),l(h)}catch{}else l(h)}),a={listeners:s,errHandlers:o,rawEmitters:i,watcher:c},pt.set(t,a)}return()=>{rt(a,J,s),rt(a,ut,o),rt(a,et,i),Ee(a.listeners)&&(a.watcher.close(),pt.delete(t),Ls.forEach(Ms(a)),a.watcher=void 0,Object.freeze(a))}},zt=new Map,Ds=(n,t,e,r)=>{let{listener:s,rawEmitter:o}=r,i=zt.get(t),a=i&&i.options;return a&&(a.persistent<e.persistent||a.interval>e.interval)&&(ye(t),i=void 0),i?(nt(i,J,s),nt(i,et,o)):(i={listeners:s,rawEmitters:o,options:e,watcher:xs(t,e,(c,h)=>{Ht(i.rawEmitters,p=>{p(A.CHANGE,t,{curr:c,prev:h})});let l=c.mtimeMs;(c.size!==h.size||l>h.mtimeMs||l===0)&&Ht(i.listeners,p=>p(n,c))})},zt.set(t,i)),()=>{rt(i,J,s),rt(i,et,o),Ee(i.listeners)&&(zt.delete(t),ye(t),i.options=i.watcher=void 0,Object.freeze(i))}},mt=class{constructor(t){this.fsw=t,this._boundHandleError=e=>t._handleError(e)}_watchWithNodeFs(t,e){let r=this.fsw.options,s=$.dirname(t),o=$.basename(t);this.fsw._getWatchedDir(s).add(o);let a=$.resolve(t),c={persistent:r.persistent};e||(e=gt);let h;if(r.usePolling){let l=r.interval!==r.binaryInterval;c.interval=l&&ks(o)?r.binaryInterval:r.interval,h=Ds(t,a,c,{listener:e,rawEmitter:this.fsw._emitRaw})}else h=As(t,a,c,{listener:e,errHandler:this._boundHandleError,rawEmitter:this.fsw._emitRaw});return h}_handleFile(t,e,r){if(this.fsw.closed)return;let s=$.dirname(t),o=$.basename(t),i=this.fsw._getWatchedDir(s),a=e;if(i.has(o))return;let c=async(l,p)=>{if(this.fsw._throttle(Cs,t,5)){if(!p||p.mtimeMs===0)try{let d=await be(t);if(this.fsw.closed)return;let m=d.atimeMs,g=d.mtimeMs;if((!m||m<=g||g!==a.mtimeMs)&&this.fsw._emit(A.CHANGE,t,d),(Rs||vs||Ps)&&a.ino!==d.ino){this.fsw._closeFile(l),a=d;let w=this._watchWithNodeFs(t,c);w&&this.fsw._addPathCloser(l,w)}else a=d}catch{this.fsw._remove(s,o)}else if(i.has(o)){let d=p.atimeMs,m=p.mtimeMs;(!d||d<=m||m!==a.mtimeMs)&&this.fsw._emit(A.CHANGE,t,p),a=p}}},h=this._watchWithNodeFs(t,c);if(!(r&&this.fsw.options.ignoreInitial)&&this.fsw._isntIgnored(t)){if(!this.fsw._throttle(A.ADD,t,0))return;this.fsw._emit(A.ADD,t,e)}return h}async _handleSymlink(t,e,r,s){if(this.fsw.closed)return;let o=t.fullPath,i=this.fsw._getWatchedDir(e);if(!this.fsw.options.followSymlinks){this.fsw._incrReadyCount();let a;try{a=await Wt(r)}catch{return this.fsw._emitReady(),!0}return this.fsw.closed?void 0:(i.has(s)?this.fsw._symlinkPaths.get(o)!==a&&(this.fsw._symlinkPaths.set(o,a),this.fsw._emit(A.CHANGE,r,t.stats)):(i.add(s),this.fsw._symlinkPaths.set(o,a),this.fsw._emit(A.ADD,r,t.stats)),this.fsw._emitReady(),!0)}if(this.fsw._symlinkPaths.has(o))return!0;this.fsw._symlinkPaths.set(o,!0)}_handleRead(t,e,r,s,o,i,a){if(t=$.join(t,""),a=this.fsw._throttle("readdir",t,1e3),!a)return;let c=this.fsw._getWatchedDir(r.path),h=new Set,l=this.fsw._readdirp(t,{fileFilter:p=>r.filterPath(p),directoryFilter:p=>r.filterDir(p)});if(l)return l.on(Is,async p=>{if(this.fsw.closed){l=void 0;return}let d=p.path,m=$.join(t,d);if(h.add(d),!(p.stats.isSymbolicLink()&&await this._handleSymlink(p,t,m,d))){if(this.fsw.closed){l=void 0;return}(d===s||!s&&!c.has(d))&&(this.fsw._incrReadyCount(),m=$.join(o,$.relative(o,m)),this._addToNodeFs(m,e,r,i+1))}}).on(A.ERROR,this._boundHandleError),new Promise((p,d)=>{if(!l)return d();l.once(Ut,()=>{if(this.fsw.closed){l=void 0;return}let m=a?a.clear():!1;p(void 0),c.getChildren().filter(g=>g!==t&&!h.has(g)).forEach(g=>{this.fsw._remove(t,g)}),l=void 0,m&&this._handleRead(t,!1,r,s,o,i,a)})})}async _handleDir(t,e,r,s,o,i,a){let c=this.fsw._getWatchedDir($.dirname(t)),h=c.has($.basename(t));!(r&&this.fsw.options.ignoreInitial)&&!o&&!h&&this.fsw._emit(A.ADD_DIR,t,e),c.add($.basename(t)),this.fsw._getWatchedDir(t);let l,p,d=this.fsw.options.depth;if((d==null||s<=d)&&!this.fsw._symlinkPaths.has(a)){if(!o&&(await this._handleRead(t,r,i,o,t,s,l),this.fsw.closed))return;p=this._watchWithNodeFs(t,(m,g)=>{g&&g.mtimeMs===0||this._handleRead(m,!1,i,o,t,s,l)})}return p}async _addToNodeFs(t,e,r,s,o){let i=this.fsw._emitReady;if(this.fsw._isIgnored(t)||this.fsw.closed)return i(),!1;let a=this.fsw._getWatchHelpers(t);r&&(a.filterPath=c=>r.filterPath(c),a.filterDir=c=>r.filterDir(c));try{let c=await Ts[a.statMethod](a.watchPath);if(this.fsw.closed)return;if(this.fsw._isIgnored(a.watchPath,c))return i(),!1;let h=this.fsw.options.followSymlinks,l;if(c.isDirectory()){let p=$.resolve(t),d=h?await Wt(t):t;if(this.fsw.closed||(l=await this._handleDir(a.watchPath,c,e,s,o,a,d),this.fsw.closed))return;p!==d&&d!==void 0&&this.fsw._symlinkPaths.set(p,d)}else if(c.isSymbolicLink()){let p=h?await Wt(t):t;if(this.fsw.closed)return;let d=$.dirname(a.watchPath);if(this.fsw._getWatchedDir(d).add(a.watchPath),this.fsw._emit(A.ADD,a.watchPath,c),l=await this._handleDir(d,c,e,s,t,a,p),this.fsw.closed)return;p!==void 0&&this.fsw._symlinkPaths.set($.resolve(t),p)}else l=this._handleFile(a.watchPath,c,e);return i(),l&&this.fsw._addPathCloser(t,l),!1}catch(c){if(this.fsw._handleError(c))return i(),t}}};var Kt="/",Ws="//",Pe=".",zs="..",Hs="string",Us=/\\/g,$e=/\/\//,Ys=/\..*\.(sw[px])$|~$|\.subl.*\.tmp/,Ks=/^\.[/\\]/;function yt(n){return Array.isArray(n)?n:[n]}var Gt=n=>typeof n=="object"&&n!==null&&!(n instanceof RegExp);function Gs(n){return typeof n=="function"?n:typeof n=="string"?t=>n===t:n instanceof RegExp?t=>n.test(t):typeof n=="object"&&n!==null?t=>{if(n.path===t)return!0;if(n.recursive){let e=x.relative(n.path,t);return e?!e.startsWith("..")&&!x.isAbsolute(e):!1}return!1}:()=>!1}function Vs(n){if(typeof n!="string")throw new Error("string expected");n=x.normalize(n),n=n.replace(/\\/g,"/");let t=!1;n.startsWith("//")&&(t=!0);let e=/\/\//;for(;n.match(e);)n=n.replace(e,"/");return t&&(n="/"+n),n}function Se(n,t,e){let r=Vs(t);for(let s=0;s<n.length;s++){let o=n[s];if(o(r,e))return!0}return!1}function qs(n,t){if(n==null)throw new TypeError("anymatch: specify first argument");let r=yt(n).map(s=>Gs(s));return t==null?(s,o)=>Se(r,s,o):Se(r,t)}var Ie=n=>{let t=yt(n).flat();if(!t.every(e=>typeof e===Hs))throw new TypeError(`Non-string provided as watch path: ${t}`);return t.map(Ce)},Re=n=>{let t=n.replace(Us,Kt),e=!1;for(t.startsWith(Ws)&&(e=!0);t.match($e);)t=t.replace($e,Kt);return e&&(t=Kt+t),t},Ce=n=>Re(x.normalize(Re(n))),ve=(n="")=>t=>typeof t=="string"?Ce(x.isAbsolute(t)?t:x.join(n,t)):t,Js=(n,t)=>x.isAbsolute(n)?n:x.join(t,n),Xs=Object.freeze(new Set),Vt=class{constructor(t,e){this.path=t,this._removeWatcher=e,this.items=new Set}add(t){let{items:e}=this;e&&t!==Pe&&t!==zs&&e.add(t)}async remove(t){let{items:e}=this;if(!e||(e.delete(t),e.size>0))return;let r=this.path;try{await Ns(r)}catch{this._removeWatcher&&this._removeWatcher(x.dirname(r),x.basename(r))}}has(t){let{items:e}=this;if(e)return e.has(t)}getChildren(){let{items:t}=this;return t?[...t.values()]:[]}dispose(){this.items.clear(),this.path="",this._removeWatcher=gt,this.items=Xs,Object.freeze(this)}},Zs="stat",Qs="lstat",qt=class{constructor(t,e,r){this.fsw=r;let s=t;this.path=t=t.replace(Ks,""),this.watchPath=s,this.fullWatchPath=x.resolve(s),this.dirParts=[],this.dirParts.forEach(o=>{o.length>1&&o.pop()}),this.followSymlinks=e,this.statMethod=e?Zs:Qs}entryPath(t){return x.join(this.watchPath,x.relative(this.watchPath,t.fullPath))}filterPath(t){let{stats:e}=t;if(e&&e.isSymbolicLink())return this.filterDir(t);let r=this.entryPath(t);return this.fsw._isntIgnored(r,e)&&this.fsw._hasReadPermissions(e)}filterDir(t){return this.fsw._isntIgnored(this.entryPath(t),t.stats)}},wt=class extends Os{constructor(t={}){super(),this.closed=!1,this._closers=new Map,this._ignoredPaths=new Set,this._throttled=new Map,this._streams=new Set,this._symlinkPaths=new Map,this._watched=new Map,this._pendingWrites=new Map,this._pendingUnlinks=new Map,this._readyCount=0,this._readyEmitted=!1;let e=t.awaitWriteFinish,r={stabilityThreshold:2e3,pollInterval:100},s={persistent:!0,ignoreInitial:!1,ignorePermissionErrors:!1,interval:100,binaryInterval:300,followSymlinks:!0,usePolling:!1,atomic:!0,...t,ignored:t.ignored?yt(t.ignored):yt([]),awaitWriteFinish:e===!0?r:typeof e=="object"?{...r,...e}:!1};_e&&(s.usePolling=!0),s.atomic===void 0&&(s.atomic=!s.usePolling);let o=process.env.CHOKIDAR_USEPOLLING;if(o!==void 0){let c=o.toLowerCase();c==="false"||c==="0"?s.usePolling=!1:c==="true"||c==="1"?s.usePolling=!0:s.usePolling=!!c}let i=process.env.CHOKIDAR_INTERVAL;i&&(s.interval=Number.parseInt(i,10));let a=0;this._emitReady=()=>{a++,a>=this._readyCount&&(this._emitReady=gt,this._readyEmitted=!0,process.nextTick(()=>this.emit(I.READY)))},this._emitRaw=(...c)=>this.emit(I.RAW,...c),this._boundRemove=this._remove.bind(this),this.options=s,this._nodeFsHandler=new mt(this),Object.freeze(s)}_addIgnoredPath(t){if(Gt(t)){for(let e of this._ignoredPaths)if(Gt(e)&&e.path===t.path&&e.recursive===t.recursive)return}this._ignoredPaths.add(t)}_removeIgnoredPath(t){if(this._ignoredPaths.delete(t),typeof t=="string")for(let e of this._ignoredPaths)Gt(e)&&e.path===t&&this._ignoredPaths.delete(e)}add(t,e,r){let{cwd:s}=this.options;this.closed=!1,this._closePromise=void 0;let o=Ie(t);return s&&(o=o.map(i=>Js(i,s))),o.forEach(i=>{this._removeIgnoredPath(i)}),this._userIgnored=void 0,this._readyCount||(this._readyCount=0),this._readyCount+=o.length,Promise.all(o.map(async i=>{let a=await this._nodeFsHandler._addToNodeFs(i,!r,void 0,0,e);return a&&this._emitReady(),a})).then(i=>{this.closed||i.forEach(a=>{a&&this.add(x.dirname(a),x.basename(e||a))})}),this}unwatch(t){if(this.closed)return this;let e=Ie(t),{cwd:r}=this.options;return e.forEach(s=>{!x.isAbsolute(s)&&!this._closers.has(s)&&(r&&(s=x.join(r,s)),s=x.resolve(s)),this._closePath(s),this._addIgnoredPath(s),this._watched.has(s)&&this._addIgnoredPath({path:s,recursive:!0}),this._userIgnored=void 0}),this}close(){if(this._closePromise)return this._closePromise;this.closed=!0,this.removeAllListeners();let t=[];return this._closers.forEach(e=>e.forEach(r=>{let s=r();s instanceof Promise&&t.push(s)})),this._streams.forEach(e=>e.destroy()),this._userIgnored=void 0,this._readyCount=0,this._readyEmitted=!1,this._watched.forEach(e=>e.dispose()),this._closers.clear(),this._watched.clear(),this._streams.clear(),this._symlinkPaths.clear(),this._throttled.clear(),this._closePromise=t.length?Promise.all(t).then(()=>{}):Promise.resolve(),this._closePromise}getWatched(){let t={};return this._watched.forEach((e,r)=>{let o=(this.options.cwd?x.relative(this.options.cwd,r):r)||Pe;t[o]=e.getChildren().sort()}),t}emitWithAll(t,e){this.emit(t,...e),t!==I.ERROR&&this.emit(I.ALL,t,...e)}async _emit(t,e,r){if(this.closed)return;let s=this.options;Yt&&(e=x.normalize(e)),s.cwd&&(e=x.relative(s.cwd,e));let o=[e];r!=null&&o.push(r);let i=s.awaitWriteFinish,a;if(i&&(a=this._pendingWrites.get(e)))return a.lastChange=new Date,this;if(s.atomic){if(t===I.UNLINK)return this._pendingUnlinks.set(e,[t,...o]),setTimeout(()=>{this._pendingUnlinks.forEach((c,h)=>{this.emit(...c),this.emit(I.ALL,...c),this._pendingUnlinks.delete(h)})},typeof s.atomic=="number"?s.atomic:100),this;t===I.ADD&&this._pendingUnlinks.has(e)&&(t=I.CHANGE,this._pendingUnlinks.delete(e))}if(i&&(t===I.ADD||t===I.CHANGE)&&this._readyEmitted){let c=(h,l)=>{h?(t=I.ERROR,o[0]=h,this.emitWithAll(t,o)):l&&(o.length>1?o[1]=l:o.push(l),this.emitWithAll(t,o))};return this._awaitWriteFinish(e,i.stabilityThreshold,t,c),this}if(t===I.CHANGE&&!this._throttle(I.CHANGE,e,50))return this;if(s.alwaysStat&&r===void 0&&(t===I.ADD||t===I.ADD_DIR||t===I.CHANGE)){let c=s.cwd?x.join(s.cwd,e):e,h;try{h=await Bs(c)}catch{}if(!h||this.closed)return;o.push(h)}return this.emitWithAll(t,o),this}_handleError(t){let e=t&&t.code;return t&&e!=="ENOENT"&&e!=="ENOTDIR"&&(!this.options.ignorePermissionErrors||e!=="EPERM"&&e!=="EACCES")&&this.emit(I.ERROR,t),t||this.closed}_throttle(t,e,r){this._throttled.has(t)||this._throttled.set(t,new Map);let s=this._throttled.get(t);if(!s)throw new Error("invalid throttle");let o=s.get(e);if(o)return o.count++,!1;let i,a=()=>{let h=s.get(e),l=h?h.count:0;return s.delete(e),clearTimeout(i),h&&clearTimeout(h.timeoutObject),l};i=setTimeout(a,r);let c={timeoutObject:i,clear:a,count:0};return s.set(e,c),c}_incrReadyCount(){return this._readyCount++}_awaitWriteFinish(t,e,r,s){let o=this.options.awaitWriteFinish;if(typeof o!="object")return;let i=o.pollInterval,a,c=t;this.options.cwd&&!x.isAbsolute(t)&&(c=x.join(this.options.cwd,t));let h=new Date,l=this._pendingWrites;function p(d){js(c,(m,g)=>{if(m||!l.has(t)){m&&m.code!=="ENOENT"&&s(m);return}let w=Number(new Date);d&&g.size!==d.size&&(l.get(t).lastChange=w);let _=l.get(t);w-_.lastChange>=e?(l.delete(t),s(void 0,g)):a=setTimeout(p,i,g)})}l.has(t)||(l.set(t,{lastChange:h,cancelWait:()=>(l.delete(t),clearTimeout(a),r)}),a=setTimeout(p,i))}_isIgnored(t,e){if(this.options.atomic&&Ys.test(t))return!0;if(!this._userIgnored){let{cwd:r}=this.options,o=(this.options.ignored||[]).map(ve(r)),a=[...[...this._ignoredPaths].map(ve(r)),...o];this._userIgnored=qs(a,void 0)}return this._userIgnored(t,e)}_isntIgnored(t,e){return!this._isIgnored(t,e)}_getWatchHelpers(t){return new qt(t,this.options.followSymlinks,this)}_getWatchedDir(t){let e=x.resolve(t);return this._watched.has(e)||this._watched.set(e,new Vt(e,this._boundRemove)),this._watched.get(e)}_hasReadPermissions(t){return this.options.ignorePermissionErrors?!0:!!(Number(t.mode)&256)}_remove(t,e,r){let s=x.join(t,e),o=x.resolve(s);if(r=r??(this._watched.has(s)||this._watched.has(o)),!this._throttle("remove",s,100))return;!r&&this._watched.size===1&&this.add(t,e,!0),this._getWatchedDir(s).getChildren().forEach(d=>this._remove(s,d));let c=this._getWatchedDir(t),h=c.has(e);c.remove(e),this._symlinkPaths.has(o)&&this._symlinkPaths.delete(o);let l=s;if(this.options.cwd&&(l=x.relative(this.options.cwd,s)),this.options.awaitWriteFinish&&this._pendingWrites.has(l)&&this._pendingWrites.get(l).cancelWait()===I.ADD)return;this._watched.delete(s),this._watched.delete(o);let p=r?I.UNLINK_DIR:I.UNLINK;h&&!this._isIgnored(s)&&this._emit(p,s),this._closePath(s)}_closePath(t){this._closeFile(t);let e=x.dirname(t);this._getWatchedDir(e).remove(x.basename(t))}_closeFile(t){let e=this._closers.get(t);e&&(e.forEach(r=>r()),this._closers.delete(t))}_addPathCloser(t,e){if(!e)return;let r=this._closers.get(t);r||(r=[],this._closers.set(t,r)),r.push(e)}_readdirp(t,e){if(this.closed)return;let r={type:I.ALL,alwaysStat:!0,lstat:!0,...e,depth:0},s=fe(t,r);return this._streams.add(s),s.once(xe,()=>{s=void 0}),s.once(Ut,()=>{s&&(this._streams.delete(s),s=void 0)}),s}};function tn(n,t={}){let e=new wt(t);return e.add(n),e}var Te={watch:tn,FSWatcher:wt};import{readFileSync as Le}from"node:fs";var bt=class{parsersByExtension=new Map;parsersByLanguage=new Map;register(t){this.parsersByLanguage.set(t.language,t);for(let e of t.extensions)this.parsersByExtension.set(e.toLowerCase(),t)}getByExtension(t){return this.parsersByExtension.get(t.toLowerCase())??null}getByLanguage(t){return this.parsersByLanguage.get(t)??null}getByFilePath(t){let e=t.lastIndexOf(".");if(e===-1)return null;let r=t.slice(e).toLowerCase();return this.getByExtension(r)}getSupportedExtensions(){return[...this.parsersByExtension.keys()]}isSupported(t){return this.getByFilePath(t)!==null}};import{createHash as en}from"node:crypto";var xt=class{logger;constructor(t){this.logger=t}parse(t,e){let r=(s,o)=>({path:e,language:this.language,hash:en("md5").update(s).digest("hex"),sizeBytes:Buffer.byteLength(s,"utf-8"),lineCount:s.split(`
`).length,symbolCount:o.length,lastModified:Date.now(),isIndexed:!1});try{let s=this.extractSymbols(t,e);return{metadata:r(t,s),symbols:s,imports:this.extractImports(t),exports:s.filter(o=>o.isExported).map(o=>o.name),errors:[]}}catch(s){return this.logger.warn(`Parse error in ${e}: ${s}`),{metadata:r(t,[]),symbols:[],imports:[],exports:[],errors:[{message:String(s)}]}}}extractImports(t){let e=[],r=/^[ \t]*import\s+(?:type\s+)?(?:\{[^}]*\}|[\w*]+(?:\s*,\s*\{[^}]*\})?)\s+from\s+['"]([^'"]+)['"]/gm,s;for(;(s=r.exec(t))!==null;)e.push(s[1]);return e}extractDocComments(t){let e=new Map,r=/\/\*\*\s*([\s\S]*?)\s*\*\//g,s;for(;(s=r.exec(t))!==null;){let o=t.substring(0,s.index).split(`
`).length;e.set(o,s[1].replace(/^\s*\*\s?/gm,"").trim())}return e}};var B={FUNCTION:/^[ \t]*(export\s+)?(default\s+)?(async\s+)?function\s+(\w+)\s*(?:<[^>]*>)?\s*\(([^)]*)\)(?:\s*:\s*([^\s{]+(?:\s*\|\s*[^\s{]+)*))?\s*\{/gm,ARROW_FUNCTION:/^[ \t]*(export\s+)?(const|let)\s+(\w+)\s*(?::\s*[^=]+)?\s*=\s*(async\s+)?(?:\(([^)]*)\)|(\w+))(?:\s*:\s*([^\s=]+(?:\s*\|\s*[^\s=]+)*))?\s*=>/gm,CLASS:/^[ \t]*(export\s+)?(default\s+)?(abstract\s+)?class\s+(\w+)(?:\s+extends\s+(\w+))?(?:\s+implements\s+([\w\s,]+))?\s*\{/gm,INTERFACE:/^[ \t]*(export\s+)?interface\s+(\w+)(?:\s+extends\s+([\w\s,]+))?\s*\{/gm,TYPE_ALIAS:/^[ \t]*(export\s+)?type\s+(\w+)(?:<[^>]*>)?\s*=\s*(.+)/gm,VARIABLE:/^[ \t]*(export\s+)?(const|let|var)\s+(\w+)(?:\s*:\s*([^=]+))?\s*=/gm,METHOD:/^[ \t]*(public|private|protected|static|abstract|async|readonly|\s)*(\w+)\s*(?:<[^>]*>)?\s*\(([^)]*)\)(?:\s*:\s*([^\s{]+(?:\s*\|\s*[^\s{]+)*))?\s*\{/gm,IMPORT:/^[ \t]*import\s+(?:type\s+)?(?:\{[^}]*\}|[\w*]+(?:\s*,\s*\{[^}]*\})?)\s+from\s+['"]([^'"]+)['"]/gm,JSDOC:/\/\*\*\s*([\s\S]*?)\s*\*\//g},_t=class extends xt{language="typescript";extensions=[".ts",".tsx",".js",".jsx"];constructor(t){super(t)}extractSymbols(t,e){let r=[],s=t.split(`
`),o=this.extractDocComments(t);return r.push(...this.extractFunctions(t,e,s,o)),r.push(...this.extractArrowFunctions(t,e,s,o)),r.push(...this.extractClasses(t,e,s)),r.push(...this.extractInterfaces(t,e,s)),r.push(...this.extractTypeAliases(t,e,s)),r.push(...this.extractVariables(t,e,s)),r}extractImports(t){let e=[],r=new RegExp(B.IMPORT.source,"gm"),s;for(;(s=r.exec(t))!==null;)s[1]&&e.push(s[1]);return e}extractExports(t,e){return e.filter(r=>r.isExported).map(r=>r.name)}extractFunctions(t,e,r,s){let o=[],i=new RegExp(B.FUNCTION.source,"gm"),a;for(;(a=i.exec(t))!==null;){let c=this.getLineNumber(t,a.index),h=a[4]??"anonymous",l=!!a[1],p=!!a[3],d=a[5]??"",m=a[6]??null,g=this.parseParameters(d),w=this.findDocComment(s,c),_=this.findClosingBrace(r,c),v=this.buildFunctionSignature(l,p,h,g,m);o.push({id:`${e}:${h}:${c}`,name:h,type:"function",filePath:e,range:this.buildRange(c,_),signature:v,isExported:l,parameters:g,returnType:m,isAsync:p,isStatic:!1,docComment:w})}return o}extractArrowFunctions(t,e,r,s){let o=[],i=new RegExp(B.ARROW_FUNCTION.source,"gm"),a;for(;(a=i.exec(t))!==null;){let c=this.getLineNumber(t,a.index),h=a[3]??"anonymous",l=!!a[1],p=!!a[4],d=a[5]??a[6]??"",m=a[7]??null,g=this.parseParameters(d),w=this.findDocComment(s,c),_=this.buildFunctionSignature(l,p,h,g,m);o.push({id:`${e}:${h}:${c}`,name:h,type:"function",filePath:e,range:this.buildRange(c,c),signature:_,isExported:l,parameters:g,returnType:m,isAsync:p,isStatic:!1,docComment:w})}return o}extractClasses(t,e,r){let s=[],o=new RegExp(B.CLASS.source,"gm"),i;for(;(i=o.exec(t))!==null;){let a=this.getLineNumber(t,i.index),c=i[4]??"AnonymousClass",h=!!i[1],l=!!i[3],p=i[5]??null,d=i[6]?i[6].split(",").map(v=>v.trim()).filter(Boolean):[],m=this.findClosingBrace(r,a),g=r.slice(a,m+1).join(`
`),w=this.extractClassMethods(g,e,a),_=this.buildClassSignature(h,l,c,p,d);s.push({id:`${e}:${c}:${a}`,name:c,type:"class",filePath:e,range:this.buildRange(a,m),signature:_,isExported:h,extends:p,implements:d,members:w,isAbstract:l})}return s}extractInterfaces(t,e,r){let s=[],o=new RegExp(B.INTERFACE.source,"gm"),i;for(;(i=o.exec(t))!==null;){let a=this.getLineNumber(t,i.index),c=i[2]??"AnonymousInterface",h=!!i[1],l=i[3]??"",p=this.findClosingBrace(r,a),d=h?`export interface ${c}${l?` extends ${l.trim()}`:""}`:`interface ${c}${l?` extends ${l.trim()}`:""}`;s.push({id:`${e}:${c}:${a}`,name:c,type:"interface",filePath:e,range:this.buildRange(a,p),signature:d,isExported:h})}return s}extractTypeAliases(t,e,r){let s=[],o=new RegExp(B.TYPE_ALIAS.source,"gm"),i;for(;(i=o.exec(t))!==null;){let a=this.getLineNumber(t,i.index),c=i[2]??"AnonymousType",h=!!i[1],l=(i[3]??"").trim().slice(0,100),p=h?`export type ${c} = ${l}`:`type ${c} = ${l}`;s.push({id:`${e}:${c}:${a}`,name:c,type:"type",filePath:e,range:this.buildRange(a,a),signature:p,isExported:h})}return s}extractVariables(t,e,r){let s=[],o=new RegExp(B.VARIABLE.source,"gm"),i,a=new Set,c=new RegExp(B.ARROW_FUNCTION.source,"gm"),h;for(;(h=c.exec(t))!==null;)h[3]&&a.add(h[3]);for(;(i=o.exec(t))!==null;){let l=i[3]??"anonymous";if(a.has(l))continue;let p=this.getLineNumber(t,i.index),d=!!i[1],m=i[2]??"const",g=i[4]?.trim()??null,w=m==="const",_=`${d?"export ":""}${m} ${l}${g?`: ${g}`:""}`;s.push({id:`${e}:${l}:${p}`,name:l,type:w?"constant":"variable",filePath:e,range:this.buildRange(p,p),signature:_,isExported:d,dataType:g,isConst:w})}return s}extractClassMethods(t,e,r){let s=[],o=new RegExp(B.METHOD.source,"gm"),i;for(;(i=o.exec(t))!==null;){let a=(i[1]??"").trim(),c=i[2];if(!c||c==="constructor"||c==="class"||c==="if"||c==="for"||c==="while")continue;let h=r+this.getLineNumber(t,i.index),l=i[3]??"",p=i[4]??null,d=`${a?a+" ":""}${c}(${l})${p?`: ${p}`:""}`;s.push({id:`${e}:${c}:${h}`,name:c,type:"method",filePath:e,range:this.buildRange(h,h),signature:d,isExported:!1})}return s}parseParameters(t){return t.trim()?t.split(",").map(e=>{let r=e.trim(),s=r.includes("?"),o=r.includes("="),i=r.split(/[?:=]/).map(l=>l.trim()).filter(Boolean),a=i[0]??"param",c=i[1]??null,h=o?i[2]??null:null;return{name:a,type:c,isOptional:s||o,defaultValue:h}}):[]}extractDocComments(t){let e=new Map,r=new RegExp(B.JSDOC.source,"g"),s;for(;(s=r.exec(t))!==null;){let o=this.getLineNumber(t,s.index+s[0].length),i=(s[1]??"").split(`
`).map(a=>a.replace(/^\s*\*\s?/,"").trim()).filter(Boolean).join(" ");e.set(o+1,i)}return e}findDocComment(t,e){return t.get(e)??t.get(e-1)??null}getLineNumber(t,e){let r=0;for(let s=0;s<e&&s<t.length;s++)t[s]===`
`&&r++;return r}findClosingBrace(t,e){let r=0,s=!1,o=!1,i=null;for(let a=e;a<t.length;a++){let c=t[a]??"";for(let h=0;h<c.length;h++){let l=c[h],p=c[h+1]??"";if(o){l==="*"&&p==="/"&&(o=!1,h++);continue}if(i!==null){if(l==="\\"){h++;continue}l===i&&(i=null);continue}if(l==="/"&&p==="/")break;if(l==="/"&&p==="*"){o=!0,h++;continue}if(l==="'"||l==='"'||l==="`"){i=l;continue}if(l==="{"?(r++,s=!0):l==="}"&&r--,s&&r===0)return a}}return Math.min(e+50,t.length-1)}buildRange(t,e){return{start:{line:t,column:0},end:{line:e,column:0}}}buildFunctionSignature(t,e,r,s,o){let i=[];t&&i.push("export"),e&&i.push("async"),i.push("function"),i.push(r);let a=s.map(c=>`${c.name}${c.isOptional?"?":""}${c.type?`: ${c.type}`:""}`).join(", ");return`${i.join(" ")}(${a})${o?`: ${o}`:""}`}buildClassSignature(t,e,r,s,o){let i=[];return t&&i.push("export"),e&&i.push("abstract"),i.push("class"),i.push(r),s&&i.push(`extends ${s}`),o.length>0&&i.push(`implements ${o.join(", ")}`),i.join(" ")}};var Et=class{level="L1";compactMode=!1;setCompactMode(t){this.compactMode=t}compress(t,e){let r=[];for(let a of t){let c=this.formatSymbol(a);c&&r.push(c)}let s=r.join(`

`),o=this.estimateTokens(e),i=this.estimateTokens(s);return{level:"L1",content:s,originalTokens:o,compressedTokens:i,compressionRatio:o>0?1-i/o:0,symbols:t}}formatSymbol(t){switch(t.type){case"function":case"method":return this.formatFunction(t);case"class":return this.formatClass(t);case"interface":case"type":case"variable":case"constant":case"property":return t.signature;default:return t.signature}}formatFunction(t){let e=[];if(t.docComment){let r=this.compactMode?this.compactJSDoc(t.docComment):t.docComment;r&&e.push(`/** ${r} */`)}return e.push(`${t.signature};`),e.join(`
`)}formatClass(t){let e=[];e.push(`${t.signature} {`);for(let r of t.members)e.push(`  ${r.signature};`);return e.push("}"),e.join(`
`)}compactJSDoc(t){let e=t.split(`
`),r=[];for(let o of e){let i=o.trim().replace(/^\*\s?/,"");if(i.startsWith("@"))break;i.length>0&&r.push(i)}return(r[0]??"").slice(0,120)}estimateTokens(t){return Math.ceil(t.length/3.3)}};var $t=class{level="L2";compress(t,e){let r=[];for(let a of t){let c=this.formatSymbol(a);c&&r.push(c)}let s=r.join(`
`),o=this.estimateTokens(e),i=this.estimateTokens(s);return{level:"L2",content:s,originalTokens:o,compressedTokens:i,compressionRatio:o>0?1-i/o:0,symbols:t}}formatSymbol(t){switch(t.type){case"function":case"method":return this.formatFunction(t);case"class":return this.formatClass(t);case"interface":return`interface ${t.name}`;case"type":return`type ${t.name}`;case"variable":case"constant":return`${t.type} ${t.name}`;case"property":return`  ${t.name}`;default:return null}}formatFunction(t){let e=t.parameters.map(s=>`${s.name}${s.type?`: ${s.type}`:""}`).join(", "),r=t.returnType?` \u2192 ${t.returnType}`:"";return`${t.name}(${e})${r}`}formatClass(t){let e=[],r=`class ${t.name}`;t.extends&&(r+=` extends ${t.extends}`),e.push(r);for(let s of t.members)e.push(`  ${s.name}`);return e.join(`
`)}estimateTokens(t){return Math.ceil(t.length/3.3)}};var St=class{level="L3";compress(t,e){let r=this.groupByType(t),s=[];for(let[c,h]of r)s.push(`${c}: ${h.join(", ")}`);let o=s.join(`
`),i=this.estimateTokens(e),a=this.estimateTokens(o);return{level:"L3",content:o,originalTokens:i,compressedTokens:a,compressionRatio:i>0?1-a/i:0,symbols:t}}groupByType(t){let e=new Map;for(let r of t){if(r.type==="class"){let i=r,a=i.members.map(l=>l.name),c=a.length>0?`${i.name} { ${a.join(", ")} }`:i.name,h=e.get("class")??[];h.push(c),e.set("class",h);continue}let s=this.getGroupKey(r.type),o=e.get(s)??[];o.push(r.name),e.set(s,o)}return e}getGroupKey(t){switch(t){case"function":case"method":return"fn";case"class":return"class";case"interface":return"iface";case"type":return"type";case"variable":case"constant":return"const";case"property":return"prop";default:return"other"}}estimateTokens(t){return Math.ceil(t.length/3.3)}};var It=class{parserRegistry;strategies;logger;constructor(t){this.logger=t,this.parserRegistry=new bt,this.parserRegistry.register(new _t(t)),this.strategies=new Map([["L1",new Et],["L2",new $t],["L3",new St]])}compressFile(t,e="L1"){let r=Le(t,"utf-8");return this.compressCode(r,t,e)}compressCode(t,e,r="L1"){if(r==="L0")return this.buildL0Result(t);let s=this.parserRegistry.getByFilePath(e);if(!s)return this.logger.warn(`\u041F\u0430\u0440\u0441\u0435\u0440 \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D \u0434\u043B\u044F \u0444\u0430\u0439\u043B\u0430: ${e}. \u0412\u043E\u0437\u0432\u0440\u0430\u0449\u0430\u0435\u043C L0.`),this.buildL0Result(t);let o=s.parse(t,e);if(o.errors.length>0)return this.logger.warn(`\u041E\u0448\u0438\u0431\u043A\u0438 \u043F\u0430\u0440\u0441\u0438\u043D\u0433\u0430 ${e}: ${o.errors.length}. \u0412\u043E\u0437\u0432\u0440\u0430\u0449\u0430\u0435\u043C L0.`),this.buildL0Result(t);let i=this.strategies.get(r);if(!i){this.logger.warn(`\u0421\u0442\u0440\u0430\u0442\u0435\u0433\u0438\u044F \u0441\u0436\u0430\u0442\u0438\u044F ${r} \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430. \u0412\u043E\u0437\u0432\u0440\u0430\u0449\u0430\u0435\u043C L1.`);let c=this.strategies.get("L1");return c?c.compress(o.symbols,t):this.buildL0Result(t)}let a=i.compress(o.symbols,t);return this.logger.debug(`\u0421\u0436\u0430\u0442\u0438\u0435 ${e} [${r}]: ${a.originalTokens} \u2192 ${a.compressedTokens} (${(a.compressionRatio*100).toFixed(1)}% \u044D\u043A\u043E\u043D\u043E\u043C\u0438\u044F)`),a}extractSymbols(t){let e=Le(t,"utf-8");return this.extractSymbolsFromCode(e,t)}extractSymbolsFromCode(t,e){let r=this.parserRegistry.getByFilePath(e);return r?r.parse(t,e).symbols:[]}findSymbolInFile(t,e){return this.extractSymbols(t).find(s=>s.name===e)??null}isFileSupported(t){return this.parserRegistry.isSupported(t)}getSupportedExtensions(){return this.parserRegistry.getSupportedExtensions()}getParser(t){return this.parserRegistry.getByFilePath(t)}setCompactJSDoc(t){let e=this.strategies.get("L1");e&&"setCompactMode"in e&&e.setCompactMode(t)}setStripImports(t){}buildL0Result(t){let e=Math.ceil(t.length/3.3);return{level:"L0",content:t,originalTokens:e,compressedTokens:e,compressionRatio:0,symbols:[]}}};import{gzipSync as sn}from"node:zlib";var nn={maxRetries:3,baseDelayMs:500,maxDelayMs:5e3,timeoutMs:3e4},Rt=class{serverUrl;authToken;projectId;onRetry;onSplit;constructor(t){this.serverUrl=t.serverUrl.replace(/\/$/,""),this.authToken=t.authToken,this.projectId=t.projectId,this.onRetry=t.onRetry,this.onSplit=t.onSplit}async healthCheck(){try{return(await fetch(`${this.serverUrl}/health`,{signal:AbortSignal.timeout(5e3)})).ok}catch{return!1}}async sendHeartbeat(t){try{return(await fetch(`${this.serverUrl}/api/heartbeat`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.authToken}`,Connection:"close"},body:JSON.stringify({project_id:this.projectId,files_count:t,timestamp:Date.now()}),signal:AbortSignal.timeout(5e3)})).ok}catch{return!1}}async pushBatch(t){let e=JSON.stringify({project_id:this.projectId,files:t.map(s=>({path:s.path,hash:s.hash,sizeBytes:s.sizeBytes,language:s.language,lineCount:s.lineCount,l1Summary:s.l1Summary,l3Summary:s.l3Summary,imports:s.imports,symbols:s.symbols,rawSnippet:s.rawSnippet}))}),r=sn(Buffer.from(e,"utf-8"));await this.fetchWithRetry(`${this.serverUrl}/api/push_indexed`,{method:"POST",headers:{"Content-Type":"application/json","Content-Encoding":"gzip",Authorization:`Bearer ${this.authToken}`,Connection:"close"},body:r},nn)}async pushBatchAdaptive(t,e=0){if(t.length===0)return{uploaded:[],failed:[]};try{return await this.pushBatch(t),{uploaded:t,failed:[]}}catch{if(t.length===1)return{uploaded:[],failed:t};let r=Math.ceil(t.length/2),s=t.slice(0,r),o=t.slice(r);this.onSplit?.(t.length,r,e+1);let i=await this.pushBatchAdaptive(s,e+1);await new Promise(c=>setTimeout(c,200));let a=await this.pushBatchAdaptive(o,e+1);return{uploaded:[...i.uploaded,...a.uploaded],failed:[...i.failed,...a.failed]}}}async fetchWithRetry(t,e,r){let s=null;for(let o=0;o<=r.maxRetries;o++)try{let i=await fetch(t,{...e,signal:AbortSignal.timeout(r.timeoutMs)});if(i.status>=400&&i.status<500){let a=await i.text().catch(()=>"Unknown error");throw new Error(`HTTP ${i.status}: ${a}`)}if(i.status>=500){let a=await i.text().catch(()=>"Server error");if(s=new Error(`HTTP ${i.status}: ${a}`),o<r.maxRetries){await this.backoff(o,r);continue}throw s}return i}catch(i){let a=i instanceof Error?i:new Error(String(i));if(a.message.startsWith("HTTP 4")||(s=a,o>=r.maxRetries))throw a;this.onRetry?.(o+1,r.maxRetries,a.message),await this.backoff(o,r)}throw s??new Error("fetchWithRetry: unexpected end")}backoff(t,e){let r=e.baseDelayMs*Math.pow(2,t),s=Math.random()*500,o=Math.min(r+s,e.maxDelayMs);return new Promise(i=>setTimeout(i,o))}};var rn="\x1B[0m",F="\x1B[1m",on="\x1B[2m",vt="\x1B[33m",an="\x1B[34m",ot="\x1B[36m",cn="\x1B[37m",N="\x1B[31m",y="\x1B[90m",R="\x1B[92m",st="\x1B[93m",Me="\x1B[94m",D="\x1B[96m",O="\x1B[97m",Lt=process.stdout.isTTY!==!1;function u(n,t){return Lt?`${n}${t}${rn}`:t}function T(n){return n<1024?`${n} B`:n<1024*1024?`${(n/1024).toFixed(1)} KB`:`${(n/1024/1024).toFixed(2)} MB`}function Tt(n){return n<1e3?`${n}ms`:`${(n/1e3).toFixed(1)}s`}function z(){return u(y,new Date().toLocaleTimeString("ru-RU",{hour12:!1}))}function Ae(n,t,e=28){if(t===0)return u(y,"\u2591".repeat(e));let r=Math.min(n/t,1),s=Math.round(r*e),o=e-s,i=u(R,"\u2588".repeat(s))+u(y,"\u2591".repeat(o)),a=u(O,`${Math.round(r*100)}%`).padStart(4);return`${i} ${a}`}function De(n,t,e="0.7.0"){let s="\u2500".repeat(62);console.log(""),console.log(u(D,`  \u250C${s}\u2510`)),console.log(u(D,"  \u2502")+u(F+O,"  \u{1F9E0} Project Brain Smart Watcher")+u(y,`  v${e}`)+" ".repeat(26-e.length)+u(D,"\u2502")),console.log(u(D,"  \u2502")+u(ot,"  \u25CF ")+u(O,n.padEnd(24))+u(y,"\u2192  ")+u(an,t.slice(0,30).padEnd(30))+u(D,"\u2502")),console.log(u(D,`  \u2514${s}\u2518`)),console.log("")}function Ft(n,t,e){let r=u(Me+F,` ${n}/${t} `),s=u(F+O,` ${e} `),o=u(y,"\u2500".repeat(46));console.log(`
  ${r}${s}${o}`)}function G(n){console.log(`  ${z()}  ${u(ot,"\xB7")}  ${n}`)}function V(n){console.log(`  ${z()}  ${u(R,"\u2713")}  ${n}`)}function H(n){console.log(`  ${z()}  ${u(st,"\u26A0")}  ${u(vt,n)}`)}function k(n){console.log(`  ${z()}  ${u(N,"\u2717")}  ${u(N,n)}`)}function je(n){console.log(`  ${z()}  ${u(y,"\u25CB")}  ${u(on+y,n)}`)}var Fe=0;function Be(n,t,e){if(n===1&&(Fe=Date.now()),!Lt){(n%10===0||n===t)&&console.log(`  [${n}/${t}] ${e}`);return}let r=Ae(n,t),s=u(y,`${n}/${t}`),o=Date.now()-Fe,i=n>0?o/n:0,a=Math.round(i*(t-n)/1e3),c=a>0?u(y,`~${a}\u0441 \u043E\u0441\u0442\u0430\u043B\u043E\u0441\u044C`):u(R,"\u0433\u043E\u0442\u043E\u0432\u043E");process.stdout.write(`\r\x1B[2K  ${r}  ${s}  ${c}  ${u(y,e.slice(0,28))}  `),n===t&&process.stdout.write(`
`)}var Pt=0;function Ne(n,t,e,r,s){n===1&&Pt===0&&(Pt=Date.now());let o=s?u(R,"\u2713"):u(N,"\u2717"),i=Ae(n,t,20),a=u(O,`${e} files`),c=u(y,`~${r}`),h=Date.now()-Pt,l=n>0?h/n:0,p=Math.round(l*(t-n)/1e3),d=n<t?u(y,`~${p}\u0441`):u(R,"\u0433\u043E\u0442\u043E\u0432\u043E");Lt?(process.stdout.write(`\r\x1B[2K  ${i}  ${o} ${a} ${c}  ${d}`),n===t&&process.stdout.write(`
`)):console.log(`  Batch ${n}/${t}  ${s?"OK":"FAIL"}  ${e} files  ~${r}`)}function Oe(){Pt=0}var ke=["\u280B","\u2819","\u2839","\u2838","\u283C","\u2834","\u2826","\u2827","\u2807","\u280F"],Ct=null,Jt=0;function Xt(n){Lt&&(Jt=0,Ct=setInterval(()=>{let t=u(D,ke[Jt%ke.length]);process.stdout.write(`\r\x1B[2K  ${t}  ${u(y,n)}`),Jt++},80))}function Zt(){Ct&&(clearInterval(Ct),Ct=null,process.stdout.write("\r\x1B[2K"))}function We(n){let t=n.originalKb>0?(n.originalKb/Math.max(n.summaryKb,1)).toFixed(1):"\u2014",e=n.originalKb>0?Math.round((1-n.summaryKb/n.originalKb)*100):0,r=62,s="\u2500".repeat(r);console.log(""),console.log(u(R,`  \u250C${s}\u2510`));let o=n.errors===0?`  \u2705  \u041F\u0440\u043E\u0438\u043D\u0434\u0435\u043A\u0441\u0438\u0440\u043E\u0432\u0430\u043D\u043E ${n.files} \u0444\u0430\u0439\u043B\u043E\u0432 \u0437\u0430 ${Tt(n.elapsedMs)}`:`  \u26A0\uFE0F   \u041F\u0440\u043E\u0438\u043D\u0434\u0435\u043A\u0441\u0438\u0440\u043E\u0432\u0430\u043D\u043E ${n.files} \u0444\u0430\u0439\u043B\u043E\u0432 (${n.errors} \u043E\u0448\u0438\u0431\u043E\u043A) \u0437\u0430 ${Tt(n.elapsedMs)}`;console.log(u(R,"  \u2502")+u(F+O,o).padEnd(r+8)+u(R,"\u2502"));let i=`  \u{1F4BE}  \u041E\u0442\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u043E ${T(n.summaryKb*1024)}  (\u0438\u0437 ~${T(n.originalKb*1024)} \u0438\u0441\u0445\u043E\u0434\u043D\u044B\u0445)  \xD7${t} \u0441\u0436\u0430\u0442\u0438\u0435  (${e}%)`;console.log(u(R,"  \u2502")+u(ot,i).padEnd(r+9)+u(R,"\u2502")),console.log(u(R,`  \u2514${s}\u2518`)),console.log("")}function ze(n,t,e){if(e===0)return;let r=4,s=Math.round(n/r),o=Math.round(t/r),i=s-o,a=s>0?Math.round(i/s*100):0,c=s>0?(s/Math.max(o,1)).toFixed(0):"\u2014",h=Math.round(n/e),l=Math.round(t/e),p=v=>v>=1e6?`${(v/1e6).toFixed(2)}M`:v>=1e3?`${(v/1e3).toFixed(1)}K`:String(v),d=62,m="\u2500".repeat(d),g="\u2500".repeat(d-2),w=Me,_=(v,X)=>u(w,"  \u2502")+u(X,v).padEnd(d+9)+u(w,"\u2502");console.log(u(w,`  \u250C${m}\u2510`)),console.log(u(w,"  \u2502")+u(F+O,"  \u{1F9EE}  \u042D\u041A\u041E\u041D\u041E\u041C\u0418\u042F \u0422\u041E\u041A\u0415\u041D\u041E\u0412").padEnd(d+8)+u(w,"\u2502")),console.log(u(w,"  \u2502")+u(y,`  ${g}`).padEnd(d+8)+u(w,"\u2502")),console.log(_(`  \u{1F4C4}  \u0418\u0441\u0445\u043E\u0434\u043D\u044B\u0439 \u043A\u043E\u0434:   ~${p(s)} \u0442\u043E\u043A\u0435\u043D\u043E\u0432  (${T(n)})`,N)),console.log(_(`  \u{1F9E0}  L1+L3 \u0441\u0443\u043C\u043C\u0430\u0440\u0438:  ~${p(o)} \u0442\u043E\u043A\u0435\u043D\u043E\u0432  (${T(t)})`,R)),console.log(u(w,"  \u2502")+u(y,`  ${g}`).padEnd(d+8)+u(w,"\u2502")),console.log(_(`  \u{1F4B0}  \u042D\u043A\u043E\u043D\u043E\u043C\u0438\u044F:       ~${p(i)} \u0442\u043E\u043A\u0435\u043D\u043E\u0432  (${a}%)`,F+st)),console.log(_(`  \u{1F4CA}  \u0421\u0442\u0435\u043F\u0435\u043D\u044C \u0441\u0436\u0430\u0442\u0438\u044F: \xD7${c}  (${e} \u0444\u0430\u0439\u043B\u043E\u0432)`,D)),console.log(u(w,"  \u2502")+u(y,`  ${g}`).padEnd(d+8)+u(w,"\u2502")),console.log(_(`  \u{1F4D0}  \u0421\u0440\u0435\u0434\u043D\u0438\u0439 \u0444\u0430\u0439\u043B:   ${T(h)} \u2192 ${T(l)}`,y)),console.log(_("  \u26A1  \u041D\u0430 \u043F\u0440\u043E\u0432\u043E\u0434\u0435:     gzip \u0435\u0449\u0451 ~70% \u043C\u0435\u043D\u044C\u0448\u0435",y)),console.log(u(w,`  \u2514${m}\u2518`)),console.log("")}function He(n){let t=[];if(n.added>0&&t.push(u(R,`+${n.added} \u043D\u043E\u0432\u044B\u0445`)),n.changed>0&&t.push(u(st,`~${n.changed} \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u043E`)),n.removed>0&&t.push(u(N,`-${n.removed} \u0443\u0434\u0430\u043B\u0435\u043D\u043E`)),t.length===0){console.log(`  ${z()}  ${u(y,"\u25CB")}  ${u(y,`Rescan: \u0431\u0435\u0437 \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u0439 (${n.unchanged} \u0444\u0430\u0439\u043B\u043E\u0432)  \u0441\u043B\u0435\u0434\u0443\u044E\u0449\u0438\u0439 \u0447\u0435\u0440\u0435\u0437 ${n.nextInMin} \u043C\u0438\u043D`)}`);return}let e=t.join(u(y,", ")),r=u(y,Tt(n.elapsedMs)),s=u(y,`\u0441\u043B\u0435\u0434\u0443\u044E\u0449\u0438\u0439 \u0447\u0435\u0440\u0435\u0437 ${n.nextInMin} \u043C\u0438\u043D`);console.log(`  ${z()}  ${u(D,"\u21BB")}  Rescan: ${e}  ${u(y,"|")}  \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u043E ${n.uploaded}  ${r}  ${s}`)}function Ue(n){let e="\u2500".repeat(62),r="\u2500".repeat(60),s=D,o=(m,g)=>u(s,"  \u2502")+u(g,m).padEnd(71)+u(s,"\u2502");console.log(u(s,`  \u250C${e}\u2510`)),console.log(u(s,"  \u2502")+u(F+O,"  \u{1F4CB}  \u0412\u0415\u0420\u0418\u0424\u0418\u041A\u0410\u0426\u0418\u042F \u0421\u041A\u0410\u041D\u0418\u0420\u041E\u0412\u0410\u041D\u0418\u042F").padEnd(70)+u(s,"\u2502")),console.log(u(s,"  \u2502")+u(y,`  ${r}`).padEnd(70)+u(s,"\u2502"));let i=Object.entries(n.byExt).sort((m,g)=>g[1]-m[1]);console.log(o("  \u{1F4C2}  \u041E\u0431\u0440\u0430\u0431\u043E\u0442\u0430\u043D\u043E \u043F\u043E \u0442\u0438\u043F\u0430\u043C \u0444\u0430\u0439\u043B\u043E\u0432:",F+O));for(let[m,g]of i){let w=n.compressed>0?Math.round(g/n.compressed*100):0,_="\u2588".repeat(Math.max(1,Math.round(w/5)));console.log(o(`       ${m.padEnd(8)} ${String(g).padStart(4)} \u0444\u0430\u0439\u043B(\u043E\u0432)  ${w}%  ${_}`,ot))}console.log(u(s,"  \u2502")+u(y,`  ${r}`).padEnd(70)+u(s,"\u2502"));let a=Object.entries(n.skippedByExt).sort((m,g)=>g[1]-m[1]);if(a.length>0){console.log(o("  \u{1F6AB}  \u041F\u0440\u043E\u043F\u0443\u0449\u0435\u043D\u043D\u044B\u0435 \u0440\u0430\u0441\u0448\u0438\u0440\u0435\u043D\u0438\u044F (\u043D\u0435 \u0432 \u0441\u043F\u0438\u0441\u043A\u0435 --exts):",F+st));let m=a.slice(0,10);for(let[g,w]of m)console.log(o(`       ${g.padEnd(8)} ${String(w).padStart(4)} \u0444\u0430\u0439\u043B(\u043E\u0432)`,vt));if(a.length>10){let g=a.slice(10).reduce((w,[,_])=>w+_,0);console.log(o(`       ...\u0438 \u0435\u0449\u0451 ${a.length-10} \u0442\u0438\u043F\u043E\u0432 (${g} \u0444\u0430\u0439\u043B\u043E\u0432)`,y))}console.log(u(s,"  \u2502")+u(y,`  ${r}`).padEnd(70)+u(s,"\u2502"))}let{tooLarge:c,readError:h,compressError:l}=n.skipInfo,p=c.length+h.length+l.length;if(p>0){if(console.log(o(`  \u26A0\uFE0F   \u041F\u0440\u043E\u043F\u0443\u0449\u0435\u043D\u043D\u044B\u0435 \u0444\u0430\u0439\u043B\u044B: ${p}`,F+st)),c.length>0){console.log(o(`       \u{1F5C4}\uFE0F  \u0421\u043B\u0438\u0448\u043A\u043E\u043C \u0431\u043E\u043B\u044C\u0448\u0438\u0435 (>500KB): ${c.length}`,vt));for(let m of c.slice(0,5))console.log(o(`          ${m}`,y));c.length>5&&console.log(o(`          ...\u0438 \u0435\u0449\u0451 ${c.length-5}`,y))}if(h.length>0){console.log(o(`       \u{1F4DB}  \u041E\u0448\u0438\u0431\u043A\u0438 \u0447\u0442\u0435\u043D\u0438\u044F: ${h.length}`,N));for(let m of h.slice(0,5))console.log(o(`          ${m}`,y));h.length>5&&console.log(o(`          ...\u0438 \u0435\u0449\u0451 ${h.length-5}`,y))}if(l.length>0){console.log(o(`       \u{1F527}  AST \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D (raw fallback): ${l.length}`,vt));for(let m of l.slice(0,5))console.log(o(`          ${m}`,y));l.length>5&&console.log(o(`          ...\u0438 \u0435\u0449\u0451 ${l.length-5}`,y))}console.log(u(s,"  \u2502")+u(y,`  ${r}`).padEnd(70)+u(s,"\u2502"))}let d=n.total>0?Math.round(n.compressed/n.total*100):0;if(console.log(o(`  \u2705  \u041F\u043E\u043A\u0440\u044B\u0442\u0438\u0435: ${n.compressed}/${n.total} \u0444\u0430\u0439\u043B\u043E\u0432 (${d}%)`,F+R)),a.length>0){let m=a.reduce((g,[,w])=>g+w,0);console.log(o(`  \u{1F4A1}  +${m} \u0444\u0430\u0439\u043B\u043E\u0432 \u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E \u0441 \u0440\u0430\u0441\u0448\u0438\u0440\u0435\u043D\u043D\u044B\u043C --exts`,y))}console.log(u(s,`  \u2514${e}\u2518`)),console.log("")}function Ye(n){console.log(""),console.log(`  ${u(D+F,"  \u{1F441}  WATCH MODE  ")}  ${u(y,n)}`),console.log(u(y,`  ${"\u2500".repeat(60)}`)),console.log(u(y,`  Ctrl+C \u0434\u043B\u044F \u043E\u0441\u0442\u0430\u043D\u043E\u0432\u043A\u0438
`))}function kt(n,t,e=void 0){let r={modified:u(st,"\u270E"),added:u(R,"+"),deleted:u(N,"\u2212"),error:u(N,"\u2717")},s={modified:O,added:R,deleted:y,error:N},o=r[n]??"\xB7",i=u(s[n]??cn,t.padEnd(40)),a=e?u(y,e):"";console.log(`  ${z()}  ${o}  ${i}  ${a}`)}function Ke(n,t,e){let r=t?u(R,"\u2713 \u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D"):u(N,"\u2717 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D");console.log(`  ${z()}  ${u(ot,"\u21D7")}  ${u(y,n)}  ${r}  ${u(y,Tt(e))}`)}var es=".brain",ss="config.json";function un(n){let t=it(n,es,ss);if(!Dt(t))return null;try{let e=se(t,"utf-8");return JSON.parse(e)}catch{return null}}function pn(n,t){let e=it(n,es);try{Dt(e)||ln(e,{recursive:!0});let r=it(e,ss);Ge(r,JSON.stringify(t,null,2),"utf-8");let s=it(e,".gitignore");Dt(s)||Ge(s,`*
`,"utf-8")}catch{}}function Ve(n){return new Promise(t=>setTimeout(t,n))}function dn(n,t,e){let r=`  \u21BB \u043F\u043E\u043F\u044B\u0442\u043A\u0430 ${n}/${t}: ${e}`;process.stdout.write(`\x1B[33m${r}\x1B[0m
`)}var mn=".ts,.tsx,.js,.jsx,.mjs,.cjs,.py,.cs,.go,.rs,.java,.kt,.swift,.rb,.php,.c,.cpp,.h,.hpp,.cc,.vue,.svelte,.html,.htm,.css,.scss,.sass,.less,.json,.yaml,.yml,.xml,.sql,.sh,.md,.graphql,.gql,.dart,.scala,.lua,.r,.ex,.exs,.proto",gn="node_modules,dist,.git,build,out,coverage,__pycache__,.venv,venv,env,.next,.nuxt,vendor,target,.cache,bin,obj,.idea,.vscode,.DS_Store,package-lock.json,yarn.lock,pnpm-lock.yaml";function fn(n){let t=d=>{let m=n.indexOf(d);return m!==-1?n[m+1]:void 0},e=t("--path")??process.cwd(),r=un(e),s=t("--server")??r?.server??"",o=t("--token")??r?.token??"",i=t("--project")??r?.project_id??e.split(/[/\\]/).pop()??"default",a=n.includes("--watch"),c=t("--exts")??r?.extensions??mn,h=t("--ignore")??r?.ignore??gn,l=parseInt(t("--batch")??String(r?.batch_size??10),10),p=parseInt(t("--interval")??String(r?.interval_min??3),10);return{path:e,server:s.replace(/\/$/,""),token:o,project:i,watch:a,exts:c.split(",").map(d=>d.trim()),ignore:h.split(",").map(d=>d.trim()),batchSize:l,intervalMin:p,brainConfigLoaded:r!==null}}function qe(n,t,e){let r=[],s={},o=e.map(h=>h.toLowerCase()),i=new Set(t.filter(h=>h.includes("."))),a=new Set(t.filter(h=>!h.includes(".")));function c(h){let l;try{l=hn(h,{withFileTypes:!0})}catch{return}for(let p of l){let d=String(p.name);if(d.startsWith("."))continue;let m=it(h,d);if(p.isDirectory()){if(a.has(d))continue;c(m)}else if(p.isFile()){if(i.has(d))continue;let g=jt(d).toLowerCase();o.includes(g)?r.push(m):g&&(s[g]=(s[g]||0)+1)}}}return c(n),{files:r,skippedByExt:s}}var yn=/import\s+(?:type\s+)?(?:\{[^}]*\}|[^;{]*)\s+from\s+['"]([^'"]+)['"]/g,wn=/require\s*\(\s*['"]([^'"]+)['"]\s*\)/g,bn=/import\s*\(\s*['"]([^'"]+)['"]\s*\)/g;function xn(n){let t=new Set;for(let e of[yn,wn,bn]){e.lastIndex=0;let r;for(;(r=e.exec(n))!==null;)t.add(r[1])}return[...t]}var _n=[{regex:/export\s+(?:default\s+)?(?:async\s+)?function\s+(\w+)/g,type:"function",exported:!0},{regex:/export\s+(?:default\s+)?class\s+(\w+)/g,type:"class",exported:!0},{regex:/export\s+(?:default\s+)?(?:const|let|var)\s+(\w+)/g,type:"variable",exported:!0},{regex:/export\s+(?:default\s+)?(?:type|interface)\s+(\w+)/g,type:"type",exported:!0},{regex:/(?:^|\n)\s*(?:async\s+)?function\s+(\w+)/g,type:"function",exported:!1},{regex:/(?:^|\n)\s*class\s+(\w+)/g,type:"class",exported:!1}];function En(n){let t=new Set,e=[];for(let{regex:r,type:s,exported:o}of _n){r.lastIndex=0;let i;for(;(i=r.exec(n))!==null;){let a=i[1];t.has(a)||(t.add(a),e.push({name:a,type:s,isExported:o}))}}return e}var Qt=3e3,$n=15e3,Sn=2e3;function Je(n){if(n.length<=Qt)return n;let t=n.lastIndexOf(`
`,Qt);return n.slice(0,t>0?t:Qt)}function Xe(n,t,e){if(n.length<=t)return n;let r=n.lastIndexOf(`
`,t),s=n.slice(0,r>0?r:t);return`${s}
// ... ${e}: \u043E\u0431\u0440\u0435\u0437\u0430\u043D\u043E (${n.length} \u2192 ${s.length} \u0441\u0438\u043C\u0432\u043E\u043B\u043E\u0432)`}var Ze={".ts":"typescript",".tsx":"typescript",".js":"javascript",".jsx":"javascript",".mjs":"javascript",".cjs":"javascript",".py":"python",".cs":"csharp",".go":"go",".rs":"rust",".java":"java",".kt":"kotlin",".kts":"kotlin",".swift":"swift",".rb":"ruby",".php":"php",".c":"c",".cpp":"cpp",".cc":"cpp",".h":"c-header",".hpp":"cpp-header",".vue":"vue",".svelte":"svelte",".html":"html",".htm":"html",".css":"css",".scss":"scss",".sass":"sass",".less":"less",".json":"json",".yaml":"yaml",".yml":"yaml",".xml":"xml",".svg":"xml",".sql":"sql",".sh":"shell",".bash":"shell",".md":"markdown",".graphql":"graphql",".gql":"graphql",".proto":"protobuf",".dart":"dart",".scala":"scala",".lua":"lua",".r":"r",".ex":"elixir",".exs":"elixir"};function te(n,t,e,r){let s=At(t,n).replace(/\\/g,"/"),o;try{o=Mt(n)}catch{return r?.readError.push(s),null}if(o.size>500*1024)return r?.tooLarge.push(`${s} (${T(o.size)})`),null;let i;try{i=se(n,"utf-8")}catch{return r?.readError.push(s),null}let a=ts("md5").update(i).digest("hex"),c=i.split(`
`).length,h=jt(n).toLowerCase(),l,p;try{let w=e.compressCode(i,s,"L1"),_=e.compressCode(i,s,"L3");l=w.content,p=_.content}catch{l=Je(i),p=`// ${s} (${c} lines, ${Ze[h]??h})`,r?.compressError.push(s)}l=Xe(l,$n,"L1"),p=Xe(p,Sn,"L3");let d=xn(i),m=En(i),g=Je(i);return{path:s,hash:a,sizeBytes:o.size,language:Ze[h]??null,lineCount:c,l1Summary:l,l3Summary:p,imports:d,symbols:m,rawSnippet:g}}var ee=30*1024;function at(n){let t=n.l1Summary?.length??0,e=n.l3Summary?.length??0,r=n.rawSnippet?.length??0,s=n.path?.length??0,o=n.imports?n.imports.reduce((a,c)=>a+c.length+4,20):0,i=n.symbols?n.symbols.reduce((a,c)=>a+c.name.length+c.type.length+30,20):0;return t+e+r+s+o+i+200}function Qe(n,t=ee){if(n.length===0)return[];let e=[...n].sort((i,a)=>at(i)-at(a)),r=[],s=[],o=0;for(let i of e){let a=at(i);if(a>t){s.length>0&&(r.push({batchIndex:r.length+1,files:s}),s=[],o=0),r.push({batchIndex:r.length+1,files:[i]});continue}o+a>t&&s.length>0&&(r.push({batchIndex:r.length+1,files:s}),s=[],o=0),s.push(i),o+=a}return s.length>0&&r.push({batchIndex:r.length+1,files:s}),r}async function In(){let n=fn(process.argv.slice(2));n.server||(k("--server \u043E\u0431\u044F\u0437\u0430\u0442\u0435\u043B\u0435\u043D  (\u043D\u0430\u043F\u0440\u0438\u043C\u0435\u0440: https://your-mcp.com)"),process.exit(1)),n.token||(k("--token \u043E\u0431\u044F\u0437\u0430\u0442\u0435\u043B\u0435\u043D"),process.exit(1)),Dt(n.path)||(k(`\u041F\u0443\u0442\u044C \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D: ${n.path}`),process.exit(1)),De(n.project,n.server,"0.11.0"),n.brainConfigLoaded&&G("\u{1F4C2} .brain/config.json \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D (CLI-\u0444\u043B\u0430\u0433\u0438 \u0438\u043C\u0435\u044E\u0442 \u043F\u0440\u0438\u043E\u0440\u0438\u0442\u0435\u0442)"),Ft(1,3,"\u041F\u041E\u0414\u041A\u041B\u042E\u0427\u0415\u041D\u0418\u0415");let t=Date.now(),e=new Rt({serverUrl:n.server,authToken:n.token,projectId:n.project,batchSize:n.batchSize,onRetry:dn,onSplit:(f,b,S)=>{let P="  ".repeat(S);H(`${P}\u26A1 \u0414\u0440\u043E\u0431\u043B\u0435\u043D\u0438\u0435 \u0431\u0430\u0442\u0447\u0430: ${f} \u2192 ${b} + ${f-b} \u0444\u0430\u0439\u043B\u043E\u0432 (\u0433\u043B\u0443\u0431\u0438\u043D\u0430 ${S})`)}});Xt(`\u041F\u043E\u0434\u043A\u043B\u044E\u0447\u0435\u043D\u0438\u0435 \u043A ${n.server}...`);let r=await e.healthCheck();Zt(),Ke(n.server,r,Date.now()-t),r||(k(`\u0421\u0435\u0440\u0432\u0435\u0440 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D: ${n.server}`),process.exit(1)),Ft(2,3,"\u0421\u041A\u0410\u041D\u0418\u0420\u041E\u0412\u0410\u041D\u0418\u0415 \u0418 \u0421\u0416\u0410\u0422\u0418\u0415"),G(`\u041F\u0443\u0442\u044C:  ${n.path}`),G(`\u0420\u0430\u0441\u0448:  ${n.exts.join(", ")}   Smart Batch: \u2264${Math.round(ee/1024)} \u041A\u0411`);let s=n.ignore.length>6?n.ignore.slice(0,6).join(", ")+`, +${n.ignore.length-6} \u0435\u0449\u0451`:n.ignore.join(", ");G(`\u0418\u0433\u043D\u043E\u0440: ${s}  (--ignore \u0434\u043B\u044F \u043D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0438)`);let o=Date.now(),i=qe(n.path,n.ignore,n.exts),a=i.files;V(`\u041D\u0430\u0439\u0434\u0435\u043D\u043E ${a.length} \u0444\u0430\u0439\u043B\u043E\u0432  (${T(a.reduce((f,b)=>{try{return f+Mt(b).size}catch{return f}},0))} \u0438\u0441\u0445\u043E\u0434\u043D\u044B\u0445)`);let c=Object.values(i.skippedByExt).reduce((f,b)=>f+b,0);if(c>0){let f=Object.entries(i.skippedByExt).sort((b,S)=>S[1]-b[1]).slice(0,5).map(([b,S])=>`${b}(${S})`).join(", ");H(`${c} \u0444\u0430\u0439\u043B\u043E\u0432 \u043F\u0440\u043E\u043F\u0443\u0449\u0435\u043D\u043E (\u0440\u0430\u0441\u0448\u0438\u0440\u0435\u043D\u0438\u0435 \u043D\u0435 \u0432 --exts): ${f}`)}let h={info:()=>{},warn:()=>{},error:()=>{},debug:()=>{},trace:()=>{},fatal:()=>{}},l=new It(h),p=[],d={tooLarge:[],readError:[],compressError:[]};for(let f=0;f<a.length;f++){let b=a[f];Be(f+1,a.length,At(n.path,b).replace(/\\/g,"/"));let S=te(b,n.path,l,d);S&&p.push(S)}let m=d.tooLarge.length+d.readError.length,g=Date.now()-o,w=Math.round(a.reduce((f,b)=>{try{return f+Mt(b).size}catch{return f}},0)/1024),_=Math.round(p.reduce((f,b)=>f+b.l1Summary.length,0)/1024),v=w>0?(w/Math.max(_,1)).toFixed(1):"\u2014";V(`\u0421\u0436\u0430\u0442\u043E ${p.length} \u0444\u0430\u0439\u043B\u043E\u0432 \u0437\u0430 ${(g/1e3).toFixed(1)}\u0441  \u2192  ${T(_*1024)}  (\xD7${v})`),m>0&&H(`${m} \u0444\u0430\u0439\u043B\u043E\u0432 \u043F\u0440\u043E\u043F\u0443\u0449\u0435\u043D\u043E (\u0441\u043B\u0438\u0448\u043A\u043E\u043C \u0431\u043E\u043B\u044C\u0448\u0438\u0435 \u0438\u043B\u0438 \u043D\u0435\u0447\u0438\u0442\u0430\u0435\u043C\u044B\u0435)`),d.compressError.length>0&&G(`${d.compressError.length} \u0444\u0430\u0439\u043B\u043E\u0432 \u0431\u0435\u0437 AST (raw fallback)`),Ft(3,3,"\u0417\u0410\u0413\u0420\u0423\u0417\u041A\u0410");let X=Qe(p),M=X.length;G(`${M} \u0431\u0430\u0442\u0447\u0435\u0439 (smart: \u2264${Math.round(ee/1024)} \u041A\u0411/\u0431\u0430\u0442\u0447)`),Oe();let ne=Date.now(),Z=0,U=[],re=new Set;for(let f=0;f<X.length;f++){let b=X[f],P=(b.files.reduce((q,lt)=>q+at(lt),0)/1024).toFixed(1);Xt(`\u0411\u0430\u0442\u0447 ${b.batchIndex}/${M} (${b.files.length} \u0444\u0430\u0439\u043B\u043E\u0432, ~${P} \u041A\u0411)...`);let E=await e.pushBatchAdaptive(b.files);Zt(),Z+=E.uploaded.length;for(let q of E.uploaded)re.add(q.path);U.push(...E.failed);let Q=Date.now()-ne,Y=M>1?` ~${((M-f-1)*(Q/(f+1))/1e3).toFixed(0)}\u0441`:"";E.failed.length===0?V(`  \u0411\u0430\u0442\u0447 ${b.batchIndex}/${M}: ${b.files.length} \u0444\u0430\u0439\u043B\u043E\u0432 \u2713${Y}`):E.uploaded.length>0?H(`  \u0411\u0430\u0442\u0447 ${b.batchIndex}/${M}: ${E.uploaded.length} \u2713 / ${E.failed.length} \u2717${Y}`):k(`  \u0411\u0430\u0442\u0447 ${b.batchIndex}/${M}: \u0432\u0441\u0435 ${b.files.length} \u0444\u0430\u0439\u043B\u043E\u0432 \u2717${Y}`),f<X.length-1&&await Ve(150)}let ns=Date.now()-ne;if(Ne(M,M,Z,T(_*1024),U.length===0),V(`\u0417\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u043E: ${Z} \u0444\u0430\u0439\u043B\u043E\u0432 \u0437\u0430 ${(ns/1e3).toFixed(1)}\u0441 (${M} \u0431\u0430\u0442\u0447\u0435\u0439)`),U.length>0){H(`  ${U.length} \u0444\u0430\u0439\u043B\u043E\u0432 \u043D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C:`);for(let f of U.slice(0,10))k(`    \u2717 ${f.path} (~${(at(f)/1024).toFixed(1)} \u041A\u0411)`);U.length>10&&k(`    ... \u0438 \u0435\u0449\u0451 ${U.length-10}`)}!n.brainConfigLoaded&&Z>0&&(pn(n.path,{project_id:n.project,server:n.server,token:n.token,extensions:n.exts.join(","),ignore:n.ignore.join(","),batch_size:n.batchSize,interval_min:n.intervalMin}),V(".brain/config.json \u0441\u043E\u0445\u0440\u0430\u043D\u0451\u043D (\u0441\u043B\u0435\u0434\u0443\u044E\u0449\u0438\u0439 \u0437\u0430\u043F\u0443\u0441\u043A \u0431\u0435\u0437 --server --token --project)")),We({files:Z,batches:M,originalKb:w,summaryKb:_,elapsedMs:Date.now()-o,errors:U.length+m});let rs=a.reduce((f,b)=>{try{return f+Mt(b).size}catch{return f}},0),os=p.reduce((f,b)=>f+b.l1Summary.length+b.l3Summary.length,0);ze(rs,os,Z);let Bt={};for(let f of p){let b=jt(f.path).toLowerCase()||"(\u0431\u0435\u0437 \u0440\u0430\u0441\u0448.)";Bt[b]=(Bt[b]||0)+1}Ue({byExt:Bt,skipInfo:d,total:a.length+c,compressed:p.length,skippedByExt:i.skippedByExt});let j=new Map;for(let f of p)re.has(f.path)&&j.set(f.path,f.hash);let is=n.intervalMin*60*1e3,ct=!1,W=0,oe=5,as=async()=>{if(ct)return;ct=!0;let f=Date.now();try{if(!await e.healthCheck()){W++;let L=Math.min(30,Math.pow(2,W));H(`\u0421\u0435\u0440\u0432\u0435\u0440 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D (\u043F\u043E\u043F\u044B\u0442\u043A\u0430 ${W}/${oe}), \u0441\u043B\u0435\u0434\u0443\u044E\u0449\u0430\u044F \u0447\u0435\u0440\u0435\u0437 ${L}\u0441`),W>=oe&&k("\u0421\u0435\u0440\u0432\u0435\u0440 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D \u0434\u043B\u0438\u0442\u0435\u043B\u044C\u043D\u043E\u0435 \u0432\u0440\u0435\u043C\u044F. \u0412\u043E\u0442\u0447\u0435\u0440 \u043F\u0440\u043E\u0434\u043E\u043B\u0436\u0430\u0435\u0442 \u0440\u0430\u0431\u043E\u0442\u0430\u0442\u044C \u0432 offline-\u0440\u0435\u0436\u0438\u043C\u0435."),ct=!1;return}W>0&&(V(`\u0421\u043E\u0435\u0434\u0438\u043D\u0435\u043D\u0438\u0435 \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u043E \u043F\u043E\u0441\u043B\u0435 ${W} \u043D\u0435\u0443\u0434\u0430\u0447\u043D\u044B\u0445 \u043F\u043E\u043F\u044B\u0442\u043E\u043A`),W=0);let{files:S}=qe(n.path,n.ignore,n.exts),P=new Set,E=[],Q=0,Y=0;for(let L of S){let ht=(()=>{try{return se(L,"utf-8")}catch{return null}})();if(!ht)continue;let K=At(n.path,L).replace(/\\/g,"/");P.add(K);let tt=ts("md5").update(ht).digest("hex"),ce=j.get(K);if(ce===tt)continue;let le=te(L,n.path,l);le&&(E.push(le),ce===void 0?Q++:Y++)}let q=[];for(let[L]of j)P.has(L)||q.push(L);for(let L of q)j.delete(L);let lt=0;if(E.length>0){let L=Qe(E);for(let ht of L){let K=await e.pushBatchAdaptive(ht.files);lt+=K.uploaded.length;for(let tt of K.uploaded)j.set(tt.path,tt.hash);for(let tt of K.failed)j.delete(tt.path);K.failed.length>0&&k(`  Rescan: ${K.failed.length} \u0444\u0430\u0439\u043B\u043E\u0432 \u043D\u0435 \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u043E`),await Ve(150)}}He({changed:Y,added:Q,removed:q.length,unchanged:P.size-E.length,uploaded:lt,elapsedMs:Date.now()-f,nextInMin:n.intervalMin})}catch(b){W++,k(`Rescan \u043E\u0448\u0438\u0431\u043A\u0430 (${W}): ${String(b)}`)}finally{ct=!1}},ie=setInterval(()=>void as(),is);V(`Periodic rescan \u043A\u0430\u0436\u0434\u044B\u0435 ${n.intervalMin} \u043C\u0438\u043D (${j.size} \u0444\u0430\u0439\u043B\u043E\u0432 \u043E\u0442\u0441\u043B\u0435\u0436\u0438\u0432\u0430\u044E\u0442\u0441\u044F)`);let ae=setInterval(()=>{e.sendHeartbeat(j.size)},6e4);if(n.watch){Ye(n.path);let f=Te.watch(n.path,{ignored:S=>S.split(/[/\\]/).some(E=>n.ignore.includes(E)||E.startsWith(".")),ignoreInitial:!0,persistent:!0}),b=async(S,P)=>{if(!n.exts.includes(jt(S)))return;let E=te(S,n.path,l);if(!E)return;j.set(E.path,E.hash);let Q=`${T(E.sizeBytes)} \u2192 ${T(E.l1Summary.length)} \u0441\u0443\u043C\u043C\u0430\u0440\u0438`;try{await e.pushBatch([E]),kt(P,E.path,Q)}catch(Y){kt("error",E.path,String(Y))}};f.on("change",S=>void b(S,"modified")),f.on("add",S=>void b(S,"added")),f.on("unlink",S=>{let P=At(n.path,S).replace(/\\/g,"/");j.delete(P),kt("deleted",P,"\u0443\u0434\u0430\u043B\u0451\u043D \u0438\u0437 \u0438\u043D\u0434\u0435\u043A\u0441\u0430")}),process.on("SIGINT",async()=>{console.log(""),H("\u041E\u0441\u0442\u0430\u043D\u043E\u0432\u043A\u0430 \u0432\u043E\u0442\u0447\u0435\u0440\u0430..."),clearInterval(ie),clearInterval(ae),await f.close(),process.exit(0)})}else je("\u0421\u043E\u0432\u0435\u0442: \u0434\u043E\u0431\u0430\u0432\u044C --watch \u0434\u043B\u044F \u043C\u0433\u043D\u043E\u0432\u0435\u043D\u043D\u043E\u0439 \u0440\u0435\u0430\u043A\u0446\u0438\u0438 \u043D\u0430 \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u044F \u0444\u0430\u0439\u043B\u043E\u0432"),G("\u041F\u0440\u043E\u0446\u0435\u0441\u0441 \u043E\u0441\u0442\u0430\u0451\u0442\u0441\u044F \u0437\u0430\u043F\u0443\u0449\u0435\u043D\u043D\u044B\u043C \u0434\u043B\u044F periodic rescan. Ctrl+C \u0434\u043B\u044F \u043E\u0441\u0442\u0430\u043D\u043E\u0432\u043A\u0438."),process.on("SIGINT",()=>{console.log(""),H("\u041E\u0441\u0442\u0430\u043D\u043E\u0432\u043A\u0430..."),clearInterval(ie),clearInterval(ae),process.exit(0)})}In().catch(n=>{k(`\u041A\u0440\u0438\u0442\u0438\u0447\u0435\u0441\u043A\u0430\u044F \u043E\u0448\u0438\u0431\u043A\u0430: ${String(n)}`),process.exit(1)});
/*! Bundled license information:

chokidar/esm/index.js:
  (*! chokidar - MIT License (c) 2012 Paul Miller (paulmillr.com) *)
*/
